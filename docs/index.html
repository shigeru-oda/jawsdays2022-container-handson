
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="docs"
                  title="[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="はじめに" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="事前準備とVPC作成" duration="5">
        <h2 is-upgraded>■CloudShellの起動</h2>
<h3 is-upgraded>AWS コンソールにログイン</h3>
<p class="image-container"><img alt="img" src="img/8ec695a05f461637.png"></p>
<h3 is-upgraded>CloudShellボタン押下</h3>
<p>画面右上のCloudShellボタンを押下<br><img alt="img" src="img/1bbb070a4cf9999c.png"></p>
<h3 is-upgraded>CloudShellを起動</h3>
<p>今後は以下の画面にコマンド（以下 cmd）と結果（以下 result）を確認し、進める。 <img alt="img" src="img/9b0f4ff0313865b9.png"></p>
<h2 is-upgraded>■AWS Account IDの取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID=`aws sts get-caller-identity --query Account --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
</code></pre>
<h2 is-upgraded>■ECSの実行Roleの存在確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam list-roles | grep &#34;RoleName&#34; | grep &#34;ecsTaskExecutionRole&#34;
</code></pre>
<h3 is-upgraded>result（存在する場合）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">            &#34;RoleName&#34;: &#34;ecsTaskExecutionRole&#34;,
</code></pre>
<h3 is-upgraded>result（存在しない場合）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■ECSの実行Role作成（上記で存在しない場合実行）</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;ecs-tasks.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ecsTaskExecutionRole \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ecsTaskExecutionRole&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFOV2DAKSWN&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::152767562250:role/ecsTaskExecutionRole&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-06T14:50:16+00:00&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;ecs-tasks.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam attach-role-policy \
  --role-name ecsTaskExecutionRole \
  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
</code></pre>
<h2 is-upgraded>■VPCの作成</h2>
<p>VPCを新規に作成します。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-vpc \
    --cidr-block 10.0.0.0/16 \
    --tag-specification &#34;ResourceType=vpc,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Vpc&#34;: {
        &#34;CidrBlock&#34;: &#34;10.0.0.0/16&#34;,
        &#34;DhcpOptionsId&#34;: &#34;dopt-c3de3ba5&#34;,
        &#34;State&#34;: &#34;pending&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;InstanceTenancy&#34;: &#34;default&#34;,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;CidrBlockAssociationSet&#34;: [
            {
                &#34;AssociationId&#34;: &#34;vpc-cidr-assoc-098ed848444db197b&#34;,
                &#34;CidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;CidrBlockState&#34;: {
                    &#34;State&#34;: &#34;associated&#34;
                }
            }
        ],
        &#34;IsDefault&#34;: false,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ]
    }
}
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId=`aws ec2 describe-vpcs \
    --query &#39;Vpcs[*].VpcId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
</code></pre>
<h3 is-upgraded>■DNS名前解決をONにする</h3>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell"> aws ec2 modify-vpc-attribute \
  --vpc-id ${VpcId}  \
  --enable-dns-support  &#39;{&#34;Value&#34;:true}&#39; 
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>■DNS名前解決の状態確認</h3>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-vpc-attribute \
  --query EnableDnsSupport \
  --vpc-id ${VpcId}  \
  --attribute enableDnsSupport
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Value&#34;: true
}
</code></pre>
<h3 is-upgraded>■DNSホスト名をONにする</h3>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell"> aws ec2 modify-vpc-attribute \
  --vpc-id ${VpcId}  \
  --enable-dns-hostnames  &#39;{&#34;Value&#34;:true}&#39; 
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>■DNSホスト名の状態確認</h3>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-vpc-attribute \
  --query EnableDnsHostnames \
  --vpc-id ${VpcId}  \
  --attribute enableDnsHostnames
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Value&#34;: true
}
</code></pre>
<h2 is-upgraded>■Subnetの作成</h2>
<p>作成したVPCの中にSubnetを4つ作成します。 Private Subnetが2つ、Public Subnetが2つです。</p>
<h3 is-upgraded>cmd1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.0.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1a&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az4&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.0.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0f66f257f167a1d47&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:152767562250:subnet/subnet-0f66f257f167a1d47&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.1.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1c&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az1&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.1.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0a1e2afffc8c140d8&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:152767562250:subnet/subnet-0a1e2afffc8c140d8&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd3</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.2.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result3</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1a&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az4&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.2.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-049f0119237ff00a0&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:152767562250:subnet/subnet-049f0119237ff00a0&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd4</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.3.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result4</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1c&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az1&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.3.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0ea89b6bc85e0ec61&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:152767562250:subnet/subnet-0ea89b6bc85e0ec61&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>変数取得</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
</code></pre>
<h2 is-upgraded>■InternetGatewayの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-internet-gateway \
    --tag-specifications &#34;ResourceType=internet-gateway,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;InternetGateway&#34;: {
        &#34;Attachments&#34;: [],
        &#34;InternetGatewayId&#34;: &#34;igw-0a511ba68ceb84ed8&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ]
    }
}
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">InternetGatewayId=`aws ec2 describe-internet-gateways \
    --query &#39;InternetGateways[*].InternetGatewayId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCにAttach</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 attach-internet-gateway \
    --internet-gateway-id ${InternetGatewayId} \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（何もなし）
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCにAttachされていることを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-internet-gateways \
    --internet-gateway-ids ${InternetGatewayId} \
    --query &#39;InternetGateways[*].Attachments[*].State&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">available
</code></pre>
<h2 is-upgraded>■RouteTableの作成</h2>
<h3 is-upgraded>cmd1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;RouteTable&#34;: {
        &#34;Associations&#34;: [],
        &#34;PropagatingVgws&#34;: [],
        &#34;RouteTableId&#34;: &#34;rtb-00cf30796b25b9bc9&#34;,
        &#34;Routes&#34;: [
            {
                &#34;DestinationCidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;GatewayId&#34;: &#34;local&#34;,
                &#34;Origin&#34;: &#34;CreateRouteTable&#34;,
                &#34;State&#34;: &#34;active&#34;
            }
        ],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;RouteTable&#34;: {
        &#34;Associations&#34;: [],
        &#34;PropagatingVgws&#34;: [],
        &#34;RouteTableId&#34;: &#34;rtb-0afaac377925bca9a&#34;,
        &#34;Routes&#34;: [
            {
                &#34;DestinationCidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;GatewayId&#34;: &#34;local&#34;,
                &#34;Origin&#34;: &#34;CreateRouteTable&#34;,
                &#34;State&#34;: &#34;active&#34;
            }
        ],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;
    }
}
</code></pre>
<h2 is-upgraded>■RouteTableの確認</h2>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPublic=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPrivate=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
</code></pre>
<h2 is-upgraded>■RouteTableにSubnetを紐付け</h2>
<h3 is-upgraded>cmd1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1aPublic}
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-0e98cb5f6c54d5d83&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1cPublic}
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-0f3ca785ae8675b6f&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd3</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1aPrivate}
</code></pre>
<h3 is-upgraded>result3</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-07f8b8f8aa65d0df8&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd4</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1cPrivate}
</code></pre>
<h3 is-upgraded>result4</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-008c971373c02cf69&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h2 is-upgraded>■RouteTableにInternetGatewayを紐付け</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route \
  --route-table-id ${RouteTableIdPublic} \
  --destination-cidr-block &#34;0.0.0.0/0&#34; \
  --gateway-id ${InternetGatewayId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true
}
</code></pre>
<h2 is-upgraded>■PublicSubnet用のSecurityGroup作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-security-group \
  --group-name PublicSecurityGroup \
  --description &#34;Public Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-PublicSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;,
    &#34;Tags&#34;: [
        {
            &#34;Key&#34;: &#34;Name&#34;,
            &#34;Value&#34;: &#34;ContainerHandsOn-PublicSecurityGroup&#34;
        }
    ]
}
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code>PublicSecurityGroupsId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-PublicSecurityGroup&#34; \
    --output text`
</code></pre>
<h2 is-upgraded>■PrivateSubnet用のSecurityGroup作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-security-group \
  --group-name PrivateSecurityGroup \
  --description &#34;Private Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-PrivateSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
    &#34;Tags&#34;: [
        {
            &#34;Key&#34;: &#34;Name&#34;,
            &#34;Value&#34;: &#34;ContainerHandsOn-PrivateSecurityGroup&#34;
        }
    ]
}
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">PrivateSecurityGroupsId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-PrivateSecurityGroup&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
PublicSecurityGroupsId : sg-01cc901415c240504
PrivateSecurityGroupsId : sg-040aff209e1fe59cc
</code></pre>
<h2 is-upgraded>■PublicSubnetのInboundを追加</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PublicSecurityGroupsId} \
    --protocol tcp \
    --port 80 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-011c9bf434c9439a0&#34;,
            &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;,
            &#34;GroupOwnerId&#34;: &#34;152767562250&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 80,
            &#34;ToPort&#34;: 80,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PrivateSubnetのInboundを追加</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PrivateSecurityGroupsId} \
    --protocol tcp \
    --port 80 \
    --source-group ${PublicSecurityGroupsId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0eca9b6518889b4ca&#34;,
            &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
            &#34;GroupOwnerId&#34;: &#34;152767562250&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 80,
            &#34;ToPort&#34;: 80,
            &#34;ReferencedGroupInfo&#34;: {
                &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;
            }
        }
    ]
}
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PrivateSecurityGroupsId} \
    --protocol tcp \
    --port 443 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0d637ce636f2f14d9&#34;,
            &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
            &#34;GroupOwnerId&#34;: &#34;152767562250&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 443,
            &#34;ToPort&#34;: 443,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■環境変数をメモ</h2>
<p>Cloud9で使うため、取得した変数をエディターに残して下さい。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
export AccoutID=&#34;${AccoutID}&#34;
export VpcId=&#34;${VpcId}&#34;
export SubnetId1aPublic=&#34;${SubnetId1aPublic}&#34;
export SubnetId1cPublic=&#34;${SubnetId1cPublic}&#34;
export SubnetId1aPrivate=&#34;${SubnetId1aPrivate}&#34;
export SubnetId1cPrivate=&#34;${SubnetId1cPrivate}&#34;
export InternetGatewayId=&#34;${InternetGatewayId}&#34;
export RouteTableIdPublic=&#34;${RouteTableIdPublic}&#34;
export RouteTableIdPrivate=&#34;${RouteTableIdPrivate}&#34;
export PublicSecurityGroupsId=&#34;${PublicSecurityGroupsId}&#34;
export PrivateSecurityGroupsId=&#34;${PrivateSecurityGroupsId}&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">export AccoutID=&#34;152767562250&#34;
export VpcId=&#34;vpc-0d3c1c88db46cfba7&#34;
export SubnetId1aPublic=&#34;subnet-0f66f257f167a1d47&#34;
export SubnetId1cPublic=&#34;subnet-0a1e2afffc8c140d8&#34;
export SubnetId1aPrivate=&#34;subnet-049f0119237ff00a0&#34;
export SubnetId1cPrivate=&#34;subnet-0ea89b6bc85e0ec61&#34;
export InternetGatewayId=&#34;igw-0a511ba68ceb84ed8&#34;
export RouteTableIdPublic=&#34;rtb-00cf30796b25b9bc9&#34;
export RouteTableIdPrivate=&#34;rtb-0afaac377925bca9a&#34;
export PublicSecurityGroupsId=&#34;sg-01cc901415c240504&#34;
export PrivateSecurityGroupsId=&#34;sg-040aff209e1fe59cc&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Cloud9作成" duration="5">
        <h2 is-upgraded>■Cloud9の作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws cloud9 create-environment-ec2 \
  --name ContainerHandsOn \
  --description &#34;ContainerHandsOn&#34; \
  --instance-type t3.small  \
  --subnet-id ${SubnetId1aPublic}  \
  --automatic-stop-time-minutes 60 
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;environmentId&#34;: &#34;aa2999a731eb4178aed99069f1b683aa&#34;
}
</code></pre>
<h2 is-upgraded>■AWS コンソールでCloud9を起動</h2>
<ul>
<li>上部の検索バーで<code>Cloud9</code>と検索</li>
<li><code>AWS Cloud9 &gt; Your environments</code>に<code>ContainerHandsOn</code>が作成されているので<code>Open IDE</code>ボタン押下</li>
<li>Cloud9の画面が表示される。</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="ECR作成" duration="5">
        <h2 is-upgraded>■環境変数を貼り付け</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export AccoutID=&#34;152767562250&#34;
export VpcId=&#34;vpc-0d3c1c88db46cfba7&#34;
export SubnetId1aPublic=&#34;subnet-0f66f257f167a1d47&#34;
export SubnetId1cPublic=&#34;subnet-0a1e2afffc8c140d8&#34;
export SubnetId1aPrivate=&#34;subnet-049f0119237ff00a0&#34;
export SubnetId1cPrivate=&#34;subnet-0ea89b6bc85e0ec61&#34;
export InternetGatewayId=&#34;igw-0a511ba68ceb84ed8&#34;
export RouteTableIdPublic=&#34;rtb-00cf30796b25b9bc9&#34;
export RouteTableIdPrivate=&#34;rtb-0afaac377925bca9a&#34;
export PublicSecurityGroupsId=&#34;sg-01cc901415c240504&#34;
export PrivateSecurityGroupsId=&#34;sg-040aff209e1fe59cc&#34;
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
PublicSecurityGroupsId : sg-01cc901415c240504
PrivateSecurityGroupsId : sg-040aff209e1fe59cc
</code></pre>
<h2 is-upgraded>■ECRの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr create-repository \
    --repository-name jaws-days-2022/container-hands-on \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;repository&#34;: {
        &#34;repositoryArn&#34;: &#34;arn:aws:ecr:ap-northeast-1:152767562250:repository/jaws-days-2022/container-hands-on&#34;,
        &#34;registryId&#34;: &#34;152767562250&#34;,
        &#34;repositoryName&#34;: &#34;jaws-days-2022/container-hands-on&#34;,
        &#34;repositoryUri&#34;: &#34;152767562250.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on&#34;,
        &#34;createdAt&#34;: &#34;2022-09-06T13:21:42+00:00&#34;,
        &#34;imageTagMutability&#34;: &#34;MUTABLE&#34;,
        &#34;imageScanningConfiguration&#34;: {
            &#34;scanOnPush&#34;: false
        },
        &#34;encryptionConfiguration&#34;: {
            &#34;encryptionType&#34;: &#34;AES256&#34;
        }
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Docker Image作成" duration="5">
        <h2 is-upgraded>■Cloud9上にdockerセットアップされていることを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker -v
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Docker version 20.10.13, build a224086
</code></pre>
<h2 is-upgraded>■Cloud9上にDockerfileを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; Dockerfile
FROM php:7.4.0-apache
COPY src/ /var/www/html/
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">mkdir src
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; ./src/index.php
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;ja&#34;&gt;
  &lt;head&gt;
    &lt;title&gt;Hello! Jaws Days 2022!!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Hello! Jaws Days 2022!!&lt;/p&gt;
    &lt;?php echo gethostname(); ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">ls -l ./Dockerfile  ./src/index.php
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">-rw-rw-r-- 1 ec2-user ec2-user  47 Sep  6 13:26 ./Dockerfile
-rw-rw-r-- 1 ec2-user ec2-user 190 Sep  6 13:26 ./src/index.php
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker build -t jaws-days-2022/container-hands-on .
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（略）
Successfully built fed9645afaae
Successfully tagged jaws-days-2022/container-hands-on:latest
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築されたことを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-cloud9" class="language-cloud9">docker images --filter reference= jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-cloud9" class="language-cloud9">REPOSITORY                          TAG       IMAGE ID       CREATED          SIZE
jaws-days-2022/container-hands-on   latest    98c14fa37bab   10 seconds ago   414MB
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを起動</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker run --name container-hands-on -d -p 8080:80 jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">dcaf3423f6abeea3a67bab0c01a33e7b9d2c97131c8b304900f0455ee73da7b7
</code></pre>
<h3 is-upgraded>画面</h3>
<ul>
<li>Cloud9のヘッダ部分の<code>Preview</code>-&gt; <code>Preview Runnnig Application</code>のボタン押下<br></li>
<li><code>Hello! Jaws Days 2022!!</code>と記載された画面が表示されること<br></li>
</ul>
<p class="image-container"><img alt="img" src="img/2be66bb659acb02.png"></p>
<aside class="special"><p>何か間違ってコンテナを止めたい場合には以下を実行ください <br><code>docker stop $(docker ps -q)<br>docker rm $(docker ps -q -a)<br></code></p>
</aside>
<h2 is-upgraded>■DockerImageにTag付けを行う</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker tag jaws-days-2022/container-hands-on:latest `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■DockerImageにTag付けの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker images --filter reference=`echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest

</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">REPOSITORY                                                                            TAG       IMAGE ID       CREATED          SIZE
152767562250.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on   latest    98c14fa37bab   10 minutes ago   414MB
</code></pre>
<h2 is-upgraded>■認証トークンを取得し、レジストリに対して Docker クライアントを認証します</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">WARNING! Your password will be stored unencrypted in /home/ec2-user/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
</code></pre>
<h2 is-upgraded>■DockerImageをECRにPush</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker push `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">The push refers to repository [152767562250.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on]
9f8ad0ecf420: Pushed 
536365481ed8: Pushed 
4b3693c51878: Pushed 
677c3ce9f0b4: Pushed 
c08f4d9c281b: Pushed 
ed13170590f7: Pushed 
37cbdda31557: Pushed 
9691e5d7a4c7: Pushed 
6a4d393f0795: Pushed 
e38834ac7561: Pushed 
ec64f555d498: Pushed 
840f3f414cf6: Pushed 
17fce12edef0: Pushed 
831c5620387f: Pushed 
latest: digest: sha256:1fb5a3ac5ea1e7d60c24f371564a8c2c7bbc8072be0e80a3c53c30e1cae3ffd3 size: 3242
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="VPCエンドポイント作成" duration="5">
        <p>FargateをPrivateSubnetで稼働させるため、以下VPCエンドポイントを準備します。</p>
<ul>
<li>com.amazonaws.ap-northeast-1.s3</li>
<li>com.amazonaws.ap-northeast-1.ecr.dkr</li>
<li>com.amazonaws.ap-northeast-1.ecr.api</li>
<li>com.amazonaws.ap-northeast-1.logs</li>
</ul>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.s3</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Gateway \
    --service-name com.amazonaws.ap-northeast-1.s3 \
    --route-table-ids ${RouteTableIdPrivate} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;PolicyDocument&#34;: &#34;{\&#34;Version\&#34;:\&#34;2008-10-17\&#34;,\&#34;Statement\&#34;:[{\&#34;Effect\&#34;:\&#34;Allow\&#34;,\&#34;Principal\&#34;:\&#34;*\&#34;,\&#34;Action\&#34;:\&#34;*\&#34;,\&#34;Resource\&#34;:\&#34;*\&#34;}]}&#34;, 
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
        &#34;Tags&#34;: [
            {
                &#34;Value&#34;: &#34;ContainerHands&#34;, 
                &#34;Key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;NetworkInterfaceIds&#34;: [], 
        &#34;SubnetIds&#34;: [], 
        &#34;RequesterManaged&#34;: false, 
        &#34;PrivateDnsEnabled&#34;: false, 
        &#34;State&#34;: &#34;available&#34;, 
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.s3&#34;, 
        &#34;RouteTableIds&#34;: [
            &#34;rtb-0afaac377925bca9a&#34;
        ], 
        &#34;Groups&#34;: [], 
        &#34;OwnerId&#34;: &#34;152767562250&#34;, 
        &#34;VpcEndpointId&#34;: &#34;vpce-035934e1a19b46f78&#34;, 
        &#34;VpcEndpointType&#34;: &#34;Gateway&#34;, 
        &#34;CreationTimestamp&#34;: &#34;2022-09-06T14:14:54.000Z&#34;, 
        &#34;DnsEntries&#34;: []
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.dkr</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.dkr \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
        &#34;Tags&#34;: [
            {
                &#34;Value&#34;: &#34;ContainerHands&#34;, 
                &#34;Key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-09e0a49241653c549&#34;, 
            &#34;eni-05e27340a7008c6c5&#34;
        ], 
        &#34;SubnetIds&#34;: [
            &#34;subnet-0ea89b6bc85e0ec61&#34;, 
            &#34;subnet-049f0119237ff00a0&#34;
        ], 
        &#34;RequesterManaged&#34;: false, 
        &#34;PrivateDnsEnabled&#34;: true, 
        &#34;State&#34;: &#34;pending&#34;, 
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.ecr.dkr&#34;, 
        &#34;RouteTableIds&#34;: [], 
        &#34;Groups&#34;: [
            {
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;, 
                &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;
            }
        ], 
        &#34;OwnerId&#34;: &#34;152767562250&#34;, 
        &#34;VpcEndpointId&#34;: &#34;vpce-0dceb08e8bffc9a0c&#34;, 
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;, 
        &#34;CreationTimestamp&#34;: &#34;2022-09-06T14:15:53.158Z&#34;, 
        &#34;DnsEntries&#34;: [
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0dceb08e8bffc9a0c-nuehayud.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0dceb08e8bffc9a0c-nuehayud-ap-northeast-1a.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0dceb08e8bffc9a0c-nuehayud-ap-northeast-1c.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;, 
                &#34;DnsName&#34;: &#34;dkr.ecr.ap-northeast-1.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;, 
                &#34;DnsName&#34;: &#34;*.dkr.ecr.ap-northeast-1.amazonaws.com&#34;
            }
        ]
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.api</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.api \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
        &#34;Tags&#34;: [
            {
                &#34;Value&#34;: &#34;ContainerHands&#34;, 
                &#34;Key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-084e01fac365b44eb&#34;, 
            &#34;eni-0f8846781b4fb82ee&#34;
        ], 
        &#34;SubnetIds&#34;: [
            &#34;subnet-0ea89b6bc85e0ec61&#34;, 
            &#34;subnet-049f0119237ff00a0&#34;
        ], 
        &#34;RequesterManaged&#34;: false, 
        &#34;PrivateDnsEnabled&#34;: true, 
        &#34;State&#34;: &#34;pending&#34;, 
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.ecr.api&#34;, 
        &#34;RouteTableIds&#34;: [], 
        &#34;Groups&#34;: [
            {
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;, 
                &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;
            }
        ], 
        &#34;OwnerId&#34;: &#34;152767562250&#34;, 
        &#34;VpcEndpointId&#34;: &#34;vpce-0e45e7f04848a0600&#34;, 
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;, 
        &#34;CreationTimestamp&#34;: &#34;2022-09-06T14:16:25.698Z&#34;, 
        &#34;DnsEntries&#34;: [
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0e45e7f04848a0600-kef4k347.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0e45e7f04848a0600-kef4k347-ap-northeast-1c.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0e45e7f04848a0600-kef4k347-ap-northeast-1a.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;, 
                &#34;DnsName&#34;: &#34;api.ecr.ap-northeast-1.amazonaws.com&#34;
            }
        ]
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.logs</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.logs \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
        &#34;Tags&#34;: [
            {
                &#34;Value&#34;: &#34;ContainerHands&#34;, 
                &#34;Key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-04b15926212e8ea31&#34;, 
            &#34;eni-0514bbba136ec6108&#34;
        ], 
        &#34;SubnetIds&#34;: [
            &#34;subnet-0ea89b6bc85e0ec61&#34;, 
            &#34;subnet-049f0119237ff00a0&#34;
        ], 
        &#34;RequesterManaged&#34;: false, 
        &#34;PrivateDnsEnabled&#34;: true, 
        &#34;State&#34;: &#34;pending&#34;, 
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.logs&#34;, 
        &#34;RouteTableIds&#34;: [], 
        &#34;Groups&#34;: [
            {
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;, 
                &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;
            }
        ], 
        &#34;OwnerId&#34;: &#34;152767562250&#34;, 
        &#34;VpcEndpointId&#34;: &#34;vpce-05ae88af55de2bf71&#34;, 
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;, 
        &#34;CreationTimestamp&#34;: &#34;2022-09-06T14:16:50.374Z&#34;, 
        &#34;DnsEntries&#34;: [
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-05ae88af55de2bf71-5ltns582.logs.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-05ae88af55de2bf71-5ltns582-ap-northeast-1c.logs.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-05ae88af55de2bf71-5ltns582-ap-northeast-1a.logs.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;, 
                &#34;DnsName&#34;: &#34;logs.ap-northeast-1.amazonaws.com&#34;
            }
        ]
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ALB作成" duration="5">
        <h2 is-upgraded>■アプリケーションロードバランサーの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-load-balancer \
    --name ContainerHandsOn \
    --subnets ${SubnetId1aPublic} ${SubnetId1cPublic} \
    --security-groups ${PublicSecurityGroupsId} \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;LoadBalancers&#34;: [
        {
            &#34;IpAddressType&#34;: &#34;ipv4&#34;, 
            &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
            &#34;LoadBalancerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:loadbalancer/app/ContainerHandsOn/75145ed42d9a3867&#34;, 
            &#34;State&#34;: {
                &#34;Code&#34;: &#34;provisioning&#34;
            }, 
            &#34;DNSName&#34;: &#34;ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com&#34;, 
            &#34;SecurityGroups&#34;: [
                &#34;sg-08822a4834ed05f46&#34;
            ], 
            &#34;LoadBalancerName&#34;: &#34;ContainerHandsOn&#34;, 
            &#34;CreatedTime&#34;: &#34;2022-09-06T14:21:35.730Z&#34;, 
            &#34;Scheme&#34;: &#34;internet-facing&#34;, 
            &#34;Type&#34;: &#34;application&#34;, 
            &#34;CanonicalHostedZoneId&#34;: &#34;Z14GRHDCWA56QT&#34;, 
            &#34;AvailabilityZones&#34;: [
                {
                    &#34;SubnetId&#34;: &#34;subnet-0a1e2afffc8c140d8&#34;, 
                    &#34;LoadBalancerAddresses&#34;: [], 
                    &#34;ZoneName&#34;: &#34;ap-northeast-1c&#34;
                }, 
                {
                    &#34;SubnetId&#34;: &#34;subnet-0f66f257f167a1d47&#34;, 
                    &#34;LoadBalancerAddresses&#34;: [], 
                    &#34;ZoneName&#34;: &#34;ap-northeast-1a&#34;
                }
            ]
        }
    ]
}
</code></pre>
<h2 is-upgraded>■ターゲットグループの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-target-group \
    --name ContainerHandsOn \
    --protocol HTTP \
    --port 80 \
    --target-type ip \
    --health-check-protocol HTTP \
    --health-check-port traffic-port \
    --health-check-path /index.php \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;TargetGroups&#34;: [
        {
            &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:targetgroup/ContainerHandsOn/7624dfd8f556a2d9&#34;,
            &#34;TargetGroupName&#34;: &#34;ContainerHandsOn&#34;,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;Port&#34;: 80,
            &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
            &#34;HealthCheckProtocol&#34;: &#34;HTTP&#34;,
            &#34;HealthCheckPort&#34;: &#34;traffic-port&#34;,
            &#34;HealthCheckEnabled&#34;: true,
            &#34;HealthCheckIntervalSeconds&#34;: 30,
            &#34;HealthCheckTimeoutSeconds&#34;: 5,
            &#34;HealthyThresholdCount&#34;: 5,
            &#34;UnhealthyThresholdCount&#34;: 2,
            &#34;HealthCheckPath&#34;: &#34;/index.php&#34;,
            &#34;Matcher&#34;: {
                &#34;HttpCode&#34;: &#34;200&#34;
            },
            &#34;TargetType&#34;: &#34;ip&#34;,
            &#34;ProtocolVersion&#34;: &#34;HTTP1&#34;,
            &#34;IpAddressType&#34;: &#34;ipv4&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■アプリケーションロードバランサーのDNS取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">LoadBalancersDnsName=`aws elbv2 describe-load-balancers \
  --names ContainerHandsOn \
  --query &#34;LoadBalancers[*].DNSName&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">echo ${LoadBalancersDnsName}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h2 is-upgraded>■アプリケーションロードバランサーのARN取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">LoadBalancerArn=`aws elbv2 describe-load-balancers \
  --names ContainerHandsOn \
  --query &#34;LoadBalancers[*].LoadBalancerArn&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">echo ${LoadBalancerArn}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:loadbalancer/app/ContainerHandsOn/75145ed42d9a3867
</code></pre>
<h2 is-upgraded>■ターゲットグループのARN取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">TargetGroupArn=`aws elbv2 describe-target-groups \
  --names ContainerHandsOn \
  --query &#34;TargetGroups[*].TargetGroupArn&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">echo ${TargetGroupArn}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:targetgroup/ContainerHandsOn/7f11fa9e9d635ce9
</code></pre>
<h2 is-upgraded>■リスナーの追加</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-listener \
    --load-balancer-arn ${LoadBalancerArn} \
    --protocol HTTP \
    --port 80 \
    --default-actions Type=forward,TargetGroupArn=${TargetGroupArn}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Listeners&#34;: [
        {
            &#34;ListenerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:listener/app/ContainerHandsOn/75145ed42d9a3867/1245c4be3b3230b7&#34;,
            &#34;LoadBalancerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:loadbalancer/app/ContainerHandsOn/75145ed42d9a3867&#34;,
            &#34;Port&#34;: 80,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;DefaultActions&#34;: [
                {
                    &#34;Type&#34;: &#34;forward&#34;,
                    &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:targetgroup/ContainerHandsOn/7f11fa9e9d635ce9&#34;,
                    &#34;ForwardConfig&#34;: {
                        &#34;TargetGroups&#34;: [
                            {
                                &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:targetgroup/ContainerHandsOn/7f11fa9e9d635ce9&#34;,
                                &#34;Weight&#34;: 1
                            }
                        ],
                        &#34;TargetGroupStickinessConfig&#34;: {
                            &#34;Enabled&#34;: false
                        }
                    }
                }
            ]
        }
    ]
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Fargate作成" duration="5">
        <h2 is-upgraded>■クラスターの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs create-cluster \
    --cluster-name ContainerHandsOn \
    --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;cluster&#34;: {
        &#34;status&#34;: &#34;ACTIVE&#34;, 
        &#34;defaultCapacityProviderStrategy&#34;: [], 
        &#34;statistics&#34;: [], 
        &#34;capacityProviders&#34;: [], 
        &#34;tags&#34;: [
            {
                &#34;value&#34;: &#34;ContainerHandsOn&#34;, 
                &#34;key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;clusterName&#34;: &#34;ContainerHandsOn&#34;, 
        &#34;settings&#34;: [
            {
                &#34;name&#34;: &#34;containerInsights&#34;, 
                &#34;value&#34;: &#34;disabled&#34;
            }
        ], 
        &#34;registeredContainerInstancesCount&#34;: 0, 
        &#34;pendingTasksCount&#34;: 0, 
        &#34;runningTasksCount&#34;: 0, 
        &#34;activeServicesCount&#34;: 0, 
        &#34;clusterArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:152767562250:cluster/ContainerHandsOn&#34;
    }
}
</code></pre>
<h2 is-upgraded>■タスク定義の作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; register-task-definition.json
{
    &#34;family&#34;: &#34;ContainerHandsOn&#34;, 
    &#34;executionRoleArn&#34;: &#34;arn:aws:iam::${AccoutID}:role/ecsTaskExecutionRole&#34;, 
    &#34;networkMode&#34;: &#34;awsvpc&#34;, 
    &#34;containerDefinitions&#34;: [
        {
            &#34;name&#34;: &#34;ContainerHandsOn&#34;, 
            &#34;image&#34;: &#34;${AccoutID}.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;, 
            &#34;portMappings&#34;: [
                {
                    &#34;containerPort&#34;: 80, 
                    &#34;hostPort&#34;: 80, 
                    &#34;protocol&#34;: &#34;tcp&#34;
                }
            ], 
            &#34;essential&#34;: true
        }
    ], 
    &#34;requiresCompatibilities&#34;: [
        &#34;FARGATE&#34;
    ], 
    &#34;cpu&#34;: &#34;256&#34;, 
    &#34;memory&#34;: &#34;512&#34;,
    &#34;runtimePlatform&#34;: {
        &#34;cpuArchitecture&#34;: &#34;X86_64&#34;,
        &#34;operatingSystemFamily&#34;: &#34;LINUX&#34;
    }
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs register-task-definition \
  --cli-input-json file://register-task-definition.json \
  --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;taskDefinition&#34;: {
        &#34;taskDefinitionArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:152767562250:task-definition/ContainerHandsOn:1&#34;,
        &#34;containerDefinitions&#34;: [
            {
                &#34;name&#34;: &#34;ContainerHandsOn&#34;,
                &#34;image&#34;: &#34;152767562250.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;,
                &#34;cpu&#34;: 0,
                &#34;portMappings&#34;: [
                    {
                        &#34;containerPort&#34;: 80,
                        &#34;hostPort&#34;: 80,
                        &#34;protocol&#34;: &#34;tcp&#34;
                    }
                ],
                &#34;essential&#34;: true,
                &#34;environment&#34;: [],
                &#34;mountPoints&#34;: [],
                &#34;volumesFrom&#34;: []
            }
        ],
        &#34;family&#34;: &#34;ContainerHandsOn&#34;,
        &#34;executionRoleArn&#34;: &#34;arn:aws:iam::152767562250:role/ecsTaskExecutionRole&#34;,
        &#34;networkMode&#34;: &#34;awsvpc&#34;,
        &#34;revision&#34;: 1,
        &#34;volumes&#34;: [],
        &#34;status&#34;: &#34;ACTIVE&#34;,
        &#34;requiresAttributes&#34;: [
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.ecr-auth&#34;
            },
            {
                &#34;name&#34;: &#34;ecs.capability.execution-role-ecr-pull&#34;
            },
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.docker-remote-api.1.18&#34;
            },
            {
                &#34;name&#34;: &#34;ecs.capability.task-eni&#34;
            }
        ],
        &#34;placementConstraints&#34;: [],
        &#34;compatibilities&#34;: [
            &#34;EC2&#34;,
            &#34;FARGATE&#34;
        ],
        &#34;runtimePlatform&#34;: {
            &#34;cpuArchitecture&#34;: &#34;X86_64&#34;,
            &#34;operatingSystemFamily&#34;: &#34;LINUX&#34;
        },
        &#34;requiresCompatibilities&#34;: [
            &#34;FARGATE&#34;
        ],
        &#34;cpu&#34;: &#34;256&#34;,
        &#34;memory&#34;: &#34;512&#34;,
        &#34;registeredAt&#34;: &#34;2022-09-06T14:59:53.594000+00:00&#34;,
        &#34;registeredBy&#34;: &#34;arn:aws:sts::152767562250:assumed-role/AWSReservedSSO_AWSAdministratorAccess_8fe206b83490a022/ShigeruOda&#34;
    },
    &#34;tags&#34;: [
        {
            &#34;key&#34;: &#34;Name&#34;,
            &#34;value&#34;: &#34;ContainerHandsOn&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■サービスの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs create-service \
    --cluster ContainerHandsOn \
    --service-name ContainerHandsOn \
    --task-definition ContainerHandsOn:1 \
    --desired-count 2 \
    --launch-type FARGATE \
    --platform-version LATEST \
    --network-configuration &#34;awsvpcConfiguration={subnets=[${SubnetId1aPrivate},${SubnetId1cPrivate}],securityGroups=[${PrivateSecurityGroupsId}],assignPublicIp=DISABLED}&#34; \
   --load-balancers targetGroupArn=${TargetGroupArn},containerName=ContainerHandsOn,containerPort=80 
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;service&#34;: {
        &#34;serviceArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:152767562250:service/ContainerHandsOn/ContainerHandsOn&#34;,
        &#34;serviceName&#34;: &#34;ContainerHandsOn&#34;,
        &#34;clusterArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:152767562250:cluster/ContainerHandsOn&#34;,
        &#34;loadBalancers&#34;: [
            {
                &#34;targetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:targetgroup/ContainerHandsOn/7624dfd8f556a2d9&#34;,
                &#34;containerName&#34;: &#34;ContainerHandsOn&#34;,
                &#34;containerPort&#34;: 80
            }
        ],
        &#34;serviceRegistries&#34;: [],
        &#34;status&#34;: &#34;ACTIVE&#34;,
        &#34;desiredCount&#34;: 2,
        &#34;runningCount&#34;: 0,
        &#34;pendingCount&#34;: 0,
        &#34;launchType&#34;: &#34;FARGATE&#34;,
        &#34;platformVersion&#34;: &#34;LATEST&#34;,
        &#34;platformFamily&#34;: &#34;Linux&#34;,
        &#34;taskDefinition&#34;: &#34;arn:aws:ecs:ap-northeast-1:152767562250:task-definition/ContainerHandsOn:1&#34;,
        &#34;deploymentConfiguration&#34;: {
            &#34;deploymentCircuitBreaker&#34;: {
                &#34;enable&#34;: false,
                &#34;rollback&#34;: false
            },
            &#34;maximumPercent&#34;: 200,
            &#34;minimumHealthyPercent&#34;: 100
        },
        &#34;deployments&#34;: [
            {
                &#34;id&#34;: &#34;ecs-svc/9015413324295259653&#34;,
                &#34;status&#34;: &#34;PRIMARY&#34;,
                &#34;taskDefinition&#34;: &#34;arn:aws:ecs:ap-northeast-1:152767562250:task-definition/ContainerHandsOn:1&#34;,
                &#34;desiredCount&#34;: 2,
                &#34;pendingCount&#34;: 0,
                &#34;runningCount&#34;: 0,
                &#34;failedTasks&#34;: 0,
                &#34;createdAt&#34;: &#34;2022-09-07T02:14:18.688000+00:00&#34;,
                &#34;updatedAt&#34;: &#34;2022-09-07T02:14:18.688000+00:00&#34;,
                &#34;launchType&#34;: &#34;FARGATE&#34;,
                &#34;platformVersion&#34;: &#34;1.4.0&#34;,
                &#34;platformFamily&#34;: &#34;Linux&#34;,
                &#34;networkConfiguration&#34;: {
                    &#34;awsvpcConfiguration&#34;: {
                        &#34;subnets&#34;: [
                            &#34;subnet-0ea89b6bc85e0ec61&#34;,
                            &#34;subnet-049f0119237ff00a0&#34;
                        ],
                        &#34;securityGroups&#34;: [
                            &#34;sg-040aff209e1fe59cc&#34;
                        ],
                        &#34;assignPublicIp&#34;: &#34;DISABLED&#34;
                    }
                },
                &#34;rolloutState&#34;: &#34;IN_PROGRESS&#34;,
                &#34;rolloutStateReason&#34;: &#34;ECS deployment ecs-svc/9015413324295259653 in progress.&#34;
            }
        ],
        &#34;roleArn&#34;: &#34;arn:aws:iam::152767562250:role/aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS&#34;,
        &#34;events&#34;: [],
        &#34;createdAt&#34;: &#34;2022-09-07T02:14:18.688000+00:00&#34;,
        &#34;placementConstraints&#34;: [],
        &#34;placementStrategy&#34;: [],
        &#34;networkConfiguration&#34;: {
            &#34;awsvpcConfiguration&#34;: {
                &#34;subnets&#34;: [
                    &#34;subnet-0ea89b6bc85e0ec61&#34;,
                    &#34;subnet-049f0119237ff00a0&#34;
                ],
                &#34;securityGroups&#34;: [
                    &#34;sg-040aff209e1fe59cc&#34;
                ],
                &#34;assignPublicIp&#34;: &#34;DISABLED&#34;
            }
        },
        &#34;healthCheckGracePeriodSeconds&#34;: 0,
        &#34;schedulingStrategy&#34;: &#34;REPLICA&#34;,
        &#34;createdBy&#34;: &#34;arn:aws:iam::152767562250:role/aws-reserved/sso.amazonaws.com/ap-northeast-1/AWSReservedSSO_AWSAdministratorAccess_8fe206b83490a022&#34;,
        &#34;enableECSManagedTags&#34;: false,
        &#34;propagateTags&#34;: &#34;NONE&#34;,
        &#34;enableExecuteCommand&#34;: false
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="動作確認１" duration="5">
        <h2 is-upgraded>■アドレス確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h2 is-upgraded>■画面確認</h2>
<ul>
<li>上記で取得されたアドレスをChromeなどのブラウザに貼り付け、以下のような表示になること</li>
<li>更新を行うと2行目のhostnameが変更されていること（ALBで負荷分散されている確認）</li>
</ul>
<p class="image-container"><img alt="img" src="img/e2b99bf0b9c4f721.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="変数整理" duration="0">
        <h2 is-upgraded>ここまで取得された変数を整理</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
export AccoutID=&#34;${AccoutID}&#34;
export VpcId=&#34;${VpcId}&#34;
export SubnetId1aPublic=&#34;${SubnetId1aPublic}&#34;
export SubnetId1cPublic=&#34;${SubnetId1cPublic}&#34;
export SubnetId1aPrivate=&#34;${SubnetId1aPrivate}&#34;
export SubnetId1cPrivate=&#34;${SubnetId1cPrivate}&#34;
export InternetGatewayId=&#34;${InternetGatewayId}&#34;
export RouteTableIdPublic=&#34;${RouteTableIdPublic}&#34;
export RouteTableIdPrivate=&#34;${RouteTableIdPrivate}&#34;
export PublicSecurityGroupsId=&#34;${PublicSecurityGroupsId}&#34;
export PrivateSecurityGroupsId=&#34;${PrivateSecurityGroupsId}&#34;
export LoadBalancerArn=&#34;${LoadBalancerArn}&#34;
export TargetGroupArn=&#34;${TargetGroupArn}&#34;
export LoadBalancersDnsName=&#34;${LoadBalancersDnsName}&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export AccoutID=&#34;152767562250&#34;
export VpcId=&#34;vpc-0d3c1c88db46cfba7&#34;
export SubnetId1aPublic=&#34;subnet-0f66f257f167a1d47&#34;
export SubnetId1cPublic=&#34;subnet-0a1e2afffc8c140d8&#34;
export SubnetId1aPrivate=&#34;subnet-049f0119237ff00a0&#34;
export SubnetId1cPrivate=&#34;subnet-0ea89b6bc85e0ec61&#34;
export InternetGatewayId=&#34;igw-0a511ba68ceb84ed8&#34;
export RouteTableIdPublic=&#34;rtb-00cf30796b25b9bc9&#34;
export RouteTableIdPrivate=&#34;rtb-0afaac377925bca9a&#34;
export PublicSecurityGroupsId=&#34;sg-01cc901415c240504&#34;
export PrivateSecurityGroupsId=&#34;sg-040aff209e1fe59cc&#34;
export LoadBalancerArn=&#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:loadbalancer/app/ContainerHandsOn/75145ed42d9a3867&#34;
export TargetGroupArn=&#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:targetgroup/ContainerHandsOn/7f11fa9e9d635ce9&#34;
export LoadBalancersDnsName=&#34;ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodeBuild作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="CodeDeploy作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="CodePipeline作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="Dockerコンテナ再ビルド(Codeシリーズを利用)" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="動作確認２" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="片付け" duration="5">
        <h2 is-upgraded>途中の見出し</h2>
<aside class="special"><p>何かお知らせを書きたい時のボックス</p>
</aside>
<aside class="warning"><p>何か注意点などを書きたい時のボックス</p>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
