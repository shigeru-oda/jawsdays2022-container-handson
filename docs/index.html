
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="docs"
                  title="[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="ご挨拶" duration="0">
        <h2 is-upgraded>■ご挨拶</h2>
<p>当資料は<a href="https://jawsdays2022.jaws-ug.jp/" target="_blank">JAWS DAYS 2022 - Satellites</a>でのハンズオントラックの一つ、<a href="https://jaws-ug.doorkeeper.jp/events/141627" target="_blank">コンテナサービスをCI/CDパイプラインでデプロイしよう</a>のセッションで利用する資料となります</p>
<p><a href="https://jawsdays2022.jaws-ug.jp/" target="_blank">JAWS DAYS 2022 - Satellites</a>のハンズオンは以下3点ありますが、他セッションはGUI、CDKでの環境構築であったので、当セッションはCLIでの環境構築として準備しています</p>
<ul>
<li><a href="https://jaws-ug.doorkeeper.jp/events/141646" target="_blank">S3でWebサイトを公開して、リソースポリシーでアクセスを制御してみよう</a></li>
<li><a href="https://jaws-ug.doorkeeper.jp/events/141627" target="_blank">コンテナサービスをCI/CDパイプラインでデプロイしよう</a></li>
<li><a href="https://jaws-ug.doorkeeper.jp/events/141651" target="_blank">CDKでサーバーレスアプリをデプロイしよう</a></li>
</ul>
<p>初心者の方にはCLIコマンドが難しいかもしれませんが、まずはこういうステップが必要という勘所だけでも掴んで頂ければ幸いです、慣れた方はCLIコマンドの1つ１つの意味を理解するように進めて頂けるとありがたいです</p>
<h2 is-upgraded>■対象者</h2>
<ul>
<li>コンテナが何かよく分からない人</li>
<li>ＡＷＳでのコンテナサービスを知りたい人</li>
<li>ＣＩ／ＣＤパイプラインでコンテナサービスをデプロイしたい人</li>
</ul>
<h2 is-upgraded>■当日までにご準備が必要なもの</h2>
<ul>
<li>マネジメントコンソールにログイン可能なAdministrator権限のIAMユーザー</li>
<li>Chrome もしくは Firefox</li>
</ul>
<h2 is-upgraded>■免責事項について</h2>
<p>ハンズオンで利用するサービスは一部課金対象となるサービスもございます<br> また、ハンズオンで作成した環境を削除しない場合には、課金が続くことによって高額になる可能性があります<br> 課金が発生したことによる責任は負えませんので、ご承知おきください 上記事項をご理解頂きお申込みいただけますようお願いいたします</p>
<h2 is-upgraded>■参考資料</h2>
<ul>
<li><a href="https://pages.awscloud.com/rs/112-TZM-766/images/AWS_CICD_ECS_Handson.pdf" target="_blank">AWS CI/CD for Amazon ECS ハンズオン~ Cloud9, Docker, Code Services を⽤いた開発効率向上 ~</a></li>
<li><a href="https://www.slideshare.net/AmazonWebServicesJapan/20190731-black-belt-online-seminar-amazon-ecs-deep-dive-162160987" target="_blank">20190731 Black Belt Online Seminar Amazon ECS Deep Dive</a></li>
<li><a href="https://www.slideshare.net/AmazonWebServicesJapan/202106-aws-black-belt-online-seminar-con110-249613926" target="_blank">202106 AWS Black Belt Online Seminar CON110 なぜ今コンテナなのか</a></li>
</ul>
<h2 is-upgraded>■ブラウザについて</h2>
<ul>
<li>Chrome もしくは Firefoxをご利用下さい。</li>
<li>IE もしくは Safariでは正しい挙動にならない可能性がございます</li>
</ul>
<h2 is-upgraded>■手順について</h2>
<p>貼り付けるコマンドは準備しているので、基本的にはCopy &amp; Pasteで手順を進めることができます</p>
<h3 is-upgraded>cmd</h3>
<p>cmdと記載された項目にある以下のような表示内容はコマンドをCopy &amp; Pasteするモノとなります</p>
<pre><code language="language-Sample" class="language-Sample">Copy &amp; Pasteの対象です
</code></pre>
<h3 is-upgraded>result</h3>
<p>resultと記載された項目にある以下のような表示内容はコマンドの実行結果です<br> IDなどは個々に異なりますので</p>
<ul>
<li>表示が大きく変わらない</li>
<li>エラーメッセージが出力されていない</li>
</ul>
<p>を確認ください</p>
<pre><code language="language-Sample" class="language-Sample">cmd実行後の結果です
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ハンズオンを通して学ぶこと" duration="5">
        <h2 is-upgraded>■ハンズオン１</h2>
<ul>
<li>VPCを使ったネットワーク環境の構築</li>
<li>VPCエンドポイントを使ったセキュア環境の構築</li>
<li>ECS /Fargateを使ったサーバーレスコンテナ運用の構築</li>
</ul>
<p class="image-container"><img alt="img" src="img/82fd59c38aae112a.png"></p>
<h2 is-upgraded>■ハンズオン２</h2>
<ul>
<li>CoceCommitを使ったソースコード管理</li>
<li>CodeBuildを使った自動ビルド</li>
<li>CodeDeployを使ったECS/Fargateへのデプロイ</li>
<li>CodePipelineを使ったCI/CDパイプラインの構築</li>
</ul>
<p class="image-container"><img alt="img" src="img/d3138990e9dc3264.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="事前準備とネットワーク周りの構築" duration="15">
        <h2 is-upgraded>■CloudShellの起動</h2>
<h3 is-upgraded>AWS コンソールにログイン</h3>
<ul>
<li>Administrator権限のIAMユーザーでAWSコンソールにログイン</li>
</ul>
<p class="image-container"><img alt="img" src="img/8ec695a05f461637.png"></p>
<ul>
<li>リージョンを&#34;アジアパシフィック（東京）&#34;に変更</li>
</ul>
<p class="image-container"><img alt="img" src="img/a700f74d7e2e97dd.png"></p>
<h3 is-upgraded>CloudShellボタン押下</h3>
<ul>
<li>画面右上のCloudShellボタンを押下<br><img alt="img" src="img/1bbb070a4cf9999c.png"></li>
</ul>
<h3 is-upgraded>CloudShellを起動</h3>
<p class="image-container"><img alt="img" src="img/9b0f4ff0313865b9.png"></p>
<h2 is-upgraded>■AWS Account IDの取得</h2>
<ul>
<li>IDを取得し、変数に格納・確認を行います</li>
</ul>
<p class="image-container"><img alt="img" src="img/54f3afc539095974.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID=`aws sts get-caller-identity --query Account --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID : 123456789012
</code></pre>
<h2 is-upgraded>■ECSタスクの実行Roleの存在確認</h2>
<ul>
<li>ECSタスクを実行するRole(ecsTaskExecutionRole)の存在確認を行います</li>
</ul>
<p class="image-container"><img alt="img" src="img/dc49b865deb5e1fe.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam list-roles | grep &#34;RoleName&#34; | grep &#34;ecsTaskExecutionRole&#34;
</code></pre>
<h3 is-upgraded>result（存在する場合）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">            &#34;RoleName&#34;: &#34;ecsTaskExecutionRole&#34;,
</code></pre>
<h3 is-upgraded>result（存在しない場合）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■ECSの実行Role作成（Roleが存在しない場合のみ実行）</h2>
<ul>
<li>ecsTaskExecutionRoleが存在しない場合のみ実行します</li>
</ul>
<p class="image-container"><img alt="img" src="img/dc49b865deb5e1fe.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/
cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;ecs-tasks.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ecsTaskExecutionRole \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ecsTaskExecutionRole&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFBW66KV4HJ&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ecsTaskExecutionRole&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-15T11:39:04+00:00&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;ecs-tasks.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■RoleにPolicyをアタッチ（Roleが存在しない場合のみ実行）</h2>
<ul>
<li>作成したRoleにPolicyをアタッチします</li>
</ul>
<p class="image-container"><img alt="img" src="img/7d76bf6d6743da53.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam attach-role-policy \
  --role-name ecsTaskExecutionRole \
  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<ul>
<li>Policyがアタッチされたことを確認します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam list-attached-role-policies \
  --role-name ecsTaskExecutionRole
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;AttachedPolicies&#34;: [
        {
            &#34;PolicyName&#34;: &#34;AmazonECSTaskExecutionRolePolicy&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■VPCの作成</h2>
<ul>
<li>VPCを新規に作成します</li>
</ul>
<p class="image-container"><img alt="img" src="img/9624902962ab2ee9.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-vpc \
    --cidr-block 10.0.0.0/16 \
    --tag-specification &#34;ResourceType=vpc,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Vpc&#34;: {
        &#34;CidrBlock&#34;: &#34;10.0.0.0/16&#34;,
        &#34;DhcpOptionsId&#34;: &#34;dopt-c3de3ba5&#34;,
        &#34;State&#34;: &#34;pending&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;InstanceTenancy&#34;: &#34;default&#34;,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;CidrBlockAssociationSet&#34;: [
            {
                &#34;AssociationId&#34;: &#34;vpc-cidr-assoc-0b14e52ce4b43dd1e&#34;,
                &#34;CidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;CidrBlockState&#34;: {
                    &#34;State&#34;: &#34;associated&#34;
                }
            }
        ],
        &#34;IsDefault&#34;: false,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ]
    }
}
</code></pre>
<h2 is-upgraded>■VpcIdの取得</h2>
<ul>
<li>IDを取得し、変数に格納・確認を行います</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId=`aws ec2 describe-vpcs \
    --query &#39;Vpcs[*].VpcId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
EOF
</code></pre>
<h3 is-upgraded>results</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
</code></pre>
<h3 is-upgraded>■DNS名前解決をONにする</h3>
<ul>
<li>作成したVPCで「ドメイン名からIPアドレスへの変換、またはその逆」を可能にします<br></li>
<li>後程作成するVPCエンドポイントに必要な為です<br></li>
</ul>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 modify-vpc-attribute \
  --vpc-id ${VpcId}  \
  --enable-dns-support  &#39;{&#34;Value&#34;:true}&#39; 
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>■DNS名前解決の状態確認</h3>
<ul>
<li>設定内容が正しく反映されているか確認を行います</li>
</ul>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-vpc-attribute \
  --query EnableDnsSupport \
  --vpc-id ${VpcId}  \
  --attribute enableDnsSupport
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Value&#34;: true
}
</code></pre>
<h3 is-upgraded>■DNSホスト名をONにする</h3>
<ul>
<li>VPC内でDNSホスト名(ex : ip-10-0-0-23.ap-northeast-1.compute.internal)を持つように設定します<br></li>
<li>後程作成するVPCエンドポイントに必要な為です<br></li>
</ul>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 modify-vpc-attribute \
  --vpc-id ${VpcId}  \
  --enable-dns-hostnames  &#39;{&#34;Value&#34;:true}&#39; 
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>■DNSホスト名の状態確認</h3>
<ul>
<li>設定内容が正しく反映されているか確認を行います</li>
</ul>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-vpc-attribute \
  --query EnableDnsHostnames \
  --vpc-id ${VpcId}  \
  --attribute enableDnsHostnames
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Value&#34;: true
}
</code></pre>
<h2 is-upgraded>■Subnetの作成</h2>
<ul>
<li>作成したVPCの中にSubnetを4つ作成します<br></li>
<li>Private Subnetが2つ、Public Subnetが2つです<br></li>
</ul>
<p class="image-container"><img alt="img" src="img/4b6c8ed3cde1b482.png"></p>
<h3 is-upgraded>cmd (Public Subnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.0.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result (Public Subnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1a&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az4&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.0.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0356b36ba2daa766c&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:123456789012:subnet/subnet-0356b36ba2daa766c&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd (Public Subnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.1.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result (Public Subnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1c&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az1&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.1.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0dabe411bfdc835fb&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:123456789012:subnet/subnet-0dabe411bfdc835fb&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd (Private Subnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.2.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result (Private Subnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1a&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az4&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.2.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0d99180ac3baeb5fa&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:123456789012:subnet/subnet-0d99180ac3baeb5fa&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd (Private Subnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.3.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result (Private Subnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1c&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az1&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.3.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0a66f1c2d5ce3b939&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:123456789012:subnet/subnet-0a66f1c2d5ce3b939&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h2 is-upgraded>■Subnet IDの取得</h2>
<ul>
<li>IDを取得し、変数に格納・確認を行います</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
</code></pre>
<h2 is-upgraded>■InternetGatewayの作成</h2>
<p class="image-container"><img alt="img" src="img/45a631880772ed3d.png"></p>
<ul>
<li>Internetの出入り口であるInternetGatewayを作成する</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-internet-gateway \
    --tag-specifications &#34;ResourceType=internet-gateway,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;InternetGateway&#34;: {
        &#34;Attachments&#34;: [],
        &#34;InternetGatewayId&#34;: &#34;igw-082f42082d7748713&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ]
    }
}
</code></pre>
<h2 is-upgraded>■InternetGateway IDの取得</h2>
<ul>
<li>IDを取得し、変数に格納・確認を行います</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">InternetGatewayId=`aws ec2 describe-internet-gateways \
    --query &#39;InternetGateways[*].InternetGatewayId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCにAttach</h2>
<ul>
<li>VPCとInternetGatewayを紐付けし、Internetとの接続点を作成します</li>
</ul>
<p class="image-container"><img alt="img" src="img/57c1596c33ffed93.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 attach-internet-gateway \
    --internet-gateway-id ${InternetGatewayId} \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCに紐付けされていることを確認</h2>
<ul>
<li>アタッチされていることを確認</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-internet-gateways \
    --internet-gateway-ids ${InternetGatewayId} \
    --query &#39;InternetGateways[*].Attachments[*].State&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">available
</code></pre>
<h2 is-upgraded>■RouteTableの作成</h2>
<ul>
<li>PublicSubnetとPrivateSubnetのデータの流れを制御するルートテーブルを作成します<br></li>
<li>現時点ではRouteTableとSubnetの紐付けはないです<br></li>
</ul>
<p class="image-container"><img alt="img" src="img/ed1a5faf3cef0944.png"></p>
<h3 is-upgraded>cmd (PublicSubnet)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result (PublicSubnet)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;RouteTable&#34;: {
        &#34;Associations&#34;: [],
        &#34;PropagatingVgws&#34;: [],
        &#34;RouteTableId&#34;: &#34;rtb-000a11e6eacc5c263&#34;,
        &#34;Routes&#34;: [
            {
                &#34;DestinationCidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;GatewayId&#34;: &#34;local&#34;,
                &#34;Origin&#34;: &#34;CreateRouteTable&#34;,
                &#34;State&#34;: &#34;active&#34;
            }
        ],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd (PrivateSubnet)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result (PrivateSubnet)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;RouteTable&#34;: {
        &#34;Associations&#34;: [],
        &#34;PropagatingVgws&#34;: [],
        &#34;RouteTableId&#34;: &#34;rtb-077b87e7eb65d1f43&#34;,
        &#34;Routes&#34;: [
            {
                &#34;DestinationCidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;GatewayId&#34;: &#34;local&#34;,
                &#34;Origin&#34;: &#34;CreateRouteTable&#34;,
                &#34;State&#34;: &#34;active&#34;
            }
        ],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;
    }
}
</code></pre>
<h2 is-upgraded>■RouteTable IDの取得</h2>
<ul>
<li>IDを取得し、変数に格納・確認を行います</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPublic=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPrivate=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
</code></pre>
<h2 is-upgraded>■RouteTableにSubnetを紐付け</h2>
<ul>
<li>RouteTableとSubnetを紐付けします</li>
</ul>
<p class="image-container"><img alt="img" src="img/aa08c9402ecac2c6.png"></p>
<h3 is-upgraded>cmd (PublicSubnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1aPublic}
</code></pre>
<h3 is-upgraded>result (PublicSubnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-0fdd06641008db840&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd (PublicSubnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1cPublic}
</code></pre>
<h3 is-upgraded>result (PublicSubnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-067b436f3f7eb8e3a&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd (PrivateSubnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1aPrivate}
</code></pre>
<h3 is-upgraded>result (PrivateSubnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-0d02b62aeb39e373e&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd (PrivateSubnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1cPrivate}
</code></pre>
<h3 is-upgraded>result (PrivateSubnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-07780995550f76761&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h2 is-upgraded>■RouteTableにInternetGatewayを紐付け</h2>
<ul>
<li>PublicSubnet用のRouteTableにInternetGatewayを紐付け、Internetに接続できるようにします</li>
</ul>
<p class="image-container"><img alt="img" src="img/5f8c0b4a1ae909b9.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route \
  --route-table-id ${RouteTableIdPublic} \
  --destination-cidr-block &#34;0.0.0.0/0&#34; \
  --gateway-id ${InternetGatewayId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true
}
</code></pre>
<h2 is-upgraded>■PublicSubnet用のSecurityGroup作成</h2>
<ul>
<li>PublicSubnet用のSecurityGroup作成</li>
</ul>
<p class="image-container"><img alt="img" src="img/24c36db597450cbb.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-security-group \
  --group-name PublicSecurityGroup \
  --description &#34;Public Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-PublicSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;GroupId&#34;: &#34;sg-065a7c8eceb9759d4&#34;,
    &#34;Tags&#34;: [
        {
            &#34;Key&#34;: &#34;Name&#34;,
            &#34;Value&#34;: &#34;ContainerHandsOn-PublicSecurityGroup&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PublicSunetのSecurityGroupsIdの取得</h2>
<ul>
<li>IDを取得し、変数に格納・確認を行います</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code>PublicSecurityGroupsId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-PublicSecurityGroup&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
</code></pre>
<h2 is-upgraded>■PrivateSubnet用のSecurityGroup作成</h2>
<ul>
<li>PrivateSubnet用のSecurityGroup作成</li>
</ul>
<p class="image-container"><img alt="img" src="img/b314e27b8454719.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-security-group \
  --group-name PrivateSecurityGroup \
  --description &#34;Private Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-PrivateSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;GroupId&#34;: &#34;sg-0f59547a1185820b5&#34;,
    &#34;Tags&#34;: [
        {
            &#34;Key&#34;: &#34;Name&#34;,
            &#34;Value&#34;: &#34;ContainerHandsOn-PrivateSecurityGroup&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PublicSunetのSecurityGroupsIdの取得</h2>
<ul>
<li>IDを取得し、変数に格納・確認を行います</li>
</ul>
<pre><code language="language-CloudShell" class="language-CloudShell">PrivateSecurityGroupsId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-PrivateSecurityGroup&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
</code></pre>
<h2 is-upgraded>■PublicSubnetのインバウンドルールを追加</h2>
<ul>
<li>InternetからのHTTP（プロトコルtcp ポート80）でのアクセスを許可します</li>
</ul>
<p class="image-container"><img alt="img" src="img/4f75c4cd8ddf9874.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PublicSecurityGroupsId} \
    --protocol tcp \
    --port 80 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0fa3570659990ac7c&#34;,
            &#34;GroupId&#34;: &#34;sg-065a7c8eceb9759d4&#34;,
            &#34;GroupOwnerId&#34;: &#34;123456789012&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 80,
            &#34;ToPort&#34;: 80,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PrivateSubnetのインバウンドルールを追加１</h2>
<ul>
<li>PublicSubnet経由でのHTTPでのアクセスを許可します</li>
</ul>
<p class="image-container"><img alt="img" src="img/bc805771477af86.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PrivateSecurityGroupsId} \
    --protocol tcp \
    --port 80 \
    --source-group ${PublicSecurityGroupsId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-03987cbc28a10ec4c&#34;,
            &#34;GroupId&#34;: &#34;sg-0f59547a1185820b5&#34;,
            &#34;GroupOwnerId&#34;: &#34;123456789012&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 80,
            &#34;ToPort&#34;: 80,
            &#34;ReferencedGroupInfo&#34;: {
                &#34;GroupId&#34;: &#34;sg-065a7c8eceb9759d4&#34;
            }
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PrivateSubnetのインバウンドルールを追加２</h2>
<ul>
<li>後で設定するVPCエンドポイントの為にHTTPS（プロトコルtcp ポート443）アクセスを許可します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PrivateSecurityGroupsId} \
    --protocol tcp \
    --port 443 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0597c6c5a6a6f4758&#34;,
            &#34;GroupId&#34;: &#34;sg-0f59547a1185820b5&#34;,
            &#34;GroupOwnerId&#34;: &#34;123456789012&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 443,
            &#34;ToPort&#34;: 443,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■CloudWatch LogGroupの作成</h2>
<ul>
<li>ecsTaskExecutionRoleがLogGroupを作成できないので、手作成します。</li>
</ul>
<p class="image-container"><img alt="img" src="img/fe856b76c8cbed22.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws logs create-log-group --log-group-name awslogs-container-hands-on
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h2 is-upgraded>■CloudWatch LogGroupの作成確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws logs describe-log-groups --log-group-name-prefix awslogs-container-hands-on
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;logGroups&#34;: [
        {
            &#34;logGroupName&#34;: &#34;awslogs-container-hands-on&#34;,
            &#34;creationTime&#34;: 1663242536780,
            &#34;metricFilterCount&#34;: 0,
            &#34;arn&#34;: &#34;arn:aws:logs:ap-northeast-1:123456789012:log-group:awslogs-container-hands-on:*&#34;,
            &#34;storedBytes&#34;: 0
        }
    ]
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Cloud9作成" duration="10">
        <h2 is-upgraded>■Cloud9の作成</h2>
<ul>
<li>コードを記述、実行、デバッグできるクラウドベースの統合開発環境 (IDE)であるCloud9を作成</li>
<li>CloudShellでは、Dockerコンテナをサポートしていないため、Dockerが扱えるCloud9上でハンズオン作業を行います</li>
</ul>
<p class="image-container"><img alt="img" src="img/6bb3dcef091abeb0.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws cloud9 create-environment-ec2 \
  --name ContainerHandsOn \
  --description &#34;ContainerHandsOn&#34; \
  --instance-type t3.small  \
  --subnet-id ${SubnetId1aPublic}  \
  --automatic-stop-time-minutes 60 
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;environmentId&#34;: &#34;d95af67d7d5f4a9782475b0549bf1fe2&#34;
}
</code></pre>
<h2 is-upgraded>■Cloud9環境Roleを作成</h2>
<ul>
<li>Cloud9上でAWSリソースを作成するため、Roleを作成します</li>
</ul>
<p class="image-container"><img alt="img" src="img/80b44a9435aa14dc.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">cd ~/
cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;ec2.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ContainerHandsOnForCloud9 \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForCloud9&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFELRPUULUJ&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForCloud9&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-15T11:49:42+00:00&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;ec2.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■Cloud9環境RoleにPolicy追加</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws iam attach-role-policy \
  --role-name ContainerHandsOnForCloud9 \
  --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws iam list-attached-role-policies \
  --role-name ContainerHandsOnForCloud9
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AttachedPolicies&#34;: [
        {
            &#34;PolicyName&#34;: &#34;AdministratorAccess&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AdministratorAccess&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■instance-profileを作成</h2>
<ul>
<li>Cloud9を稼働しているEC2にRoleを付与するため、instance-profileを作成</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws iam create-instance-profile \
    --instance-profile-name ContainerHandsOnForCloud9
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;InstanceProfile&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;InstanceProfileName&#34;: &#34;ContainerHandsOnForCloud9&#34;,
        &#34;InstanceProfileId&#34;: &#34;AIPASHENIAIFEVHXOW7NP&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:instance-profile/ContainerHandsOnForCloud9&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-15T11:50:50+00:00&#34;,
        &#34;Roles&#34;: []
    }
}
</code></pre>
<h2 is-upgraded>■instance-profileにRole付与</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws iam add-role-to-instance-profile \
    --role-name ContainerHandsOnForCloud9 \
    --instance-profile-name ContainerHandsOnForCloud9
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h2 is-upgraded>■Cloud9のInstanceIdの取得</h2>
<ul>
<li>IDを取得し、変数に格納・確認を行います</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">InstanceId=`aws ec2 describe-instances \
    --query &#34;Reservations[*].Instances[*].InstanceId&#34; \
    --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
</code></pre>
<h2 is-upgraded>■Cloud9環境RoleをAttach</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-iam-instance-profile \
    --instance-id ${InstanceId} \
    --iam-instance-profile Name=ContainerHandsOnForCloud9
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;IamInstanceProfileAssociation&#34;: {
        &#34;AssociationId&#34;: &#34;iip-assoc-0989fcd85f472ddc6&#34;,
        &#34;InstanceId&#34;: &#34;i-0ddf413a91a008a52&#34;,
        &#34;IamInstanceProfile&#34;: {
            &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:instance-profile/ContainerHandsOnForCloud9&#34;,
            &#34;Id&#34;: &#34;AIPASHENIAIFEVHXOW7NP&#34;
        },
        &#34;State&#34;: &#34;associating&#34;
    }
}
</code></pre>
<h2 is-upgraded>■環境変数をメモ</h2>
<ul>
<li>Cloud9で使うため、取得した変数をエディターに残して下さい</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
export AccountID=&#34;${AccountID}&#34;
export VpcId=&#34;${VpcId}&#34;
export SubnetId1aPublic=&#34;${SubnetId1aPublic}&#34;
export SubnetId1cPublic=&#34;${SubnetId1cPublic}&#34;
export SubnetId1aPrivate=&#34;${SubnetId1aPrivate}&#34;
export SubnetId1cPrivate=&#34;${SubnetId1cPrivate}&#34;
export InternetGatewayId=&#34;${InternetGatewayId}&#34;
export RouteTableIdPublic=&#34;${RouteTableIdPublic}&#34;
export RouteTableIdPrivate=&#34;${RouteTableIdPrivate}&#34;
export PublicSecurityGroupsId=&#34;${PublicSecurityGroupsId}&#34;
export PrivateSecurityGroupsId=&#34;${PrivateSecurityGroupsId}&#34;
export InstanceId=&#34;${InstanceId}&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">export AccountID=&#34;123456789012&#34;
export VpcId=&#34;vpc-010a940bbd8f747c2&#34;
export SubnetId1aPublic=&#34;subnet-0356b36ba2daa766c&#34;
export SubnetId1cPublic=&#34;subnet-0dabe411bfdc835fb&#34;
export SubnetId1aPrivate=&#34;subnet-0d99180ac3baeb5fa&#34;
export SubnetId1cPrivate=&#34;subnet-0a66f1c2d5ce3b939&#34;
export InternetGatewayId=&#34;igw-082f42082d7748713&#34;
export RouteTableIdPublic=&#34;rtb-000a11e6eacc5c263&#34;
export RouteTableIdPrivate=&#34;rtb-077b87e7eb65d1f43&#34;
export PublicSecurityGroupsId=&#34;sg-065a7c8eceb9759d4&#34;
export PrivateSecurityGroupsId=&#34;sg-0f59547a1185820b5&#34;
export InstanceId=&#34;i-0ddf413a91a008a52&#34;
</code></pre>
<h2 is-upgraded>■AWS コンソールでCloud9を起動</h2>
<ul>
<li>上部の検索バーでCloud9と検索</li>
<li>AWS Cloud9 &gt; Your environmentsにContainerHandsOnが作成されているので、Open IDEボタン押下</li>
<li>Cloud9の画面が表示される</li>
<li>今後のcmdはCloud9のbashと書かれたTABの下に貼り付けていきます <a href="./image/img4-1.png" target="_blank"><img alt="img" src="img/ccb3ac339b93cb8e.png"></a></li>
<li>間違えてTABを閉じてしまった場合には以下で新しくTABを開いてください <a href="./image/img4-2.png" target="_blank"><img alt="img" src="img/944649a354b83dff.png"></a></li>
</ul>
<h2 is-upgraded>■Cloud9でCredentialsを切り替え</h2>
<ul>
<li>画面右上の歯車マークをクリックし、Preferencesを開く</li>
<li>Preferences &gt; AWS Settings &gt; Credentials と画面遷移をする</li>
<li>Credentialsをオフにする</li>
</ul>
<p><a href="./image/img4-3.png" target="_blank"><img alt="img" src="img/d2d391502c16e5d6.png"></a></p>
<h2 is-upgraded>■Credential切り替え後の確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws sts get-caller-identity
</code></pre>
<h3 is-upgraded>result</h3>
<ul>
<li>表示されるArnとして、次のように<code>ContainerHandsOnForCloud9</code>のassumed-roleが表示されればOK</li>
</ul>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;UserId&#34;: &#34;AROARSZZ5OK6XKSLV6L7V:i-0a1d7ee9d83080bff&#34;,
    &#34;Account&#34;: &#34;123456789012&#34;,
    &#34;Arn&#34;: &#34;arn:aws:sts::123456789012:assumed-role/ContainerHandsOnForCloud9/i-0ddf413a91a008a52&#34;
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ECR作成" duration="5">
        <h2 is-upgraded>■環境変数を貼り付け</h2>
<ul>
<li>CloudShellで取得した環境変数をCloud9へ移設</li>
</ul>
<h3 is-upgraded>cmd (以下はサンプルです、エディターに退避した結果を利用ください)</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">このままコピペするとエラーになります。エディターに退避した結果を利用ください

これはサンプルです。export AccountID=&#34;123456789012&#34;
これはサンプルです。export VpcId=&#34;vpc-010a940bbd8f747c2&#34;
これはサンプルです。export SubnetId1aPublic=&#34;subnet-0356b36ba2daa766c&#34;
これはサンプルです。export SubnetId1cPublic=&#34;subnet-0dabe411bfdc835fb&#34;
これはサンプルです。export SubnetId1aPrivate=&#34;subnet-0d99180ac3baeb5fa&#34;
これはサンプルです。export SubnetId1cPrivate=&#34;subnet-0a66f1c2d5ce3b939&#34;
これはサンプルです。export InternetGatewayId=&#34;igw-082f42082d7748713&#34;
これはサンプルです。export RouteTableIdPublic=&#34;rtb-000a11e6eacc5c263&#34;
これはサンプルです。export RouteTableIdPrivate=&#34;rtb-077b87e7eb65d1f43&#34;
これはサンプルです。export PublicSecurityGroupsId=&#34;sg-065a7c8eceb9759d4&#34;
これはサンプルです。export PrivateSecurityGroupsId=&#34;sg-0f59547a1185820b5&#34;
これはサンプルです。export InstanceId=&#34;i-0ddf413a91a008a52&#34;
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
</code></pre>
<h2 is-upgraded>■AWS CLIの環境設定実施</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export AWS_DEFAULT_REGION=ap-northeast-1
export AWS_DEFAULT_OUTPUT=json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■ECRの作成</h2>
<ul>
<li>コンテナイメージのレジストリであるECRを作成</li>
</ul>
<p class="image-container"><img alt="img" src="img/347a1df18f53d23.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr create-repository \
    --repository-name jaws-days-2022/container-hands-on \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;repository&#34;: {
        &#34;repositoryArn&#34;: &#34;arn:aws:ecr:ap-northeast-1:123456789012:repository/jaws-days-2022/container-hands-on&#34;,
        &#34;registryId&#34;: &#34;123456789012&#34;,
        &#34;repositoryName&#34;: &#34;jaws-days-2022/container-hands-on&#34;,
        &#34;repositoryUri&#34;: &#34;123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on&#34;,
        &#34;createdAt&#34;: 1663243247.0,
        &#34;imageTagMutability&#34;: &#34;MUTABLE&#34;,
        &#34;imageScanningConfiguration&#34;: {
            &#34;scanOnPush&#34;: false
        },
        &#34;encryptionConfiguration&#34;: {
            &#34;encryptionType&#34;: &#34;AES256&#34;
        }
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Docker Image作成" duration="10">
        <h2 is-upgraded>■Cloud9上にdockerセットアップされていることを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker -v
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Docker version 20.10.13, build a224086
</code></pre>
<h2 is-upgraded>■Cloud9上にDockerfileを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; Dockerfile
FROM php:7.4.0-apache
COPY src/ /var/www/html/
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">mkdir src
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; ./src/index.php
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;ja&#34;&gt;
  &lt;head&gt;
    &lt;title&gt;Hello! Jaws Days 2022!!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Hello! Jaws Days 2022!!&lt;/p&gt;
    &lt;?php echo gethostname(); ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">ls -l ./Dockerfile ./src/index.php
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">-rw-rw-r-- 1 ec2-user ec2-user  47 Sep 15 12:01 ./Dockerfile
-rw-rw-r-- 1 ec2-user ec2-user 190 Sep 15 12:01 ./src/index.php
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker build \
  -t jaws-days-2022/container-hands-on .
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Sending build context to Docker daemon  9.822MB
Step 1/2 : FROM php:7.4.0-apache
7.4.0-apache: Pulling from library/php
000eee12ec04: Pull complete 
8ae4f9fcfeea: Pull complete 
60f22fbbd07a: Pull complete 
ccc7a63ad75f: Pull complete 
a2427b8dd6e7: Pull complete 
91cac3b30184: Pull complete 
d6e40015fc10: Pull complete 
9858aa646efe: Pull complete 
7940985f7eb2: Pull complete 
b23f72eebcfb: Pull complete 
75bb7b8d192c: Pull complete 
7edf943992b0: Pull complete 
c8bf9d9d0e11: Pull complete 
Digest: sha256:686af696a87d3836c694380588368ff4e7ad3e30f1faef387c545890b340edee
Status: Downloaded newer image for php:7.4.0-apache
 ---&gt; bf262c8621c1
Step 2/2 : COPY src/ /var/www/html/
 ---&gt; 31879637952a
Successfully built 31879637952a
Successfully tagged jaws-days-2022/container-hands-on:latest
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築されたことを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-cloud9" class="language-cloud9">docker images \
  --filter reference= jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-cloud9" class="language-cloud9">REPOSITORY                          TAG       IMAGE ID       CREATED          SIZE
jaws-days-2022/container-hands-on   latest    31879637952a   47 seconds ago   414MB
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを起動</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker run \
  --name container-hands-on \
  -d -p 8080:80 jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">90d092942d12681bcf38fe41e72e56bec3b241be4560e12365169c6a773b809c
</code></pre>
<h3 is-upgraded>画面</h3>
<p class="image-container"><img alt="img" src="img/2be66bb659acb02.png"></p>
<ul>
<li>Cloud9のヘッダ部分の<code>Preview</code>-&gt; <code>Preview Runnnig Application</code>のボタン押下<br></li>
<li><code>Hello! Jaws Days 2022!!</code>と記載された画面が表示されること<br></li>
</ul>
<aside class="special"><p>作業ミス等によりコンテナを止めたい場合には以下を実行ください</p>
</aside>
<pre><code language="language-Cloud9" class="language-Cloud9">docker stop $(docker ps -q)
docker rm $(docker ps -q -a)
</code></pre>
<h2 is-upgraded>■Docker ImageにTag付けを行う</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker tag \
  jaws-days-2022/container-hands-on:latest `echo ${AccountID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■Docker ImageにTag付けの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker images \
  --filter reference=`echo ${AccountID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">REPOSITORY                                                                            TAG       IMAGE ID       CREATED              SIZE
123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on   latest    31879637952a   About a minute ago   414MB
</code></pre>
<h2 is-upgraded>■認証トークンを取得し、レジストリに対して Docker クライアントを認証します</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr get-login-password \
  --region ap-northeast-1 | \
  docker login \
  --username AWS \
  --password-stdin `echo ${AccountID}`.dkr.ecr.ap-northeast-1.amazonaws.com
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">WARNING! Your password will be stored unencrypted in /home/ec2-user/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
</code></pre>
<h2 is-upgraded>■Docker ImageをECRにPush</h2>
<ul>
<li>Cloud9で作成したイメージをECRに格納します</li>
</ul>
<p class="image-container"><img alt="img" src="img/5b6a2a96098bbb08.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker push \
  ${AccountID}.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">The push refers to repository [123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on]
3d025b51ca1a: Pushed 
536365481ed8: Pushed 
4b3693c51878: Pushed 
677c3ce9f0b4: Pushed 
c08f4d9c281b: Pushed 
ed13170590f7: Pushed 
37cbdda31557: Pushed 
9691e5d7a4c7: Pushed 
6a4d393f0795: Pushed 
e38834ac7561: Pushed 
ec64f555d498: Pushed 
840f3f414cf6: Pushed 
17fce12edef0: Pushed 
831c5620387f: Pushed 
latest: digest: sha256:385537de56b405bf07d5218a21eb9160bf023021713bbe05582cd9a2d7365ce5 size: 3242
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="VPCエンドポイント作成" duration="10">
        <p>FargateをPrivateSubnetで稼働させるため、以下VPCエンドポイントを準備します<br> ECRに格納されたイメージを取得するためには通常Internet経由となります、しかし今回はFargateはPrivateSubnetというInternetに接続されていないので、Internet経由ではECRにアクセスできません<br> これを解決するためにVPCエンドポイントというInternetに繋がらないAWSのネットワーク経由でECRにアクセスを行います。</p>
<ul>
<li>com.amazonaws.ap-northeast-1.s3</li>
<li>com.amazonaws.ap-northeast-1.ecr.dkr</li>
<li>com.amazonaws.ap-northeast-1.ecr.api</li>
<li>com.amazonaws.ap-northeast-1.logs</li>
</ul>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.s3</h2>
<ul>
<li>S3はGateway型のエンドポイントを利用します</li>
</ul>
<p class="image-container"><img alt="img" src="img/3871c4d228880be6.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Gateway \
    --service-name com.amazonaws.ap-northeast-1.s3 \
    --route-table-ids ${RouteTableIdPrivate} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcEndpointId&#34;: &#34;vpce-06659337f5464d836&#34;,
        &#34;VpcEndpointType&#34;: &#34;Gateway&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.s3&#34;,
        &#34;State&#34;: &#34;available&#34;,
        &#34;PolicyDocument&#34;: &#34;{\&#34;Version\&#34;:\&#34;2008-10-17\&#34;,\&#34;Statement\&#34;:[{\&#34;Effect\&#34;:\&#34;Allow\&#34;,\&#34;Principal\&#34;:\&#34;*\&#34;,\&#34;Action\&#34;:\&#34;*\&#34;,\&#34;Resource\&#34;:\&#34;*\&#34;}]}&#34;,
        &#34;RouteTableIds&#34;: [
            &#34;rtb-077b87e7eb65d1f43&#34;
        ],
        &#34;SubnetIds&#34;: [],
        &#34;Groups&#34;: [],
        &#34;PrivateDnsEnabled&#34;: false,
        &#34;RequesterManaged&#34;: false,
        &#34;NetworkInterfaceIds&#34;: [],
        &#34;DnsEntries&#34;: [],
        &#34;CreationTimestamp&#34;: &#34;2022-09-15T12:05:51.000Z&#34;,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ],
        &#34;OwnerId&#34;: &#34;123456789012&#34;
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.dkr</h2>
<ul>
<li>ECRはInterface型のエンドポイントを利用します</li>
</ul>
<p class="image-container"><img alt="img" src="img/f3bae0dc8785c261.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.dkr \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcEndpointId&#34;: &#34;vpce-01b89cdff71057ac6&#34;,
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.ecr.dkr&#34;,
        &#34;State&#34;: &#34;pending&#34;,
        &#34;RouteTableIds&#34;: [],
        &#34;SubnetIds&#34;: [
            &#34;subnet-0d99180ac3baeb5fa&#34;,
            &#34;subnet-0a66f1c2d5ce3b939&#34;
        ],
        &#34;Groups&#34;: [
            {
                &#34;GroupId&#34;: &#34;sg-0f59547a1185820b5&#34;,
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;
            }
        ],
        &#34;IpAddressType&#34;: &#34;ipv4&#34;,
        &#34;DnsOptions&#34;: {
            &#34;DnsRecordIpType&#34;: &#34;ipv4&#34;
        },
        &#34;PrivateDnsEnabled&#34;: true,
        &#34;RequesterManaged&#34;: false,
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-05c8a332e7c1cd6f1&#34;,
            &#34;eni-0f512a24a322c2df6&#34;
        ],
        &#34;DnsEntries&#34;: [
            {
                &#34;DnsName&#34;: &#34;vpce-01b89cdff71057ac6-9xjg2vqn.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;vpce-01b89cdff71057ac6-9xjg2vqn-ap-northeast-1c.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;vpce-01b89cdff71057ac6-9xjg2vqn-ap-northeast-1a.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;dkr.ecr.ap-northeast-1.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;
            },
            {
                &#34;DnsName&#34;: &#34;*.dkr.ecr.ap-northeast-1.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;
            }
        ],
        &#34;CreationTimestamp&#34;: &#34;2022-09-15T12:06:12.996Z&#34;,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ],
        &#34;OwnerId&#34;: &#34;123456789012&#34;
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.api</h2>
<ul>
<li>ECRはInterface型のエンドポイントを利用します</li>
</ul>
<p class="image-container"><img alt="img" src="img/365d8818452e3a9a.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.api \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcEndpointId&#34;: &#34;vpce-0b393692593886a63&#34;,
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.ecr.api&#34;,
        &#34;State&#34;: &#34;pending&#34;,
        &#34;RouteTableIds&#34;: [],
        &#34;SubnetIds&#34;: [
            &#34;subnet-0d99180ac3baeb5fa&#34;,
            &#34;subnet-0a66f1c2d5ce3b939&#34;
        ],
        &#34;Groups&#34;: [
            {
                &#34;GroupId&#34;: &#34;sg-0f59547a1185820b5&#34;,
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;
            }
        ],
        &#34;IpAddressType&#34;: &#34;ipv4&#34;,
        &#34;DnsOptions&#34;: {
            &#34;DnsRecordIpType&#34;: &#34;ipv4&#34;
        },
        &#34;PrivateDnsEnabled&#34;: true,
        &#34;RequesterManaged&#34;: false,
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-08db2d56fe23f4746&#34;,
            &#34;eni-010e2407de481c23e&#34;
        ],
        &#34;DnsEntries&#34;: [
            {
                &#34;DnsName&#34;: &#34;vpce-0b393692593886a63-w1unh4qj.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;vpce-0b393692593886a63-w1unh4qj-ap-northeast-1c.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;vpce-0b393692593886a63-w1unh4qj-ap-northeast-1a.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;api.ecr.ap-northeast-1.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;
            }
        ],
        &#34;CreationTimestamp&#34;: &#34;2022-09-15T12:06:37.143Z&#34;,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ],
        &#34;OwnerId&#34;: &#34;123456789012&#34;
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.logs</h2>
<ul>
<li>CloudWatch LogsはInterface型のエンドポイントを利用します</li>
</ul>
<p class="image-container"><img alt="img" src="img/2d766fe3db95705c.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.logs \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcEndpointId&#34;: &#34;vpce-0aa40c4643e1f52ea&#34;,
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;,
        &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.logs&#34;,
        &#34;State&#34;: &#34;pending&#34;,
        &#34;RouteTableIds&#34;: [],
        &#34;SubnetIds&#34;: [
            &#34;subnet-0d99180ac3baeb5fa&#34;,
            &#34;subnet-0a66f1c2d5ce3b939&#34;
        ],
        &#34;Groups&#34;: [
            {
                &#34;GroupId&#34;: &#34;sg-0f59547a1185820b5&#34;,
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;
            }
        ],
        &#34;IpAddressType&#34;: &#34;ipv4&#34;,
        &#34;DnsOptions&#34;: {
            &#34;DnsRecordIpType&#34;: &#34;ipv4&#34;
        },
        &#34;PrivateDnsEnabled&#34;: true,
        &#34;RequesterManaged&#34;: false,
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-0b0fb7fc59f22f128&#34;,
            &#34;eni-06d10382813d38317&#34;
        ],
        &#34;DnsEntries&#34;: [
            {
                &#34;DnsName&#34;: &#34;vpce-0aa40c4643e1f52ea-6rcso5ee.logs.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;vpce-0aa40c4643e1f52ea-6rcso5ee-ap-northeast-1c.logs.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;vpce-0aa40c4643e1f52ea-6rcso5ee-ap-northeast-1a.logs.ap-northeast-1.vpce.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;
            },
            {
                &#34;DnsName&#34;: &#34;logs.ap-northeast-1.amazonaws.com&#34;,
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;
            }
        ],
        &#34;CreationTimestamp&#34;: &#34;2022-09-15T12:07:05.639Z&#34;,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ],
        &#34;OwnerId&#34;: &#34;123456789012&#34;
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ALB作成" duration="5">
        <h2 is-upgraded>■アプリケーションロードバランサーの作成</h2>
<ul>
<li>実行されるコンテナのタスクを複数立てた場合に、処理を振り分けるようにアプリケーションロードバランサーを作成します <img alt="img" src="img/a058c202c2286c2a.png"></li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-load-balancer \
    --name ContainerHandsOn \
    --subnets ${SubnetId1aPublic} ${SubnetId1cPublic} \
    --security-groups ${PublicSecurityGroupsId} \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;LoadBalancers&#34;: [
        {
            &#34;LoadBalancerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053&#34;,
            &#34;DNSName&#34;: &#34;ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com&#34;,
            &#34;CanonicalHostedZoneId&#34;: &#34;Z14GRHDCWA56QT&#34;,
            &#34;CreatedTime&#34;: &#34;2022-09-15T12:07:31.550Z&#34;,
            &#34;LoadBalancerName&#34;: &#34;ContainerHandsOn&#34;,
            &#34;Scheme&#34;: &#34;internet-facing&#34;,
            &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
            &#34;State&#34;: {
                &#34;Code&#34;: &#34;provisioning&#34;
            },
            &#34;Type&#34;: &#34;application&#34;,
            &#34;AvailabilityZones&#34;: [
                {
                    &#34;ZoneName&#34;: &#34;ap-northeast-1a&#34;,
                    &#34;SubnetId&#34;: &#34;subnet-0356b36ba2daa766c&#34;,
                    &#34;LoadBalancerAddresses&#34;: []
                },
                {
                    &#34;ZoneName&#34;: &#34;ap-northeast-1c&#34;,
                    &#34;SubnetId&#34;: &#34;subnet-0dabe411bfdc835fb&#34;,
                    &#34;LoadBalancerAddresses&#34;: []
                }
            ],
            &#34;SecurityGroups&#34;: [
                &#34;sg-065a7c8eceb9759d4&#34;
            ],
            &#34;IpAddressType&#34;: &#34;ipv4&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■ターゲットグループの作成</h2>
<ul>
<li>タスクはどのようなプロトコルで稼働するターゲットであるか定義します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-target-group \
    --name ContainerHandsOn \
    --protocol HTTP \
    --port 80 \
    --target-type ip \
    --health-check-protocol HTTP \
    --health-check-port traffic-port \
    --health-check-path /index.php \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;TargetGroups&#34;: [
        {
            &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148&#34;,
            &#34;TargetGroupName&#34;: &#34;ContainerHandsOn&#34;,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;Port&#34;: 80,
            &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
            &#34;HealthCheckProtocol&#34;: &#34;HTTP&#34;,
            &#34;HealthCheckPort&#34;: &#34;traffic-port&#34;,
            &#34;HealthCheckEnabled&#34;: true,
            &#34;HealthCheckIntervalSeconds&#34;: 30,
            &#34;HealthCheckTimeoutSeconds&#34;: 5,
            &#34;HealthyThresholdCount&#34;: 5,
            &#34;UnhealthyThresholdCount&#34;: 2,
            &#34;HealthCheckPath&#34;: &#34;/index.php&#34;,
            &#34;Matcher&#34;: {
                &#34;HttpCode&#34;: &#34;200&#34;
            },
            &#34;TargetType&#34;: &#34;ip&#34;,
            &#34;ProtocolVersion&#34;: &#34;HTTP1&#34;,
            &#34;IpAddressType&#34;: &#34;ipv4&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■アプリケーションロードバランサーのDNS取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">LoadBalancersDnsName=`aws elbv2 describe-load-balancers \
  --names ContainerHandsOn \
  --query &#34;LoadBalancers[*].DNSName&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
LoadBalancersDnsName : ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h2 is-upgraded>■アプリケーションロードバランサーのARN取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">LoadBalancerArn=`aws elbv2 describe-load-balancers \
  --names ContainerHandsOn \
  --query &#34;LoadBalancers[*].LoadBalancerArn&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
LoadBalancersDnsName : ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053
</code></pre>
<h2 is-upgraded>■ターゲットグループのARN取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">TargetGroupArn=`aws elbv2 describe-target-groups \
  --names ContainerHandsOn \
  --query &#34;TargetGroups[*].TargetGroupArn&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
LoadBalancersDnsName : ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148
</code></pre>
<h2 is-upgraded>■リスナーの追加</h2>
<ul>
<li>アプリケーションロードバランサーとターゲットグループを紐付けします</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-listener \
    --load-balancer-arn ${LoadBalancerArn} \
    --protocol HTTP \
    --port 80 \
    --default-actions Type=forward,TargetGroupArn=${TargetGroupArn}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Listeners&#34;: [
        {
            &#34;ListenerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/b392eaa096f09053/b5d7e272d5152d8d&#34;,
            &#34;LoadBalancerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053&#34;,
            &#34;Port&#34;: 80,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;DefaultActions&#34;: [
                {
                    &#34;Type&#34;: &#34;forward&#34;,
                    &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148&#34;,
                    &#34;ForwardConfig&#34;: {
                        &#34;TargetGroups&#34;: [
                            {
                                &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148&#34;,
                                &#34;Weight&#34;: 1
                            }
                        ],
                        &#34;TargetGroupStickinessConfig&#34;: {
                            &#34;Enabled&#34;: false
                        }
                    }
                }
            ]
        }
    ]
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ECS/Fargate作成" duration="15">
        <h2 is-upgraded>■ECS/Fargate周辺の説明</h2>
<h3 is-upgraded>参考</h3>
<p><a href="https://www.slideshare.net/AmazonWebServicesJapan/20190731-black-belt-online-seminar-amazon-ecs-deep-dive-162160987" target="_blank">20190731 Black Belt Online Seminar Amazon ECS Deep Dive</a></p>
<h3 is-upgraded>ECS on EC2の構成図</h3>
<ul>
<li>EC2上で稼働するTaskでコンテナが処理されます</li>
<li>EC2を複数個まとめてクラスターとして扱います</li>
<li>クラスター管理をし、どのEC2へ新規タスクを設けるかはECSの役目です</li>
</ul>
<p class="image-container"><img alt="img" src="img/f1a8c502f37f27d.png"></p>
<h3 is-upgraded>ECS on Fargateの構成図</h3>
<ul>
<li>しかし僕らが注力したいのはコンテナでどのような処理が稼働するかです</li>
<li>EC2の管理はやりたくないので、そこをマネージドしてくれるのがFargate</li>
</ul>
<p class="image-container"><img alt="img" src="img/7c6d141c13fa6ae9.png"></p>
<h3 is-upgraded>ECSの主要要素</h3>
<ul>
<li>クラスター：実行環境の境界線</li>
<li>サービス：タスクを維持する機能</li>
<li>タスク：タスク定義に記載された内容を実行するコンテナ群</li>
<li>タスク定義：CPU/メモリ、稼働するコンテナイメージ等、何を稼働させるのかの定義</li>
</ul>
<p class="image-container"><img alt="img" src="img/907d8c5dea096b30.png"></p>
<h2 is-upgraded>■クラスターの作成</h2>
<ul>
<li>クラスターという実行環境の境界線を作成します</li>
</ul>
<p class="image-container"><img alt="img" src="img/5ce6317e570bede.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs create-cluster \
    --cluster-name ContainerHandsOn \
    --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;cluster&#34;: {
        &#34;clusterArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:cluster/ContainerHandsOn&#34;,
        &#34;clusterName&#34;: &#34;ContainerHandsOn&#34;,
        &#34;status&#34;: &#34;ACTIVE&#34;,
        &#34;registeredContainerInstancesCount&#34;: 0,
        &#34;runningTasksCount&#34;: 0,
        &#34;pendingTasksCount&#34;: 0,
        &#34;activeServicesCount&#34;: 0,
        &#34;statistics&#34;: [],
        &#34;tags&#34;: [
            {
                &#34;key&#34;: &#34;Name&#34;,
                &#34;value&#34;: &#34;ContainerHandsOn&#34;
            }
        ],
        &#34;settings&#34;: [
            {
                &#34;name&#34;: &#34;containerInsights&#34;,
                &#34;value&#34;: &#34;disabled&#34;
            }
        ],
        &#34;capacityProviders&#34;: [],
        &#34;defaultCapacityProviderStrategy&#34;: []
    }
}
</code></pre>
<h2 is-upgraded>■タスク定義の作成</h2>
<ul>
<li>どのようなタスクが稼働するかを定義します</li>
</ul>
<p class="image-container"><img alt="img" src="img/1fd769514e68d504.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; register-task-definition.json
{
    &#34;family&#34;: &#34;ContainerHandsOn&#34;, 
    &#34;executionRoleArn&#34;: &#34;arn:aws:iam::${AccountID}:role/ecsTaskExecutionRole&#34;, 
    &#34;networkMode&#34;: &#34;awsvpc&#34;, 
    &#34;containerDefinitions&#34;: [
        {
            &#34;name&#34;: &#34;ContainerHandsOn&#34;, 
            &#34;image&#34;: &#34;${AccountID}.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;, 
            &#34;portMappings&#34;: [
                {
                    &#34;containerPort&#34;: 80, 
                    &#34;hostPort&#34;: 80, 
                    &#34;protocol&#34;: &#34;tcp&#34;
                }
            ], 
            &#34;essential&#34;: true,
            &#34;logConfiguration&#34;: {
                &#34;logDriver&#34;: &#34;awslogs&#34;,
                &#34;options&#34;: {
                    &#34;awslogs-create-group&#34;: &#34;true&#34;,
                    &#34;awslogs-group&#34;: &#34;awslogs-container-hands-on&#34;,
                    &#34;awslogs-region&#34;: &#34;ap-northeast-1&#34;,
                    &#34;awslogs-stream-prefix&#34;: &#34;hands-on&#34;
                }
            }
        }
    ], 
    &#34;requiresCompatibilities&#34;: [
        &#34;FARGATE&#34;
    ], 
    &#34;cpu&#34;: &#34;256&#34;, 
    &#34;memory&#34;: &#34;512&#34;,
    &#34;runtimePlatform&#34;: {
        &#34;cpuArchitecture&#34;: &#34;X86_64&#34;,
        &#34;operatingSystemFamily&#34;: &#34;LINUX&#34;
    }
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs register-task-definition \
  --cli-input-json file://register-task-definition.json \
  --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;taskDefinition&#34;: {
        &#34;taskDefinitionArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:task-definition/ContainerHandsOn:11&#34;,
        &#34;containerDefinitions&#34;: [
            {
                &#34;name&#34;: &#34;ContainerHandsOn&#34;,
                &#34;image&#34;: &#34;123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;,
                &#34;cpu&#34;: 0,
                &#34;portMappings&#34;: [
                    {
                        &#34;containerPort&#34;: 80,
                        &#34;hostPort&#34;: 80,
                        &#34;protocol&#34;: &#34;tcp&#34;
                    }
                ],
                &#34;essential&#34;: true,
                &#34;environment&#34;: [],
                &#34;mountPoints&#34;: [],
                &#34;volumesFrom&#34;: [],
                &#34;logConfiguration&#34;: {
                    &#34;logDriver&#34;: &#34;awslogs&#34;,
                    &#34;options&#34;: {
                        &#34;awslogs-create-group&#34;: &#34;true&#34;,
                        &#34;awslogs-group&#34;: &#34;awslogs-container-hands-on&#34;,
                        &#34;awslogs-region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;awslogs-stream-prefix&#34;: &#34;hands-on&#34;
                    }
                }
            }
        ],
        &#34;family&#34;: &#34;ContainerHandsOn&#34;,
        &#34;executionRoleArn&#34;: &#34;arn:aws:iam::123456789012:role/ecsTaskExecutionRole&#34;,
        &#34;networkMode&#34;: &#34;awsvpc&#34;,
        &#34;revision&#34;: 11,
        &#34;volumes&#34;: [],
        &#34;status&#34;: &#34;ACTIVE&#34;,
        &#34;requiresAttributes&#34;: [
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.logging-driver.awslogs&#34;
            },
            {
                &#34;name&#34;: &#34;ecs.capability.execution-role-awslogs&#34;
            },
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.ecr-auth&#34;
            },
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.docker-remote-api.1.19&#34;
            },
            {
                &#34;name&#34;: &#34;ecs.capability.execution-role-ecr-pull&#34;
            },
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.docker-remote-api.1.18&#34;
            },
            {
                &#34;name&#34;: &#34;ecs.capability.task-eni&#34;
            },
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.docker-remote-api.1.29&#34;
            }
        ],
        &#34;placementConstraints&#34;: [],
        &#34;compatibilities&#34;: [
            &#34;EC2&#34;,
            &#34;FARGATE&#34;
        ],
        &#34;runtimePlatform&#34;: {
            &#34;cpuArchitecture&#34;: &#34;X86_64&#34;,
            &#34;operatingSystemFamily&#34;: &#34;LINUX&#34;
        },
        &#34;requiresCompatibilities&#34;: [
            &#34;FARGATE&#34;
        ],
        &#34;cpu&#34;: &#34;256&#34;,
        &#34;memory&#34;: &#34;512&#34;,
        &#34;registeredAt&#34;: 1663243819.62,
        &#34;registeredBy&#34;: &#34;arn:aws:sts::123456789012:assumed-role/ContainerHandsOnForCloud9/i-0ddf413a91a008a52&#34;
    },
    &#34;tags&#34;: [
        {
            &#34;key&#34;: &#34;Name&#34;,
            &#34;value&#34;: &#34;ContainerHandsOn&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■タスク定義のリビジョン取得</h2>
<ul>
<li>タスク定義は作成する度にカウントアップされるので、最新のリビジョン番号を取得します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">RevisionNo=`aws ecs list-task-definitions \
  --family-prefix ContainerHandsOn \
  --status ACTIVE \
  --sort ASC | \
  grep ContainerHandsOn | tail -1 | sed -e &#39;s/&#34;//g&#39; | cut -f 7 --delim=&#34;:&#34;`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
RevisionNo : ${RevisionNo}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
LoadBalancersDnsName : ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148
RevisionNo : 11
</code></pre>
<h2 is-upgraded>■サービスの作成</h2>
<ul>
<li>実行数やネットワーク周りを定義したサービスを作成します</li>
</ul>
<p class="image-container"><img alt="img" src="img/fb913af7e7473432.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs create-service \
    --cluster ContainerHandsOn \
    --service-name ContainerHandsOn \
    --task-definition ContainerHandsOn:${RevisionNo} \
    --deployment-controller type=CODE_DEPLOY \
    --desired-count 2 \
    --launch-type FARGATE \
    --platform-version LATEST \
    --network-configuration &#34;awsvpcConfiguration={subnets=[${SubnetId1aPrivate},${SubnetId1cPrivate}],securityGroups=[${PrivateSecurityGroupsId}],assignPublicIp=DISABLED}&#34; \
    --load-balancers targetGroupArn=${TargetGroupArn},containerName=ContainerHandsOn,containerPort=80 
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;service&#34;: {
        &#34;serviceArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:service/ContainerHandsOn/ContainerHandsOn&#34;,
        &#34;serviceName&#34;: &#34;ContainerHandsOn&#34;,
        &#34;clusterArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:cluster/ContainerHandsOn&#34;,
        &#34;loadBalancers&#34;: [
            {
                &#34;targetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148&#34;,
                &#34;containerName&#34;: &#34;ContainerHandsOn&#34;,
                &#34;containerPort&#34;: 80
            }
        ],
        &#34;serviceRegistries&#34;: [],
        &#34;status&#34;: &#34;ACTIVE&#34;,
        &#34;desiredCount&#34;: 2,
        &#34;runningCount&#34;: 0,
        &#34;pendingCount&#34;: 0,
        &#34;launchType&#34;: &#34;FARGATE&#34;,
        &#34;platformVersion&#34;: &#34;1.4.0&#34;,
        &#34;platformFamily&#34;: &#34;Linux&#34;,
        &#34;taskDefinition&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:task-definition/ContainerHandsOn:11&#34;,
        &#34;deploymentConfiguration&#34;: {
            &#34;maximumPercent&#34;: 200,
            &#34;minimumHealthyPercent&#34;: 100
        },
        &#34;taskSets&#34;: [
            {
                &#34;id&#34;: &#34;ecs-svc/1465112757677924538&#34;,
                &#34;taskSetArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:task-set/ContainerHandsOn/ContainerHandsOn/ecs-svc/1465112757677924538&#34;,
                &#34;serviceArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:service/ContainerHandsOn&#34;,
                &#34;clusterArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:cluster/ContainerHandsOn&#34;,
                &#34;status&#34;: &#34;PRIMARY&#34;,
                &#34;taskDefinition&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:task-definition/ContainerHandsOn:11&#34;,
                &#34;computedDesiredCount&#34;: 2,
                &#34;pendingCount&#34;: 0,
                &#34;runningCount&#34;: 0,
                &#34;createdAt&#34;: 1663243874.599,
                &#34;updatedAt&#34;: 1663243874.599,
                &#34;launchType&#34;: &#34;FARGATE&#34;,
                &#34;platformVersion&#34;: &#34;1.4.0&#34;,
                &#34;platformFamily&#34;: &#34;Linux&#34;,
                &#34;networkConfiguration&#34;: {
                    &#34;awsvpcConfiguration&#34;: {
                        &#34;subnets&#34;: [
                            &#34;subnet-0d99180ac3baeb5fa&#34;,
                            &#34;subnet-0a66f1c2d5ce3b939&#34;
                        ],
                        &#34;securityGroups&#34;: [
                            &#34;sg-0f59547a1185820b5&#34;
                        ],
                        &#34;assignPublicIp&#34;: &#34;DISABLED&#34;
                    }
                },
                &#34;loadBalancers&#34;: [
                    {
                        &#34;targetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148&#34;,
                        &#34;containerName&#34;: &#34;ContainerHandsOn&#34;,
                        &#34;containerPort&#34;: 80
                    }
                ],
                &#34;serviceRegistries&#34;: [],
                &#34;scale&#34;: {
                    &#34;value&#34;: 100.0,
                    &#34;unit&#34;: &#34;PERCENT&#34;
                },
                &#34;stabilityStatus&#34;: &#34;STABILIZING&#34;,
                &#34;stabilityStatusAt&#34;: 1663243874.599,
                &#34;tags&#34;: []
            }
        ],
        &#34;deployments&#34;: [],
        &#34;roleArn&#34;: &#34;arn:aws:iam::123456789012:role/aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS&#34;,
        &#34;events&#34;: [],
        &#34;createdAt&#34;: 1663243874.599,
        &#34;placementConstraints&#34;: [],
        &#34;placementStrategy&#34;: [],
        &#34;networkConfiguration&#34;: {
            &#34;awsvpcConfiguration&#34;: {
                &#34;subnets&#34;: [
                    &#34;subnet-0d99180ac3baeb5fa&#34;,
                    &#34;subnet-0a66f1c2d5ce3b939&#34;
                ],
                &#34;securityGroups&#34;: [
                    &#34;sg-0f59547a1185820b5&#34;
                ],
                &#34;assignPublicIp&#34;: &#34;DISABLED&#34;
            }
        },
        &#34;healthCheckGracePeriodSeconds&#34;: 0,
        &#34;schedulingStrategy&#34;: &#34;REPLICA&#34;,
        &#34;deploymentController&#34;: {
            &#34;type&#34;: &#34;CODE_DEPLOY&#34;
        },
        &#34;createdBy&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForCloud9&#34;,
        &#34;enableECSManagedTags&#34;: false,
        &#34;propagateTags&#34;: &#34;NONE&#34;,
        &#34;enableExecuteCommand&#34;: false
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="動作確認１" duration="5">
        <h2 is-upgraded>■アドレス確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h2 is-upgraded>■ブラウザ確認</h2>
<ul>
<li>上記で取得されたアドレスをChromeなどのブラウザに貼り付け、以下のような表示になること</li>
<li>503エラーの場合にはデプロイ中のため、1分程度待って、リトライをお願いします</li>
<li>更新を行うと2行目のhostnameが変更されていること（ALBで負荷分散されている確認）</li>
</ul>
<h2 is-upgraded>■表示結果例</h2>
<h3 is-upgraded>パターン例１</h3>
<p class="image-container"><img alt="img" src="img/ca2bd0552b74670.png"></p>
<h3 is-upgraded>パターン例２</h3>
<p class="image-container"><img alt="img" src="img/b321ec2d09376beb.png"></p>
<h2 is-upgraded>■CloudWatch Logsの確認</h2>
<ul>
<li>上部の検索バーでCloudWatchと検索</li>
<li>CloudWatch &gt; ロググループ &gt; awslogs-container-hands-on &gt; 2つのログストリームを確認</li>
<li>&#34;ロードバランサーのアクセスログ&#34; と &#34;ブラウザアクセスログ&#34;をそれぞれのログストリームで確認</li>
</ul>
<h3 is-upgraded>画面</h3>
<ul>
<li>ログストリームを確認</li>
</ul>
<p class="image-container"><img alt="img" src="img/575c856891b5b153.png"></p>
<ul>
<li>ロードバランサーアクセスログを確認</li>
</ul>
<pre><code language="language-CloudWatch" class="language-CloudWatch">10.0.0.102 - - [09/Sep/2022:03:09:33 +0000] \
&#34;GET /index.php HTTP/1.1&#34; 200 403 &#34;-&#34; &#34;ELB-HealthChecker/2.0&#34;
</code></pre>
<ul>
<li>ブラウザアクセスログを確認</li>
</ul>
<pre><code language="language-CloudWatch" class="language-CloudWatch">10.0.0.102 - - [09/Sep/2022:03:10:00 +0000] \
&#34;GET / HTTP/1.1&#34; 200 384 &#34;-&#34; &#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="変数整理" duration="0">
        <h2 is-upgraded>■ここまで取得された変数を整理</h2>
<ul>
<li>後続のため、取得した変数をエディターに残して下さい</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
export AccountID=&#34;${AccountID}&#34;
export VpcId=&#34;${VpcId}&#34;
export SubnetId1aPublic=&#34;${SubnetId1aPublic}&#34;
export SubnetId1cPublic=&#34;${SubnetId1cPublic}&#34;
export SubnetId1aPrivate=&#34;${SubnetId1aPrivate}&#34;
export SubnetId1cPrivate=&#34;${SubnetId1cPrivate}&#34;
export InternetGatewayId=&#34;${InternetGatewayId}&#34;
export RouteTableIdPublic=&#34;${RouteTableIdPublic}&#34;
export RouteTableIdPrivate=&#34;${RouteTableIdPrivate}&#34;
export PublicSecurityGroupsId=&#34;${PublicSecurityGroupsId}&#34;
export PrivateSecurityGroupsId=&#34;${PrivateSecurityGroupsId}&#34;
export InstanceId=&#34;${InstanceId}&#34;
export LoadBalancerArn=&#34;${LoadBalancerArn}&#34;
export TargetGroupArn=&#34;${TargetGroupArn}&#34;
export LoadBalancersDnsName=&#34;${LoadBalancersDnsName}&#34;
export RevisionNo=&#34;${RevisionNo}&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export AccountID=&#34;123456789012&#34;
export VpcId=&#34;vpc-010a940bbd8f747c2&#34;
export SubnetId1aPublic=&#34;subnet-0356b36ba2daa766c&#34;
export SubnetId1cPublic=&#34;subnet-0dabe411bfdc835fb&#34;
export SubnetId1aPrivate=&#34;subnet-0d99180ac3baeb5fa&#34;
export SubnetId1cPrivate=&#34;subnet-0a66f1c2d5ce3b939&#34;
export InternetGatewayId=&#34;igw-082f42082d7748713&#34;
export RouteTableIdPublic=&#34;rtb-000a11e6eacc5c263&#34;
export RouteTableIdPrivate=&#34;rtb-077b87e7eb65d1f43&#34;
export PublicSecurityGroupsId=&#34;sg-065a7c8eceb9759d4&#34;
export PrivateSecurityGroupsId=&#34;sg-0f59547a1185820b5&#34;
export InstanceId=&#34;i-0ddf413a91a008a52&#34;
export LoadBalancerArn=&#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053&#34;
export TargetGroupArn=&#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148&#34;
export LoadBalancersDnsName=&#34;ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com&#34;
export RevisionNo=&#34;11&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodeCommit作成" duration="10">
        <h2 is-upgraded>■CodeCommitの作成</h2>
<ul>
<li>git互換のソースリポジトリであるCodeCommitを作成</li>
</ul>
<p class="image-container"><img alt="img" src="img/39d398c8ea9a7489.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws codecommit create-repository \
  --repository-name ContainerHandsOn \
  --repository-description &#34;ContainerHandsOn&#34; \
  --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;repositoryMetadata&#34;: {
        &#34;accountId&#34;: &#34;123456789012&#34;,
        &#34;repositoryId&#34;: &#34;45fe4e7e-d7bb-4e06-9ee4-9d959888be4b&#34;,
        &#34;repositoryName&#34;: &#34;ContainerHandsOn&#34;,
        &#34;repositoryDescription&#34;: &#34;ContainerHandsOn&#34;,
        &#34;lastModifiedDate&#34;: 1663244011.08,
        &#34;creationDate&#34;: 1663244011.08,
        &#34;cloneUrlHttp&#34;: &#34;https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn&#34;,
        &#34;cloneUrlSsh&#34;: &#34;ssh://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn&#34;,
        &#34;Arn&#34;: &#34;arn:aws:codecommit:ap-northeast-1:123456789012:ContainerHandsOn&#34;
    }
}
</code></pre>
<h2 is-upgraded>■CodeCommitリポジトリのクローン</h2>
<ul>
<li>git cloneでリポジトリをcloneします、中身は空です</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/
git clone https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Cloning into &#39;ContainerHandsOn&#39;...
warning: You appear to have cloned an empty repository.
</code></pre>
<h2 is-upgraded>■資材の準備</h2>
<ul>
<li>事前に作成した資材をgit管理ディレクトリにcopyします</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn
cp -p ../Dockerfile ./
cp -pr ../src ./
ls -lR
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">.:
total 8
-rw-rw-r-- 1 ec2-user ec2-user   47 Sep 15 12:01 Dockerfile
drwxrwxr-x 2 ec2-user ec2-user 4096 Sep 15 12:01 src

./src:
total 4
-rw-rw-r-- 1 ec2-user ec2-user 190 Sep 15 12:01 index.php
</code></pre>
<h2 is-upgraded>■buildspec.ymlの新規作成</h2>
<ul>
<li>CodeBuildの仕様を記述したファイルを作成します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn
cat &lt;&lt; EOF &gt; buildspec.yml
version: 0.2
phases:
  install:
    runtime-versions:
        docker: 20
        
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - docker version
      - aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin ${AccountID}.dkr.ecr.ap-northeast-1.amazonaws.com
      - RepositoryUri=${AccountID}.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on
      - ImageTag=\$(echo \$CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)

  build:
    commands:
      - echo Build started on \`date\`
      - echo Building the Docker image...          
      - docker build -t jaws-days-2022/container-hands-on .
      - docker tag jaws-days-2022/container-hands-on:latest \${RepositoryUri}:latest
      - docker tag jaws-days-2022/container-hands-on:latest \${RepositoryUri}:\${ImageTag}
      - printf &#39;{&#34;Version&#34;:&#34;1.0&#34;,&#34;ImageURI&#34;:&#34;%s&#34;}&#39; \${RepositoryUri}:\${ImageTag} &gt; imageDetail.json

  post_build:
    commands:
      - echo Build completed on \`date\`
      - echo Pushing the Docker image...
      - docker push \${RepositoryUri}:latest
      - docker push \${RepositoryUri}:\${ImageTag}

artifacts:
  files: imageDetail.json
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■buildspec.ymlの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn
ls -l buildspec.yml
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">-rw-rw-r-- 1 ec2-user ec2-user 1193 Sep 15 12:14 buildspec.yml
</code></pre>
<h2 is-upgraded>■appspec.ymlの新規作成</h2>
<ul>
<li>CodeDeployの仕様を記述したファイルを作成します</li>
<li>と記載されている箇所は後ほどCodePipelineで更新します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn
cat &lt;&lt; EOF &gt; appspec.yml
version: 0.0
Resources:
  - TargetService:
      Type: AWS::ECS::Service
      Properties:
        TaskDefinition: &#34;&lt;TASK_DEFINITION&gt;&#34;
        LoadBalancerInfo:
            ContainerName: &#34;ContainerHandsOn&#34; 
            ContainerPort: &#34;80&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■appspec.ymlの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn
ls -l appspec.yml
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">-rw-rw-r-- 1 ec2-user ec2-user 240 Sep 15 12:14 appspec.yml
</code></pre>
<h2 is-upgraded>■taskdef.jsonの新規作成</h2>
<ul>
<li>ECS Taskの仕様を記述したファイルを作成します<br></li>
<li>前半のハンズオンで作成した内容を出力しています<br></li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs describe-task-definition \
  --task-definition ContainerHandsOn:${RevisionNo} \
  --query taskDefinition &gt; taskdef.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■taskdef.jsonの変更</h2>
<p>以下の変更を行います<br> &lt;変更前&gt;</p>
<pre><code language="language-Cloud9" class="language-Cloud9">&#34;image&#34;: &#34;123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;  
</code></pre>
<p>&lt;変更後&gt;</p>
<pre><code language="language-Cloud9" class="language-Cloud9">&#34;image&#34;: &#34;&lt;IMAGE_NAME&gt;&#34;  
</code></pre>
<p>&lt;IMAGE_NAME&gt;は後述のCodePipelineにて、最新のImage URIに置換する処理が組み込まれます</p>
<h3 is-upgraded>cmd（変更前確認）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn
grep &#39;&#34;image&#34;:&#39; taskdef.json
</code></pre>
<h3 is-upgraded>result（変更前確認）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">            &#34;image&#34;: &#34;123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;,
</code></pre>
<h3 is-upgraded>cmd（変更処理＆変更後確認）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn
sed -i -e &#39;s/\&#34;image\&#34;.*/\&#34;image\&#34;: \&#34;&lt;IMAGE_NAME&gt;\&#34;,/g&#39; taskdef.json
grep &#39;&#34;image&#34;:&#39; taskdef.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">            &#34;image&#34;: &#34;&lt;IMAGE_NAME&gt;&#34;,
</code></pre>
<h2 is-upgraded>■CodeCommitへのPush</h2>
<ul>
<li>作成したファイルをCodeCommitへPushし格納します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn
git config --global user.name &#34;Your Name&#34;
git config --global user.email you@example.com

git add -A
git commit -m &#34;first commit&#34;
git push origin master
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">[master (root-commit) 15052c6] first commit
 5 files changed, 131 insertions(+)
 create mode 100644 Dockerfile
 create mode 100644 appspec.yml
 create mode 100644 buildspec.yml
 create mode 100644 src/index.php
 create mode 100644 taskdef.json

Enumerating objects: 8, done.
Counting objects: 100% (8/8), done.
Delta compression using up to 2 threads
Compressing objects: 100% (6/6), done.
Writing objects: 100% (8/8), 1.93 KiB | 1.93 MiB/s, done.
Total 8 (delta 0), reused 0 (delta 0), pack-reused 0
To https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn
 * [new branch]      master -&gt; master
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodeBuild作成" duration="10">
        <h2 is-upgraded>■CodeBuild用Role作成</h2>
<ul>
<li>CodeBuildのためにRoleを作成します。</li>
</ul>
<p class="image-container"><img alt="img" src="img/d7c15dd0de89714f.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;codebuild.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ContainerHandsOnForCodeBuild \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForCodeBuild&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFI52SKC5CK&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForCodeBuild&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-15T12:17:11Z&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;codebuild.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■CodeBuild用RoleにPolicyをアタッチ</h2>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeBuild \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeBuild \
  --policy-arn arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeBuild \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam list-attached-role-policies \
  --role-name ContainerHandsOnForCodeBuild
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;AttachedPolicies&#34;: [
        {
            &#34;PolicyName&#34;: &#34;AmazonEC2ContainerRegistryPowerUser&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser&#34;
        },
        {
            &#34;PolicyName&#34;: &#34;CloudWatchLogsFullAccess&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/CloudWatchLogsFullAccess&#34;
        },
        {
            &#34;PolicyName&#34;: &#34;AmazonS3FullAccess&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AmazonS3FullAccess&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■CodeBuild設定</h2>
<p class="image-container"><img alt="img" src="img/38073fde7f331d0c.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; codebuild-create-project.json
{
    &#34;name&#34;: &#34;ContainerHandsOn&#34;,
    &#34;source&#34;: {
        &#34;type&#34;: &#34;CODECOMMIT&#34;,
        &#34;location&#34;: &#34;https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn&#34;
    },
    &#34;sourceVersion&#34;: &#34;refs/heads/master&#34;,
    &#34;artifacts&#34;: {
        &#34;type&#34;: &#34;NO_ARTIFACTS&#34;
    },
    &#34;environment&#34;: {
        &#34;type&#34;: &#34;LINUX_CONTAINER&#34;,
        &#34;image&#34;: &#34;aws/codebuild/amazonlinux2-x86_64-standard:4.0&#34;,
        &#34;computeType&#34;: &#34;BUILD_GENERAL1_SMALL&#34;,
        &#34;privilegedMode&#34;: true
    },
    &#34;serviceRole&#34;: &#34;arn:aws:iam::${AccountID}:role/ContainerHandsOnForCodeBuild&#34;
}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■CodeBuild作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws codebuild create-project \
  --cli-input-json file://codebuild-create-project.json \
  --tags key=Name,value=ContainerHandsOn
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;project&#34;: {
        &#34;name&#34;: &#34;ContainerHandsOn&#34;,
        &#34;arn&#34;: &#34;arn:aws:codebuild:ap-northeast-1:123456789012:project/ContainerHandsOn&#34;,
        &#34;source&#34;: {
            &#34;type&#34;: &#34;CODECOMMIT&#34;,
            &#34;location&#34;: &#34;https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn&#34;,
            &#34;insecureSsl&#34;: false
        },
        &#34;sourceVersion&#34;: &#34;refs/heads/master&#34;,
        &#34;artifacts&#34;: {
            &#34;type&#34;: &#34;NO_ARTIFACTS&#34;
        },
        &#34;cache&#34;: {
            &#34;type&#34;: &#34;NO_CACHE&#34;
        },
        &#34;environment&#34;: {
            &#34;type&#34;: &#34;LINUX_CONTAINER&#34;,
            &#34;image&#34;: &#34;aws/codebuild/amazonlinux2-x86_64-standard:4.0&#34;,
            &#34;computeType&#34;: &#34;BUILD_GENERAL1_SMALL&#34;,
            &#34;environmentVariables&#34;: [],
            &#34;privilegedMode&#34;: true,
            &#34;imagePullCredentialsType&#34;: &#34;CODEBUILD&#34;
        },
        &#34;serviceRole&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForCodeBuild&#34;,
        &#34;timeoutInMinutes&#34;: 60,
        &#34;queuedTimeoutInMinutes&#34;: 480,
        &#34;encryptionKey&#34;: &#34;arn:aws:kms:ap-northeast-1:123456789012:alias/aws/s3&#34;,
        &#34;tags&#34;: [
            {
                &#34;key&#34;: &#34;Name&#34;,
                &#34;value&#34;: &#34;ContainerHandsOn&#34;
            }
        ],
        &#34;created&#34;: 1663244295.293,
        &#34;lastModified&#34;: 1663244295.293,
        &#34;badge&#34;: {
            &#34;badgeEnabled&#34;: false
        },
        &#34;projectVisibility&#34;: &#34;PRIVATE&#34;
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodeDeploy作成" duration="10">
        <h2 is-upgraded>■CodeDeploy用Role作成</h2>
<p class="image-container"><img alt="img" src="img/b6f0bfd9eb825285.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;codedeploy.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ContainerHandsOnForCodeDeploy \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForCodeDeploy&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFBSQTXUQW5&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForCodeDeploy&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-15T12:18:50Z&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;codedeploy.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■CodeDeploy用RoleにPolicyをアタッチ</h2>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeDeploy \
  --policy-arn arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeDeploy \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam list-attached-role-policies \
  --role-name ContainerHandsOnForCodeDeploy
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;AttachedPolicies&#34;: [
        {
            &#34;PolicyName&#34;: &#34;AmazonEC2ContainerRegistryPowerUser&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser&#34;
        },
        {
            &#34;PolicyName&#34;: &#34;AWSCodeDeployRoleForECS&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■アプリケーションを作成</h2>
<ul>
<li>デプロイするアプリケーションを識別する名前を定義します。</li>
</ul>
<p class="image-container"><img alt="img" src="img/560ed237dbf0d33c.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws deploy create-application \
  --application-name ContainerHandsOn \
  --compute-platform ECS \
  --tags Key=Name,Value=ContainerHandsOn
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;applicationId&#34;: &#34;600579a4-9101-4a98-8915-7fab2fed747a&#34;
}
</code></pre>
<h2 is-upgraded>■ターゲットグループの作成</h2>
<ul>
<li>ALBのターゲットグループを新規作成します。テスト用として、通常利用とは異なるポート番号を指定します。</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-target-group \
    --name ContainerHandsOn8080 \
    --protocol HTTP \
    --port 8080 \
    --target-type ip \
    --health-check-protocol HTTP \
    --health-check-port traffic-port \
    --health-check-path /index.php \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;TargetGroups&#34;: [
        {
            &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/71b573e9a3227e50&#34;,
            &#34;TargetGroupName&#34;: &#34;ContainerHandsOn8080&#34;,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;Port&#34;: 8080,
            &#34;VpcId&#34;: &#34;vpc-010a940bbd8f747c2&#34;,
            &#34;HealthCheckProtocol&#34;: &#34;HTTP&#34;,
            &#34;HealthCheckPort&#34;: &#34;traffic-port&#34;,
            &#34;HealthCheckEnabled&#34;: true,
            &#34;HealthCheckIntervalSeconds&#34;: 30,
            &#34;HealthCheckTimeoutSeconds&#34;: 5,
            &#34;HealthyThresholdCount&#34;: 5,
            &#34;UnhealthyThresholdCount&#34;: 2,
            &#34;HealthCheckPath&#34;: &#34;/index.php&#34;,
            &#34;Matcher&#34;: {
                &#34;HttpCode&#34;: &#34;200&#34;
            },
            &#34;TargetType&#34;: &#34;ip&#34;,
            &#34;ProtocolVersion&#34;: &#34;HTTP1&#34;,
            &#34;IpAddressType&#34;: &#34;ipv4&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■ターゲットグループのARN取得</h2>
<ul>
<li>上記で作成したターゲットグループのARNを取得します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">TargetGroupArn8080=`aws elbv2 describe-target-groups \
  --names ContainerHandsOn8080 \
  --query &#34;TargetGroups[*].TargetGroupArn&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
RevisionNo : ${RevisionNo}
TargetGroupArn8080 : ${TargetGroupArn8080}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
LoadBalancersDnsName : ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148
RevisionNo : 11
TargetGroupArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/71b573e9a3227e50
</code></pre>
<h2 is-upgraded>■リスナーの作成</h2>
<ul>
<li>ALBに対する接続リクエストを追加します。8080ポートでテスト用として受け口となるリスナーです。</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-listener \
    --load-balancer-arn ${LoadBalancerArn} \
    --protocol HTTP \
    --port 8080 \
    --default-actions Type=forward,TargetGroupArn=${TargetGroupArn8080}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Listeners&#34;: [
        {
            &#34;ListenerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/b392eaa096f09053/b27b8d32f0e78f30&#34;,
            &#34;LoadBalancerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053&#34;,
            &#34;Port&#34;: 8080,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;DefaultActions&#34;: [
                {
                    &#34;Type&#34;: &#34;forward&#34;,
                    &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/71b573e9a3227e50&#34;,
                    &#34;ForwardConfig&#34;: {
                        &#34;TargetGroups&#34;: [
                            {
                                &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/71b573e9a3227e50&#34;,
                                &#34;Weight&#34;: 1
                            }
                        ],
                        &#34;TargetGroupStickinessConfig&#34;: {
                            &#34;Enabled&#34;: false
                        }
                    }
                }
            ]
        }
    ]
}
</code></pre>
<h2 is-upgraded>■リスナーのARN取得</h2>
<ul>
<li>リスナーのARNを取得します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">ListenerArn=`aws elbv2 describe-listeners \
    --load-balancer-arn ${LoadBalancerArn} \
    --query &#34;Listeners[*].[Port,ListenerArn]&#34; \
    --output text | grep &#34;^80\s&#34; | cut -f 2`
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">ListenerArn8080=`aws elbv2 describe-listeners \
    --load-balancer-arn ${LoadBalancerArn} \
    --query &#34;Listeners[*].[Port,ListenerArn]&#34; \
    --output text | grep &#34;^8080&#34; | cut -f 2`
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
RevisionNo : ${RevisionNo}
TargetGroupArn8080 : ${TargetGroupArn8080}
ListenerArn : ${ListenerArn}
ListenerArn8080 : ${ListenerArn8080}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
LoadBalancersDnsName : ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148
RevisionNo : 11
TargetGroupArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/71b573e9a3227e50
ListenerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/b392eaa096f09053/b5d7e272d5152d8d
ListenerArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/b392eaa096f09053/b27b8d32f0e78f30
</code></pre>
<h2 is-upgraded>■PublicSubnetのインバウンドルールを追加</h2>
<ul>
<li>リスナーとして8080ポートを追加するので、セキュリティグループにも8080ポートを許可します</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 authorize-security-group-ingress \
    --group-id ${PublicSecurityGroupsId} \
    --protocol tcp \
    --port 8080 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-01d5cd037c7937b18&#34;,
            &#34;GroupId&#34;: &#34;sg-065a7c8eceb9759d4&#34;,
            &#34;GroupOwnerId&#34;: &#34;123456789012&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 8080,
            &#34;ToPort&#34;: 8080,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■デプロイグループの作成</h2>
<ul>
<li>デプロイ環境の定義を行います</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; create-deployment-group.json
{
    &#34;applicationName&#34;: &#34;ContainerHandsOn&#34;,
    &#34;deploymentGroupName&#34;: &#34;ContainerHandsOn&#34;,
    &#34;deploymentConfigName&#34;: &#34;CodeDeployDefault.ECSAllAtOnce&#34;,
    &#34;serviceRoleArn&#34;: &#34;arn:aws:iam::${AccountID}:role/ContainerHandsOnForCodeDeploy&#34;,
    &#34;deploymentStyle&#34;: {
        &#34;deploymentType&#34;: &#34;BLUE_GREEN&#34;,
        &#34;deploymentOption&#34;: &#34;WITH_TRAFFIC_CONTROL&#34;
    },
    &#34;blueGreenDeploymentConfiguration&#34;: {
        &#34;terminateBlueInstancesOnDeploymentSuccess&#34;: {
            &#34;action&#34;: &#34;TERMINATE&#34;,
            &#34;terminationWaitTimeInMinutes&#34;: 60
        },
        &#34;deploymentReadyOption&#34;: {
            &#34;actionOnTimeout&#34;: &#34;STOP_DEPLOYMENT&#34;,
            &#34;waitTimeInMinutes&#34;: 60
        }
    },
    &#34;loadBalancerInfo&#34;: {
        &#34;targetGroupPairInfoList&#34;: [
            {
                &#34;targetGroups&#34;: [
                    {
                        &#34;name&#34;: &#34;ContainerHandsOn&#34;
                    },
                    {
                        &#34;name&#34;: &#34;ContainerHandsOn8080&#34;
                    }
                ],
                &#34;prodTrafficRoute&#34;: {
                    &#34;listenerArns&#34;: [
                        &#34;${ListenerArn}&#34;
                    ]
                },
                &#34;testTrafficRoute&#34;: {
                    &#34;listenerArns&#34;: [
                        &#34;${ListenerArn8080}&#34;
                    ]
                }
            }
        ]
    },
    &#34;ecsServices&#34;: [
        {
            &#34;serviceName&#34;: &#34;ContainerHandsOn&#34;,
            &#34;clusterName&#34;: &#34;ContainerHandsOn&#34;
        }
    ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws deploy create-deployment-group \
  --cli-input-json file://create-deployment-group.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;deploymentGroupId&#34;: &#34;78905a92-a80f-4ac5-8b0f-fcb52b042b58&#34;
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodePipeline作成" duration="10">
        <h2 is-upgraded>■CodePipeline用Role作成</h2>
<p class="image-container"><img alt="img" src="img/1fe36997a007e059.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;codepipeline.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ContainerHandsOnForPipeLine \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForPipeLine&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFGCB5OQPDX&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForPipeLine&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-15T12:22:42Z&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;codepipeline.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■CodePipeline用RoleにPolicyをアタッチ</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; InlinePolicy.json
{
    &#34;Statement&#34;: [
        {
            &#34;Action&#34;: [
                &#34;iam:PassRole&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Condition&#34;: {
                &#34;StringEqualsIfExists&#34;: {
                    &#34;iam:PassedToService&#34;: [
                        &#34;cloudformation.amazonaws.com&#34;,
                        &#34;elasticbeanstalk.amazonaws.com&#34;,
                        &#34;ec2.amazonaws.com&#34;,
                        &#34;ecs-tasks.amazonaws.com&#34;
                    ]
                }
            }
        },
        {
            &#34;Action&#34;: [
                &#34;codecommit:CancelUploadArchive&#34;,
                &#34;codecommit:GetBranch&#34;,
                &#34;codecommit:GetCommit&#34;,
                &#34;codecommit:GetRepository&#34;,
                &#34;codecommit:GetUploadArchiveStatus&#34;,
                &#34;codecommit:UploadArchive&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;codedeploy:CreateDeployment&#34;,
                &#34;codedeploy:GetApplication&#34;,
                &#34;codedeploy:GetApplicationRevision&#34;,
                &#34;codedeploy:GetDeployment&#34;,
                &#34;codedeploy:GetDeploymentConfig&#34;,
                &#34;codedeploy:RegisterApplicationRevision&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;codestar-connections:UseConnection&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;elasticbeanstalk:*&#34;,
                &#34;ec2:*&#34;,
                &#34;elasticloadbalancing:*&#34;,
                &#34;autoscaling:*&#34;,
                &#34;cloudwatch:*&#34;,
                &#34;s3:*&#34;,
                &#34;sns:*&#34;,
                &#34;cloudformation:*&#34;,
                &#34;rds:*&#34;,
                &#34;sqs:*&#34;,
                &#34;ecs:*&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;lambda:InvokeFunction&#34;,
                &#34;lambda:ListFunctions&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;opsworks:CreateDeployment&#34;,
                &#34;opsworks:DescribeApps&#34;,
                &#34;opsworks:DescribeCommands&#34;,
                &#34;opsworks:DescribeDeployments&#34;,
                &#34;opsworks:DescribeInstances&#34;,
                &#34;opsworks:DescribeStacks&#34;,
                &#34;opsworks:UpdateApp&#34;,
                &#34;opsworks:UpdateStack&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;cloudformation:CreateStack&#34;,
                &#34;cloudformation:DeleteStack&#34;,
                &#34;cloudformation:DescribeStacks&#34;,
                &#34;cloudformation:UpdateStack&#34;,
                &#34;cloudformation:CreateChangeSet&#34;,
                &#34;cloudformation:DeleteChangeSet&#34;,
                &#34;cloudformation:DescribeChangeSet&#34;,
                &#34;cloudformation:ExecuteChangeSet&#34;,
                &#34;cloudformation:SetStackPolicy&#34;,
                &#34;cloudformation:ValidateTemplate&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;codebuild:BatchGetBuilds&#34;,
                &#34;codebuild:StartBuild&#34;,
                &#34;codebuild:BatchGetBuildBatches&#34;,
                &#34;codebuild:StartBuildBatch&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;devicefarm:ListProjects&#34;,
                &#34;devicefarm:ListDevicePools&#34;,
                &#34;devicefarm:GetRun&#34;,
                &#34;devicefarm:GetUpload&#34;,
                &#34;devicefarm:CreateUpload&#34;,
                &#34;devicefarm:ScheduleRun&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;servicecatalog:ListProvisioningArtifacts&#34;,
                &#34;servicecatalog:CreateProvisioningArtifact&#34;,
                &#34;servicecatalog:DescribeProvisioningArtifact&#34;,
                &#34;servicecatalog:DeleteProvisioningArtifact&#34;,
                &#34;servicecatalog:UpdateProduct&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;cloudformation:ValidateTemplate&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;ecr:DescribeImages&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;states:DescribeExecution&#34;,
                &#34;states:DescribeStateMachine&#34;,
                &#34;states:StartExecution&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;appconfig:StartDeployment&#34;,
                &#34;appconfig:StopDeployment&#34;,
                &#34;appconfig:GetDeployment&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        }
    ],
    &#34;Version&#34;: &#34;2012-10-17&#34;
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam put-role-policy \
  --role-name ContainerHandsOnForPipeLine \
  --policy-name InlinePolicy \
  --policy-document file://InlinePolicy.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■artifactStoreとしてS3を作成</h2>
<p class="image-container"><img alt="img" src="img/e06348f6ae86238b.png"></p>
<h3 is-upgraded>cmd</h3>
<aside class="special"><p>あなたのフルネームを記載下さい、英語小文字でお願いします</p>
</aside>
<pre><code language="language-Cloud9" class="language-Cloud9">YourName=shigeru-oda
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">S3Name=${YourName}-container-handson-`date +&#34;%Y%m%d%H%M%S&#34;`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccountID : ${AccountID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
RevisionNo : ${RevisionNo}
TargetGroupArn8080 : ${TargetGroupArn8080}
ListenerArn : ${ListenerArn}
ListenerArn8080 : ${ListenerArn8080}
S3Name : ${S3Name}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccountID : 123456789012
VpcId : vpc-010a940bbd8f747c2
SubnetId1aPublic : subnet-0356b36ba2daa766c
SubnetId1cPublic : subnet-0dabe411bfdc835fb
SubnetId1aPrivate : subnet-0d99180ac3baeb5fa
SubnetId1cPrivate : subnet-0a66f1c2d5ce3b939
InternetGatewayId : igw-082f42082d7748713
RouteTableIdPublic : rtb-000a11e6eacc5c263
RouteTableIdPrivate : rtb-077b87e7eb65d1f43
PublicSecurityGroupsId : sg-065a7c8eceb9759d4
PrivateSecurityGroupsId : sg-0f59547a1185820b5
InstanceId : i-0ddf413a91a008a52
LoadBalancersDnsName : ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/b392eaa096f09053
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/b2da630c91ed7148
RevisionNo : 11
TargetGroupArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/71b573e9a3227e50
ListenerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/b392eaa096f09053/b5d7e272d5152d8d
ListenerArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/b392eaa096f09053/b27b8d32f0e78f30
S3Name : shigeru-oda-container-handson-20220915122328
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws s3 mb s3://${S3Name}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">make_bucket: shigeru-oda-container-handson-20220920055436
</code></pre>
<h2 is-upgraded>■CodePipelineを作成</h2>
<p class="image-container"><img alt="img" src="img/99e49b6290818cc8.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; create-pipeline.json
{
    &#34;pipeline&#34;: {
        &#34;name&#34;: &#34;ContainerHandsOn&#34;,
        &#34;roleArn&#34;: &#34;arn:aws:iam::`echo ${AccountID}`:role/ContainerHandsOnForPipeLine&#34;,
        &#34;artifactStore&#34;: {
            &#34;type&#34;: &#34;S3&#34;,
            &#34;location&#34;: &#34;`echo ${S3Name}`&#34;
        },
        &#34;stages&#34;: [
            {
                &#34;name&#34;: &#34;Source&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Source&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Source&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeCommit&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;BranchName&#34;: &#34;master&#34;,
                            &#34;OutputArtifactFormat&#34;: &#34;CODE_ZIP&#34;,
                            &#34;PollForSourceChanges&#34;: &#34;false&#34;,
                            &#34;RepositoryName&#34;: &#34;ContainerHandsOn&#34;
                        },
                        &#34;outputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;inputArtifacts&#34;: [],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;SourceVariables&#34;
                    }
                ]
            },
            {
                &#34;name&#34;: &#34;Build&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Build&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Build&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeBuild&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;ProjectName&#34;: &#34;ContainerHandsOn&#34;
                        },
                        &#34;outputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;BuildArtifact&#34;
                            }
                        ],
                        &#34;inputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;BuildVariables&#34;
                    }
                ]
            },
            {
                &#34;name&#34;: &#34;Deploy&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Deploy&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Deploy&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeDeployToECS&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;AppSpecTemplateArtifact&#34;: &#34;SourceArtifact&#34;,
                            &#34;ApplicationName&#34;: &#34;ContainerHandsOn&#34;,
                            &#34;DeploymentGroupName&#34;: &#34;ContainerHandsOn&#34;,
                            &#34;Image1ArtifactName&#34;: &#34;BuildArtifact&#34;,
                            &#34;Image1ContainerName&#34;: &#34;IMAGE_NAME&#34;,
                            &#34;TaskDefinitionTemplateArtifact&#34;: &#34;SourceArtifact&#34;
                        },
                        &#34;outputArtifacts&#34;: [],
                        &#34;inputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;BuildArtifact&#34;
                            },
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;DeployVariables&#34;
                    }
                ]
            }
        ],
        &#34;version&#34;: 1
    }
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws codepipeline create-pipeline --cli-input-json file://create-pipeline.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;pipeline&#34;: {
        &#34;name&#34;: &#34;ContainerHandsOn&#34;,
        &#34;roleArn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForPipeLine&#34;,
        &#34;artifactStore&#34;: {
            &#34;type&#34;: &#34;S3&#34;,
            &#34;location&#34;: &#34;shigeru-oda-container-handson-20220915122328&#34;
        },
        &#34;stages&#34;: [
            {
                &#34;name&#34;: &#34;Source&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Source&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Source&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeCommit&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;BranchName&#34;: &#34;master&#34;,
                            &#34;OutputArtifactFormat&#34;: &#34;CODE_ZIP&#34;,
                            &#34;PollForSourceChanges&#34;: &#34;false&#34;,
                            &#34;RepositoryName&#34;: &#34;ContainerHandsOn&#34;
                        },
                        &#34;outputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;inputArtifacts&#34;: [],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;SourceVariables&#34;
                    }
                ]
            },
            {
                &#34;name&#34;: &#34;Build&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Build&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Build&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeBuild&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;ProjectName&#34;: &#34;ContainerHandsOn&#34;
                        },
                        &#34;outputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;BuildArtifact&#34;
                            }
                        ],
                        &#34;inputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;BuildVariables&#34;
                    }
                ]
            },
            {
                &#34;name&#34;: &#34;Deploy&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Deploy&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Deploy&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeDeployToECS&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;AppSpecTemplateArtifact&#34;: &#34;SourceArtifact&#34;,
                            &#34;ApplicationName&#34;: &#34;ContainerHandsOn&#34;,
                            &#34;DeploymentGroupName&#34;: &#34;ContainerHandsOn&#34;,
                            &#34;Image1ArtifactName&#34;: &#34;BuildArtifact&#34;,
                            &#34;Image1ContainerName&#34;: &#34;IMAGE_NAME&#34;,
                            &#34;TaskDefinitionTemplateArtifact&#34;: &#34;SourceArtifact&#34;
                        },
                        &#34;outputArtifacts&#34;: [],
                        &#34;inputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;BuildArtifact&#34;
                            },
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;DeployVariables&#34;
                    }
                ]
            }
        ],
        &#34;version&#34;: 1
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="動作確認２−１（Blue/Green Deployの確認）" duration="15">
        <h2 is-upgraded>■CodePipelineの流れ</h2>
<p class="image-container"><img alt="img" src="img/51af4b273c2f60d.png"></p>
<h2 is-upgraded>■Bule/Greenデプロイの流れ</h2>
<ul>
<li>参考元：<a href="https://www.slideshare.net/AmazonWebServicesJapan/20190731-black-belt-online-seminar-amazon-ecs-deep-dive-162160987" target="_blank">20190731 Black Belt Online Seminar Amazon ECS Deep Dive</a><img alt="img" src="img/b95d2baad2f7a5cd.png"><img alt="img" src="img/7825aed5ef52e498.png"><img alt="img" src="img/32b3107414e63ec.png"></li>
</ul>
<h2 is-upgraded>■AWS コンソールでCodePipelineを検索</h2>
<ul>
<li>上部の検索バーでCodePipelineと検索</li>
<li>パイプラインの画面が表示されるのでContainerHandsOnを選択</li>
<li>Source、Buildが「成功しました」と表示されるまで暫く待機</li>
<li>Deployが「進行中」になった段階で「詳細」ボタン押下 <img alt="img" src="img/46d94b4271bd7d0c.png"><img alt="img" src="img/5b09f59782be46ac.png"></li>
<li>Step1でGreen（置換）に対してタスクセットのデプロイが動きます</li>
<li>Step2でGreen（置換）に対してトラフィックをルーティングします</li>
<li>Step3で待機状態になることを確認します <img alt="img" src="img/9486bc7742ede2a9.png"></li>
<li>上部の検索バーで「ECS」と検索</li>
<li>クラスター一覧の画面が表示されるのでContainerHandsOnを選択</li>
<li>タスクTABを選択</li>
<li>リビジョンが異なる2 * 2のタスクが稼働していることが確認できます。 <img alt="img" src="img/ace61c77d8158a6.png"></li>
</ul>
<h2 is-upgraded>■アドレス確認 Blue（オリジナル）</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h3 is-upgraded>画面</h3>
<ul>
<li>上記で取得されたアドレスをChromeなどのブラウザに貼り付け、以下のような表示になること</li>
<li>ブラウザを更新すると２種類のタスクが確認できます</li>
<li>パターン１</li>
</ul>
<p class="image-container"><img alt="img" src="img/df5db472483e1c4d.png"></p>
<ul>
<li>パターン２</li>
</ul>
<p class="image-container"><img alt="img" src="img/72c2ec54b62ebef7.png"></p>
<h2 is-upgraded>■アドレス確認 Green（置換）</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}:8080
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com:8080
</code></pre>
<h3 is-upgraded>画面</h3>
<ul>
<li>上記で取得されたアドレスをChromeなどのブラウザに貼り付け、以下のような表示になること</li>
<li>ブラウザを更新すると先ほどとは異なる２種類のタスクが確認できます</li>
<li>パターン１</li>
</ul>
<p class="image-container"><img alt="img" src="img/18e082d29fb3baa3.png"></p>
<ul>
<li>パターン２</li>
</ul>
<p class="image-container"><img alt="img" src="img/b5ef7619890cf00b.png"></p>
<h2 is-upgraded>■Blue/Greenの置換</h2>
<h3 is-upgraded>画面</h3>
<ul>
<li>CodeDeployの画面に戻ります</li>
<li>「トラフィックの再ルーティング」ボタン押下</li>
</ul>
<p class="image-container"><img alt="img" src="img/c168b60387e8450.png"></p>
<ul>
<li>Step3での待機が完了します</li>
<li>Step4でBlue/Greenの入れ替えが行われます。</li>
<li>Step5で待機状態になることを確認します <img alt="img" src="img/90f25fd1205121da.png"></li>
<li>「元のタスクセットの終了」ボタン押下 <img alt="img" src="img/5b1005445505d2c5.png"></li>
<li>Step5での待機が完了します</li>
<li>Step6で元のタスクセットの終了されます <img alt="img" src="img/6f302dbfce602040.png"></li>
</ul>
<h2 is-upgraded>■Blue/Greenの置換後</h2>
<h3 is-upgraded>画面</h3>
<ul>
<li>再度ECSの画面に戻るとタスクで古いリビジョンが削除されていることが確認できます。</li>
</ul>
<p class="image-container"><img alt="img" src="img/872056b5a68af147.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="EventBridge作成" duration="5">
        <h2 is-upgraded>■EventBridge用Role作成</h2>
<p class="image-container"><img alt="img" src="img/c793d9e2bdf5e0f4.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Principal&#34;: {
                &#34;Service&#34;: &#34;events.amazonaws.com&#34;
            },
            &#34;Action&#34;: &#34;sts:AssumeRole&#34;
        }
    ]
}
EOF
</code></pre>
<pre><code>aws iam create-role \
  --role-name ContainerHandsOnForEventBridge \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForEventBridge&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFOJWCZEAQ3&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForEventBridge&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-15T12:51:00Z&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;events.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■EventBridge用RoleにPolicyをアタッチ</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
cat &lt;&lt; EOF &gt; InlinePolicy.json
{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;codepipeline:StartPipelineExecution&#34;
            ],
            &#34;Resource&#34;: [
                &#34;arn:aws:codepipeline:ap-northeast-1:${AccountID}:*&#34;
            ]
        }
    ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam put-role-policy \
  --role-name ContainerHandsOnForEventBridge \
  --policy-name InlinePolicy \
  --policy-document file://InlinePolicy.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■EventBridgeを作成</h2>
<p class="image-container"><img alt="img" src="img/d21e2ea946b1146b.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws events put-rule \
  --name &#34;ContainerHandsOn&#34; \
  --state &#34;ENABLED&#34; \
  --description &#34;ContainerHandsOn&#34; \
  --event-bus-name &#34;default&#34; \
  --event-pattern &#34;{ \
    \&#34;source\&#34;:[\&#34;aws.codecommit\&#34;], \
    \&#34;detail-type\&#34;:[\&#34;CodeCommit Repository State Change\&#34;], \
    \&#34;resources\&#34;:[\&#34;arn:aws:codecommit:ap-northeast-1:${AccountID}:ContainerHandsOn\&#34;], \
    \&#34;detail\&#34;:{ \
        \&#34;event\&#34;:[\&#34;referenceCreated\&#34;,\&#34;referenceUpdated\&#34;], \
        \&#34;referenceType\&#34;: [\&#34;branch\&#34;], \
        \&#34;referenceName\&#34;:[\&#34;master\&#34;] \
    } \
  }&#34; \
  --role-arn &#34;arn:aws:iam::${AccountID}:role/ContainerHandsOnForEventBridge&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;RuleArn&#34;: &#34;arn:aws:events:ap-northeast-1:123456789012:rule/ContainerHandsOn&#34;
}
</code></pre>
<h2 is-upgraded>■targetを作成</h2>
<p class="image-container"><img alt="img" src="img/85d398d7114cad00.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws events put-targets \
  --rule ContainerHandsOn \
  --targets &#34;Id&#34;=&#34;1&#34;,&#34;Arn&#34;=&#34;arn:aws:codepipeline:ap-northeast-1:${AccountID}:ContainerHandsOn&#34;,&#34;RoleArn&#34;=&#34;arn:aws:iam::${AccountID}:role/ContainerHandsOnForEventBridge&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;FailedEntryCount&#34;: 0,
    &#34;FailedEntries&#34;: []
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="動作確認２−２（Codeシリーズを利用）" duration="10">
        <h2 is-upgraded>■CodePipelineの流れ</h2>
<p class="image-container"><img alt="img" src="img/ababf706ffdf491f.png"></p>
<h2 is-upgraded>■srcの変更</h2>
<ul>
<li>Cloud9上で「/home/ec2-user/environment/ContainerHandsOn/src/index.php」を変更する</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn/src
cat &lt;&lt; EOF &gt; index.php
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;ja&#34;&gt;
  &lt;head&gt;
    &lt;title&gt;Hello! Jaws Days 2022!!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Hello! Jaws Days 2022!!&lt;/p&gt;
    &lt;p&gt;CICD ContainerHandsOn!!!&lt;/p&gt;
    &lt;?php echo gethostname(); ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">git diff index.php
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">diff --git a/src/index.php b/src/index.php
index 3e2ebff..d408a39 100644
--- a/src/index.php
+++ b/src/index.php
@@ -5,6 +5,7 @@
   &lt;/head&gt;
   &lt;body&gt;
     &lt;p&gt;Hello! Jaws Days 2022!!&lt;/p&gt;
+    &lt;p&gt;CICD ContainerHandsOn!!!&lt;/p&gt;
     &lt;?php echo gethostname(); ?&gt;
   &lt;/body&gt;
 &lt;/html&gt;
</code></pre>
<h2 is-upgraded>■git操作</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">git add ./index.php
git commit -m &#34;CICD TEST&#34;
git push
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">[master e2743e5] CICD TEST
 1 file changed, 1 insertion(+)

Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 2 threads
Compressing objects: 100% (3/3), done.
Writing objects: 100% (4/4), 362 bytes | 362.00 KiB/s, done.
Total 4 (delta 2), reused 0 (delta 0), pack-reused 0
To https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn
   15052c6..e2743e5  master -&gt; master
</code></pre>
<h2 is-upgraded>■CodePipeline確認</h2>
<h2 is-upgraded>画面</h2>
<ul>
<li>git操作でCodePipelineが稼働することを確認する</li>
<li>Deployの詳細ボタンを選択する</li>
</ul>
<p class="image-container"><img alt="img" src="img/f9b856f1b85b8e71.png"><img alt="img" src="img/2b20bdad4ba63bab.png"></p>
<ul>
<li>ステップ１・２が完了済みであることを確認 <img alt="img" src="img/c79e29819a113eb5.png"></li>
</ul>
<h2 is-upgraded>■アドレス確認</h2>
<ul>
<li>Blue（オリジナル）でのアクセスを確認する</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h2 is-upgraded>■画面</h2>
<p class="image-container"><img alt="img" src="img/22f9cf18ab812ebe.png"></p>
<h2 is-upgraded>■アドレス確認</h2>
<ul>
<li>Green（置換）でのアクセスを確認する</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}&#34;:8080&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-681708310.ap-northeast-1.elb.amazonaws.com:8080
</code></pre>
<h2 is-upgraded>■画面</h2>
<ul>
<li>CICD ContainerHandsOn!!!と表示されていることを確認 <img alt="img" src="img/ee1b479bda31dfd5.png"></li>
</ul>
<h2 is-upgraded>■トラフィックの再ルーティング</h2>
<ul>
<li>「トラフィックの再ルーティング」ボタンを押下 <img alt="img" src="img/c79e29819a113eb5.png"></li>
<li>ステップ３・４が完了済みであることを確認 <img alt="img" src="img/845c0340c12e25cd.png"></li>
</ul>
<h2 is-upgraded>■アドレス確認</h2>
<ul>
<li>オリジナルのアドレスで更新後の内容に変更されていることを確認する</li>
</ul>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h2 is-upgraded>■画面</h2>
<p class="image-container"><img alt="img" src="img/ee1b479bda31dfd5.png"></p>
<h2 is-upgraded>■元のタスクセットの終了</h2>
<ul>
<li>「元のタスクセットの終了」ボタンを押下 <img alt="img" src="img/845c0340c12e25cd.png"></li>
</ul>
<h2 is-upgraded>■画面</h2>
<ul>
<li>全ての処理が終了する <img alt="img" src="img/a03d761455cd92eb.png"></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="片付け" duration="10">
        <ul>
<li>削除部分はGUIで対応します</li>
<li>CLIが苦手な方も削除漏れにより課金が発生しないように確認をお願いします</li>
</ul>
<h2 is-upgraded>■CodePipeline</h2>
<ul>
<li>パイプライン &gt; ContainerHandsOn &gt; パイプラインを削除する</li>
</ul>
<h2 is-upgraded>■CodeDeploy</h2>
<ul>
<li>アプリケーション &gt; ContainerHandsOn &gt; アプリケーションの削除</li>
</ul>
<h2 is-upgraded>■CodeBuild</h2>
<ul>
<li>ビルドプロジェクト &gt; ContainerHandsOn &gt; ビルドプロジェクトの削除</li>
<li>ビルド履歴 &gt; 検索バーに「ContainerHandsOn」 &gt; ビルドの削除</li>
</ul>
<h2 is-upgraded>■CodeCommit</h2>
<ul>
<li>リポジトリ &gt; ContainerHandsOn &gt; リポジトリの削除</li>
</ul>
<h2 is-upgraded>■EventBridge</h2>
<ul>
<li>ルール &gt; ContainerHandsOn &gt; 削除</li>
</ul>
<h2 is-upgraded>■Cloud9</h2>
<ul>
<li>Your environments &gt; ContainerHandsOn &gt; Delete</li>
</ul>
<h2 is-upgraded>■ECS</h2>
<ul>
<li>タスク定義 &gt; ContainerHandsOn &gt; 全てのリビジョンを１つずつ登録解除</li>
<li>クラスター &gt; ContainerHandsOn &gt; サービスTAB &gt; ContainerHandsOn &gt; サービスを削除(強制削除)</li>
<li>クラスター &gt; ContainerHandsOn &gt; タスクTAB &gt; 実行中タスクを選択 &gt; 停止</li>
<li>クラスター &gt; ContainerHandsOn &gt; クラスターの削除</li>
</ul>
<h2 is-upgraded>■VPC（エンドポイント）</h2>
<ul>
<li>エンドポイント &gt; ContainerHandsOnの4行 &gt; アクション &gt; 削除<br> （削除に数分時間を要しますが、お待ちください）</li>
</ul>
<h2 is-upgraded>■EC2</h2>
<ul>
<li>ロードバランサー &gt; ContainerHandsOn &gt; リスナーTAB &gt; 2行削除</li>
<li>ロードバランサー &gt; ContainerHandsOn &gt; アクション &gt; 削除</li>
<li>ターゲットグループ &gt; ContainerHandsOn &gt; アクション &gt; 削除</li>
<li>ターゲットグループ &gt; ContainerHandsOn8080 &gt; アクション &gt; 削除</li>
<li>セキュリティグループ &gt; ContainerHandsOn-PrivateSecurityGroup &gt; インバウンドルール &gt; インバウンドのルールを編集 &gt; 2行削除</li>
<li>セキュリティグループ &gt; ContainerHandsOn-PublicSecurityGroup &gt; インバウンドルール &gt; インバウンドのルールを編集 &gt; 2行削除</li>
</ul>
<h2 is-upgraded>■VPC（VPCの削除）</h2>
<ul>
<li>お使いのVPC &gt; ContainerHandsOn &gt; アクション &gt; VPCの削除</li>
</ul>
<h2 is-upgraded>■Elastic Container Registry</h2>
<ul>
<li>リポジトリ &gt; jaws-days-2022/container-hands-on &gt; 削除</li>
</ul>
<h2 is-upgraded>■S3</h2>
<ul>
<li>バケット &gt; ${YourName}-container-handson-yyymmddhh24miss &gt; 空にする</li>
<li>バケット &gt; ${YourName}-container-handson-yyymmddhh24miss &gt; 削除</li>
</ul>
<h2 is-upgraded>■CloudWatch</h2>
<ul>
<li>ロググループ &gt; awslogs-container-hands-on &gt; アクション &gt; ロググループの削除</li>
<li>ロググループ &gt; /aws/codebuild/ContainerHandsOn &gt; アクション &gt; ロググループの削除</li>
</ul>
<h2 is-upgraded>■IAM</h2>
<ul>
<li>ロール &gt; ContainerHandsOnForCloud9 &gt; 削除</li>
<li>ロール &gt; ContainerHandsOnForCodeBuild &gt; 削除</li>
<li>ロール &gt; ContainerHandsOnForCodeDeploy &gt; 削除</li>
<li>ロール &gt; ContainerHandsOnForPipeLine &gt; 削除</li>
<li>ロール &gt; ContainerHandsOnForEventBridge &gt; 削除</li>
</ul>
<h2 is-upgraded>■IAM（任意）</h2>
<ul>
<li>ロール &gt; ecsTaskExecutionRole &gt; 削除<br></li>
</ul>
<p>ecsTaskExecutionRoleは、画面コンソールでのECSのタスク定義作成時に、「新しいロールの作成」を選択する自動的に作成されます。今後もECSサービスを利用するのであれば、残しておいても問題ないです。<br><a href="https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task_execution_IAM_role.html" target="_blank">Amazon ECS タスク実行IAM ロール</a></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
