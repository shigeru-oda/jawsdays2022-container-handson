
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="docs"
                  title="[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="はじめに" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="VPC作成" duration="5">
        <h2 is-upgraded>■CloudShellの起動</h2>
<p class="image-container"><img alt="img" src="img/1bbb070a4cf9999c.png"><img alt="img" src="img/9b0f4ff0313865b9.png"></p>
<h2 is-upgraded>■VPCの作成</h2>
<p>VPCを新規に作成します。</p>
<h3 is-upgraded>cmd</h3>
<p>CloudShellに以下cmdをCopy &amp; Paste</p>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-vpc \
    --cidr-block 10.0.0.0/16 \
    --tag-specification &#34;ResourceType=vpc,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<p>CloudShellに以下のような結果が返却されていることを確認下さい。ID等は個人個人異なります。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">xx
</code></pre>
<h3 is-upgraded>変数設定</h3>
<p>VPC IDを取得します、CloudShellに以下cmdをCopy &amp; Paste。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId=`aws ec2 describe-vpcs \
    --query &#39;Vpcs[*].VpcId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
VpcId : ${VpcId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<p>IDが取得されていることを確認。ID等は個人個人異なります。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId : vpc-08a77289b9b351429
</code></pre>
<h2 is-upgraded>■Subnetの作成</h2>
<p>作成したVPCの中にSubnetを4つ作成します。 Private Subnetが2つ、Public Subnetが2つです。</p>
<h3 is-upgraded>cmd1</h3>
<p>Subnetの1つ目を作成します。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.0.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<p>CloudShellに以下のような結果が返却されていることを確認下さい。ID等は個人個人異なります。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">xxx
</code></pre>
<h3 is-upgraded>cmd2</h3>
<p>Subnetの2つ目を作成します。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.1.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result2</h3>
<p>CloudShellに以下のような結果が返却されていることを確認下さい。ID等は個人個人異なります。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">xxx
</code></pre>
<h3 is-upgraded>cmd3</h3>
<p>Subnetの3つ目を作成します。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.2.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result3</h3>
<p>CloudShellに以下のような結果が返却されていることを確認下さい。ID等は個人個人異なります。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">xxx
</code></pre>
<h3 is-upgraded>cmd4</h3>
<p>Subnetの4つ目を作成します。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.3.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result4</h3>
<p>CloudShellに以下のような結果が返却されていることを確認下さい。ID等は個人個人異なります。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">xxx
</code></pre>
<h3 is-upgraded>変数取得</h3>
<p>IDが取得されていることを確認。ID等は個人個人異なります。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic: ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate: ${SubnetId1cPrivate}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<p>IDが取得されていることを確認。ID等は個人個人異なります。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId : vpc-08a77289b9b351429
SubnetId1aPublic : subnet-0ae475cbd47289960
SubnetId1cPublic: subnet-051a32873cc5c562b
SubnetId1aPrivate : subnet-01eb19ab0aeb0f6f1
SubnetId1cPrivate: subnet-0819c13fe959a0d1a
</code></pre>
<h2 is-upgraded>■InternetGatewayの作成</h2>
<p>Internetに繋がるInternetGatewayを作成します。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-internet-gateway \
    --tag-specifications &#34;ResourceType=internet-gateway,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">xxx
</code></pre>
<h3 is-upgraded>変数設定</h3>
<p>作成したInternet GatewayのIDを取得します。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">InternetGatewayId=`aws ec2 describe-internet-gateways \
    --query &#39;InternetGateways[*].InternetGatewayId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">cat &lt;&lt; EOF
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic: ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate: ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<p>変数が取得されていることを確認します。</p>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId : vpc-08a77289b9b351429
SubnetId1aPublic : subnet-0ae475cbd47289960
SubnetId1cPublic: subnet-051a32873cc5c562b
SubnetId1aPrivate : subnet-01eb19ab0aeb0f6f1
SubnetId1cPrivate: subnet-0819c13fe959a0d1a
InternetGatewayId : igw-0db61da9fcd82b6eb
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCにAttach</h2>
<p>作成したInternetGatewayをVPCに紐付けします。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 attach-internet-gateway \
    --internet-gateway-id ${InternetGatewayId} \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（何もなし）
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCにAttachされていることを確認</h2>
<p>紐付けが正しく行われたことを確認します。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-internet-gateways \
    --internet-gateway-ids ${InternetGatewayId} \
    --query &#39;InternetGateways[*].Attachments[*].State&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text
</code></pre>
<h3 is-upgraded>result</h3>
<p>結果がavailableであること</p>
<pre><code language="language-CloudShell" class="language-CloudShell">available
</code></pre>
<h2 is-upgraded>■RouteTableの作成</h2>
<h3 is-upgraded>cmd1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h2 is-upgraded>■RouteTableの確認</h2>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPublic=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPrivate=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic: ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate: ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId : vpc-08a77289b9b351429
SubnetId1aPublic : subnet-0ae475cbd47289960
SubnetId1cPublic: subnet-051a32873cc5c562b
SubnetId1aPrivate : subnet-01eb19ab0aeb0f6f1
SubnetId1cPrivate: subnet-0819c13fe959a0d1a
InternetGatewayId : igw-0db61da9fcd82b6eb
RouteTableIdPublic : rtb-0cfcfe4b74de83091
RouteTableIdPrivate : rtb-089389ec79a044951
</code></pre>
<h2 is-upgraded>■RouteTableにSubnetを紐付け</h2>
<h3 is-upgraded>cmd1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1aPublic}
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1aPrivate}
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1cPrivate}
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1cPublic}
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h2 is-upgraded>■RouteTableにInternetGatewayを紐付け</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route \
  --route-table-id ${RouteTableIdPublic} \
  --destination-cidr-block &#34;0.0.0.0/0&#34; \
  --gateway-id ${InternetGatewayId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true
}
</code></pre>
<h2 is-upgraded>■環境変数をメモ</h2>
<p>Cloud9で使うため、取得した変数をエディターに残して下さい。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
export VpcId=&#34;${VpcId}&#34;
export SubnetId1aPublic=&#34;${SubnetId1aPublic}&#34;
export SubnetId1cPublic=&#34;${SubnetId1cPublic}&#34;
export SubnetId1aPrivate=&#34;${SubnetId1aPrivate}&#34;
export SubnetId1cPrivate=&#34;${SubnetId1cPrivate}&#34;
export InternetGatewayId=&#34;${InternetGatewayId}&#34;
export RouteTableIdPublic=&#34;${RouteTableIdPublic}&#34;
export RouteTableIdPrivate=&#34;${RouteTableIdPrivate}&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">export VpcId=&#34;vpc-08a77289b9b351429&#34;
export SubnetId1aPublic=&#34;subnet-0ae475cbd47289960&#34;
export SubnetId1cPublic=&#34;subnet-051a32873cc5c562b&#34;
export SubnetId1aPrivate=&#34;subnet-01eb19ab0aeb0f6f1&#34;
export SubnetId1cPrivate=&#34;subnet-0819c13fe959a0d1a&#34;
export InternetGatewayId=&#34;igw-0db61da9fcd82b6eb&#34;
export RouteTableIdPublic=&#34;rtb-0cfcfe4b74de83091&#34;
export RouteTableIdPrivate=&#34;rtb-089389ec79a044951&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Cloud9作成" duration="5">
        <h2 is-upgraded>■Cloud9の作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws cloud9 create-environment-ec2 \
  --name ContainerHandsOn \
  --description &#34;ContainerHandsOn&#34; \
  --instance-type t3.small  \
  --subnet-id ${SubnetId1aPublic}  \
  --automatic-stop-time-minutes 60  \
  --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;environmentId&#34;: &#34;96614b2a3f434be7a83b5dffb22a1f0a&#34;
}
</code></pre>
<h2 is-upgraded>■AWS コンソールでCloud9を起動</h2>
<ul>
<li>上部の検索バーで<code>Cloud9</code>と検索</li>
<li><code>AWS Cloud9 &gt; Your environments</code>に<code>ContainerHandsOn</code>が作成されているので<code>Open IDE</code>ボタン押下</li>
<li>Cloud9の画面が表示される。</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="ECR作成" duration="5">
        <h2 is-upgraded>■環境変数を貼り付け</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export VpcId=&#34;vpc-08a77289b9b351429&#34;
export SubnetId1aPublic=&#34;subnet-0ae475cbd47289960&#34;
export SubnetId1cPublic=&#34;subnet-051a32873cc5c562b&#34;
export SubnetId1aPrivate=&#34;subnet-01eb19ab0aeb0f6f1&#34;
export SubnetId1cPrivate=&#34;subnet-0819c13fe959a0d1a&#34;
export InternetGatewayId=&#34;igw-0db61da9fcd82b6eb&#34;
export RouteTableIdPublic=&#34;rtb-0cfcfe4b74de83091&#34;
export RouteTableIdPrivate=&#34;rtb-089389ec79a044951&#34;
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">VpcId : vpc-08a77289b9b351429
SubnetId1aPublic : subnet-0ae475cbd47289960
SubnetId1cPublic : subnet-051a32873cc5c562b
SubnetId1aPrivate : subnet-01eb19ab0aeb0f6f1
SubnetId1cPrivate : subnet-0819c13fe959a0d1a
InternetGatewayId : igw-0db61da9fcd82b6eb
RouteTableIdPublic : rtb-0cfcfe4b74de83091
RouteTableIdPrivate : rtb-089389ec79a044951
</code></pre>
<h2 is-upgraded>■ECRの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr create-repository \
    --repository-name jaws-days-2022/container-hands-on \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;repository&#34;: {
        &#34;repositoryArn&#34;: &#34;arn:aws:ecr:ap-northeast-1:378647896848:repository/jaws-days-2022/container-hands-on&#34;,
        &#34;registryId&#34;: &#34;378647896848&#34;,
        &#34;repositoryName&#34;: &#34;jaws-days-2022/container-hands-on&#34;,
        &#34;repositoryUri&#34;: &#34;378647896848.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on&#34;,
        &#34;createdAt&#34;: 1662173179.0,
        &#34;imageTagMutability&#34;: &#34;MUTABLE&#34;,
        &#34;imageScanningConfiguration&#34;: {
            &#34;scanOnPush&#34;: false
        },
        &#34;encryptionConfiguration&#34;: {
            &#34;encryptionType&#34;: &#34;AES256&#34;
        }
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Docker Image作成" duration="5">
        <h2 is-upgraded>■CloudShellで作成した環境変数を貼り付け</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export VpcId=&#34;vpc-08a77289b9b351429&#34;
export SubnetId1aPublic=&#34;subnet-0ae475cbd47289960&#34;
export SubnetId1cPublic=&#34;subnet-051a32873cc5c562b&#34;
export SubnetId1aPrivate=&#34;subnet-01eb19ab0aeb0f6f1&#34;
export SubnetId1cPrivate=&#34;subnet-0819c13fe959a0d1a&#34;
export InternetGatewayId=&#34;igw-0db61da9fcd82b6eb&#34;
export RouteTableId=&#34;rtb-01b343a22f94f5031&#34;
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableId : ${RouteTableId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">VpcId : vpc-08a77289b9b351429
SubnetId1aPublic : subnet-0ae475cbd47289960
SubnetId1cPublic : subnet-051a32873cc5c562b
SubnetId1aPrivate : subnet-01eb19ab0aeb0f6f1
SubnetId1cPrivate : subnet-0819c13fe959a0d1a
InternetGatewayId : igw-0db61da9fcd82b6eb
RouteTableId : rtb-01b343a22f94f5031
</code></pre>
<h2 is-upgraded>■Cloud9上にdockerセットアップされていることを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker -v
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Docker version 20.10.13, build a224086
</code></pre>
<h2 is-upgraded>■Cloud9上にDockerfileを作成</h2>
<p><a href="https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/create-container-image.html" target="_blank">参考元</a></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; Dockerfile
FROM ubuntu:18.04

# Install dependencies
RUN apt-get update &amp;&amp; \
 apt-get -y install apache2

# Install apache and write hello world message
RUN echo &#39;Hello! Jaws Days 2022!!&#39; &gt; /var/www/html/index.html

# Configure apache
RUN echo &#39;. /etc/apache2/envvars&#39; &gt; /root/run_apache.sh &amp;&amp; \
 echo &#39;mkdir -p /var/run/apache2&#39; &gt;&gt; /root/run_apache.sh &amp;&amp; \
 echo &#39;mkdir -p /var/lock/apache2&#39; &gt;&gt; /root/run_apache.sh &amp;&amp; \ 
 echo &#39;/usr/sbin/apache2 -D FOREGROUND&#39; &gt;&gt; /root/run_apache.sh &amp;&amp; \ 
 chmod 755 /root/run_apache.sh

EXPOSE 80

CMD /root/run_apache.sh
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat Dockerfile;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">FROM ubuntu:18.04

# Install dependencies
RUN apt-get update &amp;&amp;  apt-get -y install apache2

# Install apache and write hello world message
RUN echo &#39;Hello! Jaws Days 2022!!&#39; &gt; /var/www/html/index.html

# Configure apache
RUN echo &#39;. /etc/apache2/envvars&#39; &gt; /root/run_apache.sh &amp;&amp;  echo &#39;mkdir -p /var/run/apache2&#39; &gt;&gt; /root/run_apache.sh &amp;&amp;  echo &#39;mkdir -p /var/lock/apache2&#39; &gt;&gt; /root/run_apache.sh &amp;&amp; \ 
 echo &#39;/usr/sbin/apache2 -D FOREGROUND&#39; &gt;&gt; /root/run_apache.sh &amp;&amp; \ 
 chmod 755 /root/run_apache.sh

EXPOSE 80

CMD /root/run_apache.sh
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker build -t jaws-days-2022/container-hands-on .
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（略）
Successfully built fed9645afaae
Successfully tagged jaws-days-2022/container-hands-on:latest
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築されたことを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-cloud9" class="language-cloud9">docker images --filter reference= jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-cloud9" class="language-cloud9">REPOSITORY                          TAG       IMAGE ID       CREATED         SIZE
jaws-days-2022/container-hands-on   latest    fed9645afaae   8 minutes ago   202MB
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを起動</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker run --name container-hands-on -d -p 8080:80 jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">dcaf3423f6abeea3a67bab0c01a33e7b9d2c97131c8b304900f0455ee73da7b7
</code></pre>
<h3 is-upgraded>画面</h3>
<p>xxx</p>
<h2 is-upgraded>■（ご参考）Cloud9上でコンテナを停止・削除する方法</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker stop $(docker ps -q)
docker rm $(docker ps -q -a)
</code></pre>
<h2 is-upgraded>■AWS Account IDの取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID=`aws sts get-caller-identity --query Account --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
VpcId : ${VpcId}
SubnetId1a : ${SubnetId1a}
SubnetId1c : ${SubnetId1c}
InternetGatewayId : ${InternetGatewayId}
RouteTableId : ${RouteTableId}
AccoutID : ${AccoutID}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">VpcId : vpc-08a77289b9b351429
SubnetId1a : subnet-0ae475cbd47289960
SubnetId1c : subnet-051a32873cc5c562b
InternetGatewayId : igw-0db61da9fcd82b6eb
RouteTableId : rtb-01b343a22f94f5031
AccoutID : 378647896848
</code></pre>
<h2 is-upgraded>■DockerImageにTag付けを行う</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker tag jaws-days-2022/container-hands-on:latest `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■DockerImageにTag付けの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker images --filter reference=`echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest

</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">REPOSITORY                                                                            TAG       IMAGE ID       CREATED          SIZE
378647896848.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on   latest    fed9645afaae   21 minutes ago   202MB
</code></pre>
<h2 is-upgraded>■認証トークンを取得し、レジストリに対して Docker クライアントを認証します</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">WARNING! Your password will be stored unencrypted in /home/ec2-user/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
</code></pre>
<h2 is-upgraded>■DockerImageをECRにPush</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker push `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">61e740eb529d: Pushed 
58f84848d392: Pushed 
d5c24541b3aa: Pushed 
1a996540f50f: Pushed 
latest: digest: sha256:8d4d59636b92dffc4d4986c6a38a42fff9201d418aa21d96ad276a754d77d943 size: 1155
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="VPCエンドポイント作成" duration="5">
        <p>FargateをPrivateSubnetで稼働させるため、以下VPCエンドポイントを準備します。</p>
<ul>
<li>com.amazonaws.ap-northeast-1.s3</li>
<li>com.amazonaws.ap-northeast-1.ecr.dkr</li>
<li>com.amazonaws.ap-northeast-1.ecr.api</li>
<li>com.amazonaws.ap-northeast-1.logs</li>
</ul>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.s3</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Gateway \
    --service-name com.amazonaws.ap-northeast-1.s3 \
    --route-table-ids ${RouteTableIdPrivate} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">xxx
</code></pre>
<h2 is-upgraded>■インターフェース用のSecurityGroup作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-security-group \
  --group-name InterfaceSecurityGroup \
  --description &#34;Interface Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-InterfaceSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">xxx
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">InterfaceGroupId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-InterfaceSecurityGroup&#34; \
    --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
VpcId : ${VpcId}
SubnetId1a : ${SubnetId1a}
SubnetId1c : ${SubnetId1c}
InternetGatewayId : ${InternetGatewayId}
RouteTableId : ${RouteTableId}
AccoutID : ${AccoutID}
InterfaceGroupId : ${InterfaceGroupId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code></code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.dkr</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.dkr \
    --route-table-ids ${RouteTableIdPrivate} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9"></code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.api</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.logs</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell"></code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ALB作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="Fargate作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="動作確認" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="CodeBuild作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="CodeDeploy作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="CodePipeline作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="Dockerコンテナ再ビルド(Codeシリーズを利用)" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="動作確認" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="片付け" duration="5">
        <h2 is-upgraded>途中の見出し</h2>
<aside class="special"><p>何かお知らせを書きたい時のボックス</p>
</aside>
<aside class="warning"><p>何か注意点などを書きたい時のボックス</p>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
