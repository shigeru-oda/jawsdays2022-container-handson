
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="docs"
                  title="[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="はじめに" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="VPC作成" duration="5">
        <h2 is-upgraded>■CloudShellの起動</h2>
<h3 is-upgraded>AWS コンソールにログイン</h3>
<p class="image-container"><img alt="img" src="img/8ec695a05f461637.png"></p>
<h3 is-upgraded>CloudShellボタン押下</h3>
<p>画面右上のCloudShellボタンを押下<br><img alt="img" src="img/1bbb070a4cf9999c.png"></p>
<h3 is-upgraded>CloudShellを起動</h3>
<p>今後は以下の画面にコマンド（以下 cmd）と結果（以下 result）を確認し、進める。 <img alt="img" src="img/9b0f4ff0313865b9.png"></p>
<h2 is-upgraded>■AWS Account IDの取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID=`aws sts get-caller-identity --query Account --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
</code></pre>
<h2 is-upgraded>■VPCの作成</h2>
<p>VPCを新規に作成します。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-vpc \
    --cidr-block 10.0.0.0/16 \
    --tag-specification &#34;ResourceType=vpc,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Vpc&#34;: {
        &#34;CidrBlock&#34;: &#34;10.0.0.0/16&#34;,
        &#34;DhcpOptionsId&#34;: &#34;dopt-c3de3ba5&#34;,
        &#34;State&#34;: &#34;pending&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;InstanceTenancy&#34;: &#34;default&#34;,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;CidrBlockAssociationSet&#34;: [
            {
                &#34;AssociationId&#34;: &#34;vpc-cidr-assoc-098ed848444db197b&#34;,
                &#34;CidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;CidrBlockState&#34;: {
                    &#34;State&#34;: &#34;associated&#34;
                }
            }
        ],
        &#34;IsDefault&#34;: false,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ]
    }
}
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId=`aws ec2 describe-vpcs \
    --query &#39;Vpcs[*].VpcId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
</code></pre>
<h3 is-upgraded>■DNS名前解決をONにする</h3>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell"> aws ec2 modify-vpc-attribute \
  --vpc-id ${VpcId}  \
  --enable-dns-support  &#39;{&#34;Value&#34;:true}&#39; 
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>■DNS名前解決の状態確認</h3>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-vpc-attribute \
  --query EnableDnsSupport \
  --vpc-id ${VpcId}  \
  --attribute enableDnsSupport
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Value&#34;: true
}
</code></pre>
<h3 is-upgraded>■DNSホスト名をONにする</h3>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell"> aws ec2 modify-vpc-attribute \
  --vpc-id ${VpcId}  \
  --enable-dns-hostnames  &#39;{&#34;Value&#34;:true}&#39; 
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>■DNSホスト名の状態確認</h3>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-vpc-attribute \
  --query EnableDnsHostnames \
  --vpc-id ${VpcId}  \
  --attribute enableDnsHostnames
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Value&#34;: true
}
</code></pre>
<h2 is-upgraded>■Subnetの作成</h2>
<p>作成したVPCの中にSubnetを4つ作成します。 Private Subnetが2つ、Public Subnetが2つです。</p>
<h3 is-upgraded>cmd1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.0.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1a&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az4&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.0.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0f66f257f167a1d47&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:152767562250:subnet/subnet-0f66f257f167a1d47&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.1.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1c&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az1&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.1.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0a1e2afffc8c140d8&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:152767562250:subnet/subnet-0a1e2afffc8c140d8&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd3</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.2.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result3</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1a&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az4&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.2.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-049f0119237ff00a0&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:152767562250:subnet/subnet-049f0119237ff00a0&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd4</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.3.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result4</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1c&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az1&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.3.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0ea89b6bc85e0ec61&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:152767562250:subnet/subnet-0ea89b6bc85e0ec61&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>変数取得</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic: ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate: ${SubnetId1cPrivate}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic: subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate: subnet-0ea89b6bc85e0ec61
</code></pre>
<h2 is-upgraded>■InternetGatewayの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-internet-gateway \
    --tag-specifications &#34;ResourceType=internet-gateway,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;InternetGateway&#34;: {
        &#34;Attachments&#34;: [],
        &#34;InternetGatewayId&#34;: &#34;igw-0a511ba68ceb84ed8&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ]
    }
}
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">InternetGatewayId=`aws ec2 describe-internet-gateways \
    --query &#39;InternetGateways[*].InternetGatewayId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic: ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate: ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic: subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate: subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCにAttach</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 attach-internet-gateway \
    --internet-gateway-id ${InternetGatewayId} \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（何もなし）
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCにAttachされていることを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-internet-gateways \
    --internet-gateway-ids ${InternetGatewayId} \
    --query &#39;InternetGateways[*].Attachments[*].State&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">available
</code></pre>
<h2 is-upgraded>■RouteTableの作成</h2>
<h3 is-upgraded>cmd1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;RouteTable&#34;: {
        &#34;Associations&#34;: [],
        &#34;PropagatingVgws&#34;: [],
        &#34;RouteTableId&#34;: &#34;rtb-00cf30796b25b9bc9&#34;,
        &#34;Routes&#34;: [
            {
                &#34;DestinationCidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;GatewayId&#34;: &#34;local&#34;,
                &#34;Origin&#34;: &#34;CreateRouteTable&#34;,
                &#34;State&#34;: &#34;active&#34;
            }
        ],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;RouteTable&#34;: {
        &#34;Associations&#34;: [],
        &#34;PropagatingVgws&#34;: [],
        &#34;RouteTableId&#34;: &#34;rtb-0afaac377925bca9a&#34;,
        &#34;Routes&#34;: [
            {
                &#34;DestinationCidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;GatewayId&#34;: &#34;local&#34;,
                &#34;Origin&#34;: &#34;CreateRouteTable&#34;,
                &#34;State&#34;: &#34;active&#34;
            }
        ],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;152767562250&#34;
    }
}
</code></pre>
<h2 is-upgraded>■RouteTableの確認</h2>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPublic=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPrivate=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic: ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate: ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic: subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate: subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
</code></pre>
<h2 is-upgraded>■RouteTableにSubnetを紐付け</h2>
<h3 is-upgraded>cmd1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1aPublic}
</code></pre>
<h3 is-upgraded>result1</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-0e98cb5f6c54d5d83&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1cPublic}
</code></pre>
<h3 is-upgraded>result2</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-0f3ca785ae8675b6f&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd3</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1aPrivate}
</code></pre>
<h3 is-upgraded>result3</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-07f8b8f8aa65d0df8&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd4</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1cPrivate}
</code></pre>
<h3 is-upgraded>result4</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-008c971373c02cf69&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h2 is-upgraded>■RouteTableにInternetGatewayを紐付け</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route \
  --route-table-id ${RouteTableIdPublic} \
  --destination-cidr-block &#34;0.0.0.0/0&#34; \
  --gateway-id ${InternetGatewayId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true
}
</code></pre>
<h2 is-upgraded>■PublicSubnet用のSecurityGroup作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-security-group \
  --group-name PublicSecurityGroup \
  --description &#34;Public Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-PublicSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;,
    &#34;Tags&#34;: [
        {
            &#34;Key&#34;: &#34;Name&#34;,
            &#34;Value&#34;: &#34;ContainerHandsOn-PublicSecurityGroup&#34;
        }
    ]
}
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code>PublicSecurityGroupsId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-PublicSecurityGroup&#34; \
    --output text`
</code></pre>
<h2 is-upgraded>■PrivateSubnet用のSecurityGroup作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-security-group \
  --group-name PrivateSecurityGroup \
  --description &#34;Private Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-PrivateSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
    &#34;Tags&#34;: [
        {
            &#34;Key&#34;: &#34;Name&#34;,
            &#34;Value&#34;: &#34;ContainerHandsOn-PrivateSecurityGroup&#34;
        }
    ]
}
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">PrivateSecurityGroupsId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-PrivateSecurityGroup&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic: ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate: ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic: subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate: subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
PublicSecurityGroupsId : sg-01cc901415c240504
PrivateSecurityGroupsId : sg-040aff209e1fe59cc
</code></pre>
<h2 is-upgraded>■PublicSubnetのInboundを追加</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PublicSecurityGroupsId} \
    --protocol tcp \
    --port 80 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-011c9bf434c9439a0&#34;,
            &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;,
            &#34;GroupOwnerId&#34;: &#34;152767562250&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 80,
            &#34;ToPort&#34;: 80,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PrivateSubnetのInboundを追加</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PrivateSecurityGroupsId} \
    --protocol tcp \
    --port 80 \
    --source-group ${PublicSecurityGroupsId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0eca9b6518889b4ca&#34;,
            &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
            &#34;GroupOwnerId&#34;: &#34;152767562250&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 80,
            &#34;ToPort&#34;: 80,
            &#34;ReferencedGroupInfo&#34;: {
                &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;
            }
        }
    ]
}
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PrivateSecurityGroupsId} \
    --protocol tcp \
    --port 443 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0d637ce636f2f14d9&#34;,
            &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
            &#34;GroupOwnerId&#34;: &#34;152767562250&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 443,
            &#34;ToPort&#34;: 443,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■環境変数をメモ</h2>
<p>Cloud9で使うため、取得した変数をエディターに残して下さい。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
export AccoutID=&#34;${AccoutID}&#34;
export VpcId=&#34;${VpcId}&#34;
export SubnetId1aPublic=&#34;${SubnetId1aPublic}&#34;
export SubnetId1cPublic=&#34;${SubnetId1cPublic}&#34;
export SubnetId1aPrivate=&#34;${SubnetId1aPrivate}&#34;
export SubnetId1cPrivate=&#34;${SubnetId1cPrivate}&#34;
export InternetGatewayId=&#34;${InternetGatewayId}&#34;
export RouteTableIdPublic=&#34;${RouteTableIdPublic}&#34;
export RouteTableIdPrivate=&#34;${RouteTableIdPrivate}&#34;
export PublicSecurityGroupsId=&#34;${PublicSecurityGroupsId}&#34;
export PrivateSecurityGroupsId=&#34;${PrivateSecurityGroupsId}&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">export AccoutID=&#34;152767562250&#34;
export VpcId=&#34;vpc-0d3c1c88db46cfba7&#34;
export SubnetId1aPublic=&#34;subnet-0f66f257f167a1d47&#34;
export SubnetId1cPublic=&#34;subnet-0a1e2afffc8c140d8&#34;
export SubnetId1aPrivate=&#34;subnet-049f0119237ff00a0&#34;
export SubnetId1cPrivate=&#34;subnet-0ea89b6bc85e0ec61&#34;
export InternetGatewayId=&#34;igw-0a511ba68ceb84ed8&#34;
export RouteTableIdPublic=&#34;rtb-00cf30796b25b9bc9&#34;
export RouteTableIdPrivate=&#34;rtb-0afaac377925bca9a&#34;
export PublicSecurityGroupsId=&#34;sg-01cc901415c240504&#34;
export PrivateSecurityGroupsId=&#34;sg-040aff209e1fe59cc&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Cloud9作成" duration="5">
        <h2 is-upgraded>■Cloud9の作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws cloud9 create-environment-ec2 \
  --name ContainerHandsOn \
  --description &#34;ContainerHandsOn&#34; \
  --instance-type t3.small  \
  --subnet-id ${SubnetId1aPublic}  \
  --automatic-stop-time-minutes 60 
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;environmentId&#34;: &#34;aa2999a731eb4178aed99069f1b683aa&#34;
}
</code></pre>
<h2 is-upgraded>■AWS コンソールでCloud9を起動</h2>
<ul>
<li>上部の検索バーで<code>Cloud9</code>と検索</li>
<li><code>AWS Cloud9 &gt; Your environments</code>に<code>ContainerHandsOn</code>が作成されているので<code>Open IDE</code>ボタン押下</li>
<li>Cloud9の画面が表示される。</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="ECR作成" duration="5">
        <h2 is-upgraded>■環境変数を貼り付け</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export AccoutID=&#34;152767562250&#34;
export VpcId=&#34;vpc-0d3c1c88db46cfba7&#34;
export SubnetId1aPublic=&#34;subnet-0f66f257f167a1d47&#34;
export SubnetId1cPublic=&#34;subnet-0a1e2afffc8c140d8&#34;
export SubnetId1aPrivate=&#34;subnet-049f0119237ff00a0&#34;
export SubnetId1cPrivate=&#34;subnet-0ea89b6bc85e0ec61&#34;
export InternetGatewayId=&#34;igw-0a511ba68ceb84ed8&#34;
export RouteTableIdPublic=&#34;rtb-00cf30796b25b9bc9&#34;
export RouteTableIdPrivate=&#34;rtb-0afaac377925bca9a&#34;
export PublicSecurityGroupsId=&#34;sg-01cc901415c240504&#34;
export PrivateSecurityGroupsId=&#34;sg-040aff209e1fe59cc&#34;
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 152767562250
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
PublicSecurityGroupsId : sg-01cc901415c240504
PrivateSecurityGroupsId : sg-040aff209e1fe59cc
</code></pre>
<h2 is-upgraded>■ECRの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr create-repository \
    --repository-name jaws-days-2022/container-hands-on \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;repository&#34;: {
        &#34;repositoryArn&#34;: &#34;arn:aws:ecr:ap-northeast-1:152767562250:repository/jaws-days-2022/container-hands-on&#34;,
        &#34;registryId&#34;: &#34;152767562250&#34;,
        &#34;repositoryName&#34;: &#34;jaws-days-2022/container-hands-on&#34;,
        &#34;repositoryUri&#34;: &#34;152767562250.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on&#34;,
        &#34;createdAt&#34;: &#34;2022-09-06T13:21:42+00:00&#34;,
        &#34;imageTagMutability&#34;: &#34;MUTABLE&#34;,
        &#34;imageScanningConfiguration&#34;: {
            &#34;scanOnPush&#34;: false
        },
        &#34;encryptionConfiguration&#34;: {
            &#34;encryptionType&#34;: &#34;AES256&#34;
        }
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Docker Image作成" duration="5">
        <h2 is-upgraded>■Cloud9上にdockerセットアップされていることを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker -v
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Docker version 20.10.13, build a224086
</code></pre>
<h2 is-upgraded>■Cloud9上にDockerfileを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; Dockerfile
FROM php:7.4.0-apache
COPY src/ /var/www/html/
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">mkdir src
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; ./src/index.php
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;ja&#34;&gt;
  &lt;head&gt;
    &lt;title&gt;Hello! Jaws Days 2022!!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Hello! Jaws Days 2022!!&lt;/p&gt;
    &lt;?php echo gethostname(); ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">ls -l ./Dockerfile  ./src/index.php
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">-rw-rw-r-- 1 ec2-user ec2-user  47 Sep  6 13:26 ./Dockerfile
-rw-rw-r-- 1 ec2-user ec2-user 190 Sep  6 13:26 ./src/index.php
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker build -t jaws-days-2022/container-hands-on .
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（略）
Successfully built fed9645afaae
Successfully tagged jaws-days-2022/container-hands-on:latest
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築されたことを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-cloud9" class="language-cloud9">docker images --filter reference= jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-cloud9" class="language-cloud9">REPOSITORY                          TAG       IMAGE ID       CREATED          SIZE
jaws-days-2022/container-hands-on   latest    98c14fa37bab   10 seconds ago   414MB
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを起動</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker run --name container-hands-on -d -p 8080:80 jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">dcaf3423f6abeea3a67bab0c01a33e7b9d2c97131c8b304900f0455ee73da7b7
</code></pre>
<h3 is-upgraded>画面</h3>
<ul>
<li>Cloud9のヘッダ部分の<code>Preview</code>-&gt; <code>Preview Runnnig Application</code>のボタン押下 -<code>Hello! Jaws Days 2022!!</code>と記載された画面が表示されること</li>
</ul>
<p class="image-container"><img alt="img" src="img/2be66bb659acb02.png"></p>
<h2 is-upgraded>■（ご参考）Cloud9上でコンテナを停止・削除する方法</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker stop $(docker ps -q)
docker rm $(docker ps -q -a)
</code></pre>
<h2 is-upgraded>■DockerImageにTag付けを行う</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker tag jaws-days-2022/container-hands-on:latest `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■DockerImageにTag付けの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker images --filter reference=`echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest

</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">REPOSITORY                                                                            TAG       IMAGE ID       CREATED          SIZE
152767562250.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on   latest    98c14fa37bab   10 minutes ago   414MB
</code></pre>
<h2 is-upgraded>■認証トークンを取得し、レジストリに対して Docker クライアントを認証します</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">WARNING! Your password will be stored unencrypted in /home/ec2-user/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
</code></pre>
<h2 is-upgraded>■DockerImageをECRにPush</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker push `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">The push refers to repository [152767562250.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on]
9f8ad0ecf420: Pushed 
536365481ed8: Pushed 
4b3693c51878: Pushed 
677c3ce9f0b4: Pushed 
c08f4d9c281b: Pushed 
ed13170590f7: Pushed 
37cbdda31557: Pushed 
9691e5d7a4c7: Pushed 
6a4d393f0795: Pushed 
e38834ac7561: Pushed 
ec64f555d498: Pushed 
840f3f414cf6: Pushed 
17fce12edef0: Pushed 
831c5620387f: Pushed 
latest: digest: sha256:1fb5a3ac5ea1e7d60c24f371564a8c2c7bbc8072be0e80a3c53c30e1cae3ffd3 size: 3242
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="VPCエンドポイント作成" duration="5">
        <p>FargateをPrivateSubnetで稼働させるため、以下VPCエンドポイントを準備します。</p>
<ul>
<li>com.amazonaws.ap-northeast-1.s3</li>
<li>com.amazonaws.ap-northeast-1.ecr.dkr</li>
<li>com.amazonaws.ap-northeast-1.ecr.api</li>
<li>com.amazonaws.ap-northeast-1.logs</li>
</ul>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.s3</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Gateway \
    --service-name com.amazonaws.ap-northeast-1.s3 \
    --route-table-ids ${RouteTableIdPrivate} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">xxx
</code></pre>
<h2 is-upgraded>■インターフェース用のSecurityGroup作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-security-group \
  --group-name InterfaceSecurityGroup \
  --description &#34;Interface Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-InterfaceSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">xxx
</code></pre>
<h3 is-upgraded>変数設定</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">InterfaceGroupId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-InterfaceSecurityGroup&#34; \
    --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
AccoutID : ${AccoutID}
InterfaceGroupId : ${InterfaceGroupId}
EOF
</code></pre>
<h3 is-upgraded>変数設定確認</h3>
<pre><code></code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.dkr</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.dkr \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${InterfaceGroupId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9"></code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.api</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.api \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${InterfaceGroupId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">xxx
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.logs</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.logs \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${InterfaceGroupId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9"></code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ALB作成" duration="5">
        <h2 is-upgraded>■アプリケーションロードバランサーの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-load-balancer \
    --name ContainerHandsOn \
    --subnets ${SubnetId1aPublic} ${SubnetId1cPublic} \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9"></code></pre>
<h2 is-upgraded>■ターゲットグループの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-target-group \
    --name ContainerHandsOn \
    --protocol TCP \
    --port 80 \
    --target-type ip \
    --vpc-id ${VpcId}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Fargate作成" duration="5">
        <h2 is-upgraded>■クラスターの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs create-cluster \
    --cluster-name ContainerHandsOn \
    --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">xxx
</code></pre>
<h2 is-upgraded>■タスク定義の作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; register-task-definition.json
{
    &#34;family&#34;: &#34;ContainerHandsOn&#34;, 
    &#34;executionRoleArn&#34;: &#34;arn:aws:iam::378647896848:role/aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS&#34;, 
    &#34;networkMode&#34;: &#34;awsvpc&#34;, 
    &#34;containerDefinitions&#34;: [
        {
            &#34;name&#34;: &#34;ContainerHandsOn&#34;, 
            &#34;image&#34;: &#34;${AccoutID}.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;, 
            &#34;portMappings&#34;: [
                {
                    &#34;containerPort&#34;: 80, 
                    &#34;hostPort&#34;: 80, 
                    &#34;protocol&#34;: &#34;tcp&#34;
                }
            ], 
            &#34;essential&#34;: true
        }
    ], 
    &#34;requiresCompatibilities&#34;: [
        &#34;FARGATE&#34;
    ], 
    &#34;cpu&#34;: &#34;256&#34;, 
    &#34;memory&#34;: &#34;512&#34;,
    &#34;runtimePlatform&#34;: {
        &#34;cpuArchitecture&#34;: &#34;X86_64&#34;,
        &#34;operatingSystemFamily&#34;: &#34;LINUX&#34;
    }
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs register-task-definition \
  --cli-input-json file://register-task-definition.json \
  --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">xxxx
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="動作確認" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="CodeBuild作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="CodeDeploy作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="CodePipeline作成" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="Dockerコンテナ再ビルド(Codeシリーズを利用)" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="動作確認" duration="5">
        

      </google-codelab-step>
    
      <google-codelab-step label="片付け" duration="5">
        <h2 is-upgraded>途中の見出し</h2>
<aside class="special"><p>何かお知らせを書きたい時のボックス</p>
</aside>
<aside class="warning"><p>何か注意点などを書きたい時のボックス</p>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
