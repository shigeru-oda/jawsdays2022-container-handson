
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="docs"
                  title="[JAWS DAYS 2022] ハンズオン～コンテナサービスをCI/CDパイプラインでデプロイしよう～"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="ご挨拶" duration="0">
        <h2 is-upgraded>■ご挨拶</h2>
<p>当資料は<a href="https://jawsdays2022.jaws-ug.jp/" target="_blank">JAWS DAYS 2022 - Satellites</a>でのハンズオントラックの一つ、<a href="https://jaws-ug.doorkeeper.jp/events/141627" target="_blank">コンテナサービスをCI/CDパイプラインでデプロイしよう</a>のセッションで利用する資料となります</p>
<p><a href="https://jawsdays2022.jaws-ug.jp/" target="_blank">JAWS DAYS 2022 - Satellites</a>のハンズオンは以下3点ありますが、他セッションはGUI、CDKでの環境構築であったので、当セッションはCLIでの環境構築として準備しています</p>
<ul>
<li><a href="https://jaws-ug.doorkeeper.jp/events/141646" target="_blank">S3でWebサイトを公開して、リソースポリシーでアクセスを制御してみよう</a></li>
<li><a href="https://jaws-ug.doorkeeper.jp/events/141627" target="_blank">コンテナサービスをCI/CDパイプラインでデプロイしよう</a></li>
<li><a href="https://jaws-ug.doorkeeper.jp/events/141651" target="_blank">CDKでサーバーレスアプリをデプロイしよう</a></li>
</ul>
<p>初心者の方にはCLIコマンドが難しいかもしれませんが、まずはこういうステップが必要という勘所だけでも掴んで頂ければ幸いです、慣れた方はCLIコマンドの1つ１つの意味を理解するように進めて頂けるとありがたいです</p>
<h2 is-upgraded>■対象者</h2>
<ul>
<li>コンテナが何かよく分からない人</li>
<li>ＡＷＳでのコンテナサービスを知りたい人</li>
<li>ＣＩ／ＣＤパイプラインでコンテナサービスをデプロイしたい人</li>
</ul>
<h2 is-upgraded>■当日までにご準備が必要なもの</h2>
<ul>
<li>マネジメントコンソールにログイン可能なAdministrator権限のIAMユーザー</li>
<li>Chrome もしくは Firefox</li>
</ul>
<h2 is-upgraded>■免責事項について</h2>
<p>ハンズオンで利用するサービスは一部課金対象となるサービスもございます<br> また、ハンズオンで作成した環境を削除しない場合には、課金が続くことによって高額になる可能性があります<br> 課金が発生したことによる責任は負えませんので、ご承知おきください 上記事項をご理解頂きお申込みいただけますようお願いいたします</p>
<h2 is-upgraded>■参考資料</h2>
<ul>
<li><a href="https://pages.awscloud.com/rs/112-TZM-766/images/AWS_CICD_ECS_Handson.pdf" target="_blank">AWS CI/CD for Amazon ECS ハンズオン~ Cloud9, Docker, Code Services を⽤いた開発効率向上 ~</a></li>
<li><a href="https://www.slideshare.net/AmazonWebServicesJapan/20190731-black-belt-online-seminar-amazon-ecs-deep-dive-162160987" target="_blank">20190731 Black Belt Online Seminar Amazon ECS Deep Dive</a></li>
</ul>
<h2 is-upgraded>■手順について</h2>
<p>貼り付けるコマンドは準備しているので、基本的にはCopy &amp; Pasteで手順を進めることができます</p>
<h3 is-upgraded>cmd</h3>
<p>cmdと記載された項目にある以下のような表示内容はコマンドをCopy &amp; Pasteするモノとなります</p>
<pre><code language="language-Sample" class="language-Sample">Copy &amp; Pasteの対象です
</code></pre>
<h3 is-upgraded>result</h3>
<p>resultと記載された項目にある以下のような表示内容はコマンドの実行結果です<br> IDなどは個々に異なりますので</p>
<ul>
<li>表示が大きく変わらない</li>
<li>エラーメッセージが出力されていない</li>
</ul>
<p>を確認ください</p>
<pre><code language="language-Sample" class="language-Sample">cmd実行後の結果です
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ハンズオンを通して学ぶこと" duration="5">
        <h2 is-upgraded>■ハンズオン１</h2>
<ul>
<li>VPCを使ったネットワーク関係の構築</li>
<li>VPCエンドポイントを使ったセキュア環境の構築</li>
<li>ECS /Fargateを使ったサーバーレスコンテナ運用の構築</li>
</ul>
<p class="image-container"><img alt="img" src="img/90d89f9364c9e539.png"></p>
<h2 is-upgraded>■ハンズオン２</h2>
<ul>
<li>CoceCommitを使ったソースコード管理</li>
<li>CodeBuildを使った自動ビルド</li>
<li>CodeDeployを使ったECS/Fargateへのデプロイ</li>
<li>CodePipelineを使ったCI/CDパイプラインの構築</li>
</ul>
<p><strong>あとで完成図を挿入</strong></p>


      </google-codelab-step>
    
      <google-codelab-step label="事前準備とネットワーク周りの構築" duration="5">
        <h2 is-upgraded>■CloudShellの起動</h2>
<h3 is-upgraded>AWS コンソールにログイン</h3>
<p>・Administrator権限のIAMユーザーでAWSコンソールにログイン</p>
<p class="image-container"><img alt="img" src="img/8ec695a05f461637.png"></p>
<p>・リージョンを&#34;アジアパシフィック（東京）&#34;に変更</p>
<p class="image-container"><img alt="img" src="img/a700f74d7e2e97dd.png"></p>
<h3 is-upgraded>CloudShellボタン押下</h3>
<p>・画面右上のCloudShellボタンを押下<br><img alt="img" src="img/1bbb070a4cf9999c.png"></p>
<h3 is-upgraded>CloudShellを起動</h3>
<p class="image-container"><img alt="img" src="img/9b0f4ff0313865b9.png"></p>
<h2 is-upgraded>■AWS Account IDの取得</h2>
<p class="image-container"><img alt="img" src="img/f44362afeb0e4cfe.png"></p>
<p>・IDを取得し、変数に格納・確認を行います</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID=`aws sts get-caller-identity --query Account --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 123456789012
</code></pre>
<h2 is-upgraded>■ECSタスクの実行Roleの存在確認</h2>
<p class="image-container"><img alt="img" src="img/601a4c4b7e50e288.png"></p>
<p>・ECSタスクを実行するRole(ecsTaskExecutionRole)の存在確認を行います</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam list-roles | grep &#34;RoleName&#34; | grep &#34;ecsTaskExecutionRole&#34;
</code></pre>
<h3 is-upgraded>result（存在する場合）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">            &#34;RoleName&#34;: &#34;ecsTaskExecutionRole&#34;,
</code></pre>
<h3 is-upgraded>result（存在しない場合）</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■ECSの実行Role作成（Roleが存在しない場合のみ実行）</h2>
<p class="image-container"><img alt="img" src="img/601a4c4b7e50e288.png"></p>
<p>・ecsTaskExecutionRoleが存在しない場合のみ実行します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;ecs-tasks.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ecsTaskExecutionRole \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ecsTaskExecutionRole&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFFJ6CDBQVE&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ecsTaskExecutionRole&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-12T20:01:28+00:00&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;ecs-tasks.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■RoleにPolicyをアタッチ（Roleが存在しない場合のみ実行）</h2>
<p class="image-container"><img alt="img" src="img/6b4e60d623322cff.png"></p>
<p>・作成したRoleにPolicyをアタッチします</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam attach-role-policy \
  --role-name ecsTaskExecutionRole \
  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<p>・Policyがアタッチされたことを確認します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam list-attached-role-policies \
  --role-name ecsTaskExecutionRole
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;AttachedPolicies&#34;: [
        {
            &#34;PolicyName&#34;: &#34;AmazonECSTaskExecutionRolePolicy&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■VPCの作成</h2>
<p class="image-container"><img alt="img" src="img/455e3e2dc6190cce.png"></p>
<p>・VPCを新規に作成します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-vpc \
    --cidr-block 10.0.0.0/16 \
    --tag-specification &#34;ResourceType=vpc,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Vpc&#34;: {
        &#34;CidrBlock&#34;: &#34;10.0.0.0/16&#34;,
        &#34;DhcpOptionsId&#34;: &#34;dopt-c3de3ba5&#34;,
        &#34;State&#34;: &#34;pending&#34;,
        &#34;VpcId&#34;: &#34;vpc-0eb621c4712ee0898&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;InstanceTenancy&#34;: &#34;default&#34;,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;CidrBlockAssociationSet&#34;: [
            {
                &#34;AssociationId&#34;: &#34;vpc-cidr-assoc-05cc0c368d9105817&#34;,
                &#34;CidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;CidrBlockState&#34;: {
                    &#34;State&#34;: &#34;associated&#34;
                }
            }
        ],
        &#34;IsDefault&#34;: false,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ]
    }
}
</code></pre>
<h2 is-upgraded>■VpcIdの取得</h2>
<p>・作成したVPC IDを取得し、変数に格納・確認を行います</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">VpcId=`aws ec2 describe-vpcs \
    --query &#39;Vpcs[*].VpcId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
EOF
</code></pre>
<h3 is-upgraded>results</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 123456789012
VpcId : vpc-0d3c1c88db46cfba7
</code></pre>
<h3 is-upgraded>■DNS名前解決をONにする</h3>
<p>・作成したVPCで「ドメイン名からIPアドレスへの変換、またはその逆」を可能にします<br> ・後程作成するVPCエンドポイントに必要な為です</p>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell"> aws ec2 modify-vpc-attribute \
  --vpc-id ${VpcId}  \
  --enable-dns-support  &#39;{&#34;Value&#34;:true}&#39; 
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>■DNS名前解決の状態確認</h3>
<p>・設定内容が正しく反映されているか確認を行います</p>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-vpc-attribute \
  --query EnableDnsSupport \
  --vpc-id ${VpcId}  \
  --attribute enableDnsSupport
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Value&#34;: true
}
</code></pre>
<h3 is-upgraded>■DNSホスト名をONにする</h3>
<p>・VPC内でDNSホスト名(ex : ip-10-0-0-23.ap-northeast-1.compute.internal)を持つように設定します<br> ・後程作成するVPCエンドポイントに必要な為です</p>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell"> aws ec2 modify-vpc-attribute \
  --vpc-id ${VpcId}  \
  --enable-dns-hostnames  &#39;{&#34;Value&#34;:true}&#39; 
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>■DNSホスト名の状態確認</h3>
<p>・設定内容が正しく反映されているか確認を行います</p>
<h2 is-upgraded>cmd</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-vpc-attribute \
  --query EnableDnsHostnames \
  --vpc-id ${VpcId}  \
  --attribute enableDnsHostnames
</code></pre>
<h2 is-upgraded>result</h2>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Value&#34;: true
}
</code></pre>
<h2 is-upgraded>■Subnetの作成</h2>
<p class="image-container"><img alt="img" src="img/435a16ded7ac40a4.png"></p>
<p>・作成したVPCの中にSubnetを4つ作成します<br> ・Private Subnetが2つ、Public Subnetが2つです</p>
<h3 is-upgraded>cmd (Public Subnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.0.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result (Public Subnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1a&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az4&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.0.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0f66f257f167a1d47&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:123456789012:subnet/subnet-0f66f257f167a1d47&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd (Public Subnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.1.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result (Public Subnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1c&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az1&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.1.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0a1e2afffc8c140d8&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:123456789012:subnet/subnet-0a1e2afffc8c140d8&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd (Private Subnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1a \
    --cidr-block 10.0.2.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result (Private Subnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1a&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az4&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.2.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-049f0119237ff00a0&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:123456789012:subnet/subnet-049f0119237ff00a0&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h3 is-upgraded>cmd (Private Subnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-subnet \
    --vpc-id $VpcId \
    --availability-zone ap-northeast-1c \
    --cidr-block 10.0.3.0/24 \
    --tag-specifications &#34;ResourceType=subnet,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result (Private Subnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Subnet&#34;: {
        &#34;AvailabilityZone&#34;: &#34;ap-northeast-1c&#34;,
        &#34;AvailabilityZoneId&#34;: &#34;apne1-az1&#34;,
        &#34;AvailableIpAddressCount&#34;: 251,
        &#34;CidrBlock&#34;: &#34;10.0.3.0/24&#34;,
        &#34;DefaultForAz&#34;: false,
        &#34;MapPublicIpOnLaunch&#34;: false,
        &#34;State&#34;: &#34;available&#34;,
        &#34;SubnetId&#34;: &#34;subnet-0ea89b6bc85e0ec61&#34;,
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;AssignIpv6AddressOnCreation&#34;: false,
        &#34;Ipv6CidrBlockAssociationSet&#34;: [],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;SubnetArn&#34;: &#34;arn:aws:ec2:ap-northeast-1:123456789012:subnet/subnet-0ea89b6bc85e0ec61&#34;,
        &#34;EnableDns64&#34;: false,
        &#34;Ipv6Native&#34;: false,
        &#34;PrivateDnsNameOptionsOnLaunch&#34;: {
            &#34;HostnameType&#34;: &#34;ip-name&#34;,
            &#34;EnableResourceNameDnsARecord&#34;: false,
            &#34;EnableResourceNameDnsAAAARecord&#34;: false
        }
    }
}
</code></pre>
<h2 is-upgraded>■Subnet IDの取得</h2>
<p>・IDを取得し、変数に格納・確認を行います</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPublic=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1aPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1a&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">SubnetId1cPrivate=`aws ec2 describe-subnets \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
    &#34;Name=availabilityZone,Values=ap-northeast-1c&#34; \
    --query &#34;Subnets[*].SubnetId&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 123456789012
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
</code></pre>
<h2 is-upgraded>■InternetGatewayの作成</h2>
<p class="image-container"><img alt="img" src="img/9892abf54820d3bc.png"></p>
<p>・Internetの出入り口であるInternetGatewayを作成する</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-internet-gateway \
    --tag-specifications &#34;ResourceType=internet-gateway,Tags=[{Key=Name,Value=ContainerHandsOn}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;InternetGateway&#34;: {
        &#34;Attachments&#34;: [],
        &#34;InternetGatewayId&#34;: &#34;igw-0a511ba68ceb84ed8&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;,
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOn&#34;
            }
        ]
    }
}
</code></pre>
<h2 is-upgraded>■InternetGateway IDの取得</h2>
<p>・IDを取得し、変数に格納・確認を行います</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">InternetGatewayId=`aws ec2 describe-internet-gateways \
    --query &#39;InternetGateways[*].InternetGatewayId&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 123456789012
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCにAttach</h2>
<p class="image-container"><img alt="img" src="img/44449b873de62ca7.png"></p>
<p>・VPCとInternetGatewayを紐付けし、Internetとの接続点を作成します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 attach-internet-gateway \
    --internet-gateway-id ${InternetGatewayId} \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h2 is-upgraded>■InternetGatewayをVPCに紐付けされていることを確認</h2>
<p>・アタッチされていることを確認</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 describe-internet-gateways \
    --internet-gateway-ids ${InternetGatewayId} \
    --query &#39;InternetGateways[*].Attachments[*].State&#39; \
    --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn&#34; \
    --output text
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">available
</code></pre>
<h2 is-upgraded>■RouteTableの作成</h2>
<p class="image-container"><img alt="img" src="img/b5394b54c384f8d0.png"></p>
<p>・PublicSubnetとPrivateSubnetのデータの流れを制御するルートテーブルを作成します<br> ・現時点ではRouteTableとSubnetの紐付けはないです</p>
<h3 is-upgraded>cmd (PublicSubnet)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPublic}]&#34;
</code></pre>
<h3 is-upgraded>result (PublicSubnet)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;RouteTable&#34;: {
        &#34;Associations&#34;: [],
        &#34;PropagatingVgws&#34;: [],
        &#34;RouteTableId&#34;: &#34;rtb-00cf30796b25b9bc9&#34;,
        &#34;Routes&#34;: [
            {
                &#34;DestinationCidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;GatewayId&#34;: &#34;local&#34;,
                &#34;Origin&#34;: &#34;CreateRouteTable&#34;,
                &#34;State&#34;: &#34;active&#34;
            }
        ],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPublic&#34;
            }
        ],
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd (PrivateSubnet)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route-table \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=route-table,Tags=[{Key=Name,Value=ContainerHandsOnPrivate}]&#34;
</code></pre>
<h3 is-upgraded>result (PrivateSubnet)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;RouteTable&#34;: {
        &#34;Associations&#34;: [],
        &#34;PropagatingVgws&#34;: [],
        &#34;RouteTableId&#34;: &#34;rtb-0afaac377925bca9a&#34;,
        &#34;Routes&#34;: [
            {
                &#34;DestinationCidrBlock&#34;: &#34;10.0.0.0/16&#34;,
                &#34;GatewayId&#34;: &#34;local&#34;,
                &#34;Origin&#34;: &#34;CreateRouteTable&#34;,
                &#34;State&#34;: &#34;active&#34;
            }
        ],
        &#34;Tags&#34;: [
            {
                &#34;Key&#34;: &#34;Name&#34;,
                &#34;Value&#34;: &#34;ContainerHandsOnPrivate&#34;
            }
        ],
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
        &#34;OwnerId&#34;: &#34;123456789012&#34;
    }
}
</code></pre>
<h2 is-upgraded>■RouteTable IDの取得</h2>
<p>・IDを取得し、変数に格納・確認を行います</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPublic=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPublic&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">RouteTableIdPrivate=`aws ec2 describe-route-tables \
  --query &#34;RouteTables[*].RouteTableId&#34; \
  --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
  &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOnPrivate&#34; \
  --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 123456789012
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
</code></pre>
<h2 is-upgraded>■RouteTableにSubnetを紐付け</h2>
<p class="image-container"><img alt="img" src="img/5119d308a1222c8b.png"></p>
<p>・RouteTableとSubnetを紐付けします</p>
<h3 is-upgraded>cmd (PublicSubnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1aPublic}
</code></pre>
<h3 is-upgraded>result (PublicSubnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-0e98cb5f6c54d5d83&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd (PublicSubnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPublic} \
  --subnet-id ${SubnetId1cPublic}
</code></pre>
<h3 is-upgraded>result (PublicSubnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-0f3ca785ae8675b6f&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd (PrivateSubnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1aPrivate}
</code></pre>
<h3 is-upgraded>result (PrivateSubnet 1つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-07f8b8f8aa65d0df8&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h3 is-upgraded>cmd (PrivateSubnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-route-table \
  --route-table-id ${RouteTableIdPrivate} \
  --subnet-id ${SubnetId1cPrivate}
</code></pre>
<h3 is-upgraded>result (PrivateSubnet 2つ目)</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AssociationId&#34;: &#34;rtbassoc-008c971373c02cf69&#34;,
    &#34;AssociationState&#34;: {
        &#34;State&#34;: &#34;associated&#34;
    }
}
</code></pre>
<h2 is-upgraded>■RouteTableにInternetGatewayを紐付け</h2>
<p class="image-container"><img alt="img" src="img/39f2483d057bb3e1.png"></p>
<p>・PublicSubnet用のRouteTableにInternetGatewayを紐付け、Internetに接続できるようにします</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-route \
  --route-table-id ${RouteTableIdPublic} \
  --destination-cidr-block &#34;0.0.0.0/0&#34; \
  --gateway-id ${InternetGatewayId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true
}
</code></pre>
<h2 is-upgraded>■PublicSubnet用のSecurityGroup作成</h2>
<p class="image-container"><img alt="img" src="img/7b216dd35e095f42.png"></p>
<p>・PublicSubnet用のSecurityGroup作成</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-security-group \
  --group-name PublicSecurityGroup \
  --description &#34;Public Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-PublicSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;,
    &#34;Tags&#34;: [
        {
            &#34;Key&#34;: &#34;Name&#34;,
            &#34;Value&#34;: &#34;ContainerHandsOn-PublicSecurityGroup&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PublicSunetのSecurityGroupsIdの取得</h2>
<p>・IDを取得し、変数に格納・確認を行います</p>
<h3 is-upgraded>cmd</h3>
<pre><code>PublicSecurityGroupsId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-PublicSecurityGroup&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 123456789012
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
PublicSecurityGroupsId : sg-01cc901415c240504
</code></pre>
<h2 is-upgraded>■PrivateSubnet用のSecurityGroup作成</h2>
<p class="image-container"><img alt="img" src="img/d5e673c91aa88988.png"></p>
<p>・PrivateSubnet用のSecurityGroup作成</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 create-security-group \
  --group-name PrivateSecurityGroup \
  --description &#34;Private Security Group&#34; \
  --vpc-id ${VpcId} \
  --tag-specifications &#34;ResourceType=security-group,Tags=[{Key=Name,Value=ContainerHandsOn-PrivateSecurityGroup}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
    &#34;Tags&#34;: [
        {
            &#34;Key&#34;: &#34;Name&#34;,
            &#34;Value&#34;: &#34;ContainerHandsOn-PrivateSecurityGroup&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PublicSunetのSecurityGroupsIdの取得</h2>
<p>・IDを取得し、変数に格納・確認を行います</p>
<pre><code language="language-CloudShell" class="language-CloudShell">PrivateSecurityGroupsId=`aws ec2 describe-security-groups \
  --query &#39;SecurityGroups[*].GroupId&#39; \
  --filters &#34;Name=tag-key,Values=Name&#34; \
    &#34;Name=tag-value,Values=ContainerHandsOn-PrivateSecurityGroup&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 123456789012
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
PublicSecurityGroupsId : sg-01cc901415c240504
PrivateSecurityGroupsId : sg-040aff209e1fe59cc
</code></pre>
<h2 is-upgraded>■PublicSubnetのインバウンドルールを追加</h2>
<p>・InternetからのHTTPでのアクセスを許可します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PublicSecurityGroupsId} \
    --protocol tcp \
    --port 80 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-011c9bf434c9439a0&#34;,
            &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;,
            &#34;GroupOwnerId&#34;: &#34;123456789012&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 80,
            &#34;ToPort&#34;: 80,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PrivateSubnetのインバウンドルールを追加１</h2>
<p>・PublicSubnet経由でのHTTPでのアクセスを許可します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PrivateSecurityGroupsId} \
    --protocol tcp \
    --port 80 \
    --source-group ${PublicSecurityGroupsId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0eca9b6518889b4ca&#34;,
            &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
            &#34;GroupOwnerId&#34;: &#34;123456789012&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 80,
            &#34;ToPort&#34;: 80,
            &#34;ReferencedGroupInfo&#34;: {
                &#34;GroupId&#34;: &#34;sg-01cc901415c240504&#34;
            }
        }
    ]
}
</code></pre>
<h2 is-upgraded>■PrivateSubnetのインバウンドルールを追加２</h2>
<p>・後で設定するVPCエンドポイントの為にHTTPSアクセスを許可します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 authorize-security-group-ingress \
    --group-id ${PrivateSecurityGroupsId} \
    --protocol tcp \
    --port 443 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0d637ce636f2f14d9&#34;,
            &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;,
            &#34;GroupOwnerId&#34;: &#34;123456789012&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 443,
            &#34;ToPort&#34;: 443,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■CloudWatch LogGroupの作成</h2>
<p class="image-container"><img alt="img" src="img/eba6aa195fae755d.png"></p>
<p>・ecsTaskExecutionRoleがLogGroupを作成できないので、手作成します。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws logs create-log-group --log-group-name awslogs-container-hands-on
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h2 is-upgraded>■CloudWatch LogGroupの作成確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws logs describe-log-groups --log-group-name-prefix awslogs-container-hands-on
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;logGroups&#34;: [
        {
            &#34;logGroupName&#34;: &#34;awslogs-container-hands-on&#34;,
            &#34;creationTime&#34;: 1662547861755,
            &#34;metricFilterCount&#34;: 0,
            &#34;arn&#34;: &#34;arn:aws:logs:ap-northeast-1:378647896848:log-group:awslogs-container-hands-on:*&#34;,
            &#34;storedBytes&#34;: 0
        }
    ]
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Cloud9作成" duration="5">
        <h2 is-upgraded>■Cloud9の作成</h2>
<p class="image-container"><img alt="img" src="img/6312f100725debe3.png"></p>
<p>・コードを記述、実行、デバッグできるクラウドベースの統合開発環境 (IDE)であるCloud9を作成</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws cloud9 create-environment-ec2 \
  --name ContainerHandsOn \
  --description &#34;ContainerHandsOn&#34; \
  --instance-type t3.small  \
  --subnet-id ${SubnetId1aPublic}  \
  --automatic-stop-time-minutes 60 
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;environmentId&#34;: &#34;aa2999a731eb4178aed99069f1b683aa&#34;
}
</code></pre>
<h2 is-upgraded>■Cloud9環境Roleを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;ec2.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ContainerHandsOnForCloud9 \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h2 is-upgraded>■Cloud9環境RoleにPolicy追加</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws iam attach-role-policy \
  --role-name ContainerHandsOnForCloud9 \
  --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws iam list-attached-role-policies \
  --role-name ContainerHandsOnForCloud9
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;AttachedPolicies&#34;: [
        {
            &#34;PolicyName&#34;: &#34;AdministratorAccess&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AdministratorAccess&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■instance-profileを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws iam create-instance-profile \
    --instance-profile-name ContainerHandsOnForCloud9
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;InstanceProfile&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;InstanceProfileName&#34;: &#34;ContainerHandsOnForCloud9&#34;,
        &#34;InstanceProfileId&#34;: &#34;AIPASHENIAIFABKPZHZ6B&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:instance-profile/ContainerHandsOnForCloud9&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-11T20:08:39+00:00&#34;,
        &#34;Roles&#34;: []
    }
}
</code></pre>
<h2 is-upgraded>■instance-profileにRole付与</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws iam add-role-to-instance-profile \
    --role-name ContainerHandsOnForCloud9 \
    --instance-profile-name ContainerHandsOnForCloud9
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">（なし）
</code></pre>
<h2 is-upgraded>■Cloud9のInstanceIdの取得</h2>
<p>・IDを取得し、変数に格納・確認を行います</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">InstanceId=`aws ec2 describe-instances \
    --query &#34;Reservations[*].Instances[*].InstanceId&#34; \
    --filters &#34;Name=vpc-id,Values=${VpcId}&#34; \
    --output text`
</code></pre>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">AccoutID : 152767562250
VpcId : vpc-0eb621c4712ee0898
SubnetId1aPublic : subnet-035db89cb1df815f1
SubnetId1cPublic : subnet-04872b3467ca94ce2
SubnetId1aPrivate : subnet-00d678e2982d487d0
SubnetId1cPrivate : subnet-08bfff9af19697ab7
InternetGatewayId : igw-0d4373c922961e230
RouteTableIdPublic : rtb-0670248bec99ef90c
RouteTableIdPrivate : rtb-004eba1faed81d581
PublicSecurityGroupsId : sg-06931dc309a0879b2
PrivateSecurityGroupsId : sg-05eb336035d38f645
InstanceId : i-04c7c620fef60c9cb
</code></pre>
<h2 is-upgraded>■Cloud9環境RoleをAttach</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">aws ec2 associate-iam-instance-profile \
    --instance-id ${InstanceId} \
    --iam-instance-profile Name=ContainerHandsOnForCloud9
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">{
    &#34;IamInstanceProfileAssociation&#34;: {
        &#34;AssociationId&#34;: &#34;iip-assoc-060b8208bb529670a&#34;,
        &#34;InstanceId&#34;: &#34;i-033ba336e274d34f3&#34;,
        &#34;IamInstanceProfile&#34;: {
            &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:instance-profile/ContainerHandsOnForCloud9&#34;,
            &#34;Id&#34;: &#34;AIPASHENIAIFABKPZHZ6B&#34;
        },
        &#34;State&#34;: &#34;associating&#34;
    }
}
</code></pre>
<h2 is-upgraded>■環境変数をメモ</h2>
<p>・Cloud9で使うため、取得した変数をエディターに残して下さい</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">clear; cat &lt;&lt; EOF
export AccoutID=&#34;${AccoutID}&#34;
export VpcId=&#34;${VpcId}&#34;
export SubnetId1aPublic=&#34;${SubnetId1aPublic}&#34;
export SubnetId1cPublic=&#34;${SubnetId1cPublic}&#34;
export SubnetId1aPrivate=&#34;${SubnetId1aPrivate}&#34;
export SubnetId1cPrivate=&#34;${SubnetId1cPrivate}&#34;
export InternetGatewayId=&#34;${InternetGatewayId}&#34;
export RouteTableIdPublic=&#34;${RouteTableIdPublic}&#34;
export RouteTableIdPrivate=&#34;${RouteTableIdPrivate}&#34;
export PublicSecurityGroupsId=&#34;${PublicSecurityGroupsId}&#34;
export PrivateSecurityGroupsId=&#34;${PrivateSecurityGroupsId}&#34;
export InstanceId=&#34;${InstanceId}&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-CloudShell" class="language-CloudShell">export AccoutID=&#34;123456789012&#34;
export VpcId=&#34;vpc-0d3c1c88db46cfba7&#34;
export SubnetId1aPublic=&#34;subnet-0f66f257f167a1d47&#34;
export SubnetId1cPublic=&#34;subnet-0a1e2afffc8c140d8&#34;
export SubnetId1aPrivate=&#34;subnet-049f0119237ff00a0&#34;
export SubnetId1cPrivate=&#34;subnet-0ea89b6bc85e0ec61&#34;
export InternetGatewayId=&#34;igw-0a511ba68ceb84ed8&#34;
export RouteTableIdPublic=&#34;rtb-00cf30796b25b9bc9&#34;
export RouteTableIdPrivate=&#34;rtb-0afaac377925bca9a&#34;
export PublicSecurityGroupsId=&#34;sg-01cc901415c240504&#34;
export PrivateSecurityGroupsId=&#34;sg-040aff209e1fe59cc&#34;
export InstanceId=&#34;i-04c7c620fef60c9cb&#34;
</code></pre>
<h2 is-upgraded>■AWS コンソールでCloud9を起動</h2>
<ul>
<li>上部の検索バーで<code>Cloud9</code>と検索</li>
<li><code>AWS Cloud9 &gt; Your environments</code>に<code>ContainerHandsOn</code>が作成されているので<code>Open IDE</code>ボタン押下</li>
<li>Cloud9の画面が表示される</li>
</ul>
<p>・今後のcmdはCloud9のbashと書かれたTABの下に貼り付けていきます <a href="./image/img4-1.png" target="_blank"><img alt="img" src="img/ccb3ac339b93cb8e.png"></a></p>
<p>・間違えてTABを閉じてしまった場合には以下で新しくTABを開いてください <a href="./image/img4-2.png" target="_blank"><img alt="img" src="img/944649a354b83dff.png"></a></p>
<h2 is-upgraded>■Cloud9でCredentialsを切り替え</h2>
<ul>
<li>画面右上の歯車マークをクリックし、Preferencesを開く</li>
<li>Preferences &gt; AWS Settings &gt; Credentials と画面遷移をする</li>
<li>Credentialsをオフにする</li>
</ul>
<p><a href="./image/img4-3.png" target="_blank"><img alt="img" src="img/d2d391502c16e5d6.png"></a></p>


      </google-codelab-step>
    
      <google-codelab-step label="ECR作成" duration="5">
        <h2 is-upgraded>■環境変数を貼り付け</h2>
<p>・CloudShellで取得した環境変数をCloud9へ移設</p>
<h3 is-upgraded>cmd (以下はサンプルです、エディターに退避した結果を利用ください)</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export AccoutID=&#34;123456789012&#34;
export VpcId=&#34;vpc-0d3c1c88db46cfba7&#34;
export SubnetId1aPublic=&#34;subnet-0f66f257f167a1d47&#34;
export SubnetId1cPublic=&#34;subnet-0a1e2afffc8c140d8&#34;
export SubnetId1aPrivate=&#34;subnet-049f0119237ff00a0&#34;
export SubnetId1cPrivate=&#34;subnet-0ea89b6bc85e0ec61&#34;
export InternetGatewayId=&#34;igw-0a511ba68ceb84ed8&#34;
export RouteTableIdPublic=&#34;rtb-00cf30796b25b9bc9&#34;
export RouteTableIdPrivate=&#34;rtb-0afaac377925bca9a&#34;
export PublicSecurityGroupsId=&#34;sg-01cc901415c240504&#34;
export PrivateSecurityGroupsId=&#34;sg-040aff209e1fe59cc&#34;
export InstanceId=&#34;i-04c7c620fef60c9cb&#34;
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 123456789012
VpcId : vpc-0d3c1c88db46cfba7
SubnetId1aPublic : subnet-0f66f257f167a1d47
SubnetId1cPublic : subnet-0a1e2afffc8c140d8
SubnetId1aPrivate : subnet-049f0119237ff00a0
SubnetId1cPrivate : subnet-0ea89b6bc85e0ec61
InternetGatewayId : igw-0a511ba68ceb84ed8
RouteTableIdPublic : rtb-00cf30796b25b9bc9
RouteTableIdPrivate : rtb-0afaac377925bca9a
PublicSecurityGroupsId : sg-01cc901415c240504
PrivateSecurityGroupsId : sg-040aff209e1fe59cc
</code></pre>
<h2 is-upgraded>■AWS CLI・gitの環境設定実施</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export AWS_DEFAULT_REGION=ap-northeast-1
export AWS_DEFAULT_OUTPUT=json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■ECRの作成</h2>
<p class="image-container"><img alt="img" src="img/a54cbd1e2479d680.png"></p>
<p>・コンテナイメージのレジストリであるECRを作成</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr create-repository \
    --repository-name jaws-days-2022/container-hands-on \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;repository&#34;: {
        &#34;repositoryArn&#34;: &#34;arn:aws:ecr:ap-northeast-1:123456789012:repository/jaws-days-2022/container-hands-on&#34;,
        &#34;registryId&#34;: &#34;123456789012&#34;,
        &#34;repositoryName&#34;: &#34;jaws-days-2022/container-hands-on&#34;,
        &#34;repositoryUri&#34;: &#34;123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on&#34;,
        &#34;createdAt&#34;: &#34;2022-09-06T13:21:42+00:00&#34;,
        &#34;imageTagMutability&#34;: &#34;MUTABLE&#34;,
        &#34;imageScanningConfiguration&#34;: {
            &#34;scanOnPush&#34;: false
        },
        &#34;encryptionConfiguration&#34;: {
            &#34;encryptionType&#34;: &#34;AES256&#34;
        }
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Docker Image作成" duration="5">
        <h2 is-upgraded>■Cloud9上にdockerセットアップされていることを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker -v
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Docker version 20.10.13, build a224086
</code></pre>
<h2 is-upgraded>■Cloud9上にDockerfileを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; Dockerfile
FROM php:7.4.0-apache
COPY src/ /var/www/html/
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">mkdir src
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; ./src/index.php
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;ja&#34;&gt;
  &lt;head&gt;
    &lt;title&gt;Hello! Jaws Days 2022!!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Hello! Jaws Days 2022!!&lt;/p&gt;
    &lt;?php echo gethostname(); ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">ls -l ./Dockerfile ./src/index.php
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">-rw-rw-r-- 1 ec2-user ec2-user  47 Sep  6 13:26 ./Dockerfile
-rw-rw-r-- 1 ec2-user ec2-user 190 Sep  6 13:26 ./src/index.php
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker build \
  -t jaws-days-2022/container-hands-on .
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Sending build context to Docker daemon  9.823MB
Step 1/2 : FROM php:7.4.0-apache
7.4.0-apache: Pulling from library/php
000eee12ec04: Pull complete 
8ae4f9fcfeea: Pull complete 
60f22fbbd07a: Pull complete 
ccc7a63ad75f: Pull complete 
a2427b8dd6e7: Pull complete 
91cac3b30184: Pull complete 
d6e40015fc10: Pull complete 
9858aa646efe: Pull complete 
7940985f7eb2: Pull complete 
b23f72eebcfb: Pull complete 
75bb7b8d192c: Pull complete 
7edf943992b0: Pull complete 
c8bf9d9d0e11: Pull complete 
Digest: sha256:686af696a87d3836c694380588368ff4e7ad3e30f1faef387c545890b340edee
Status: Downloaded newer image for php:7.4.0-apache
 ---&gt; bf262c8621c1
Step 2/2 : COPY src/ /var/www/html/
 ---&gt; afc680b711d3
Successfully built afc680b711d3
Successfully tagged jaws-days-2022/container-hands-on:latest
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを構築されたことを確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-cloud9" class="language-cloud9">docker images \
  --filter reference= jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-cloud9" class="language-cloud9">REPOSITORY                          TAG       IMAGE ID       CREATED          SIZE
jaws-days-2022/container-hands-on   latest    98c14fa37bab   10 seconds ago   414MB
</code></pre>
<h2 is-upgraded>■Cloud9上でDocker イメージを起動</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker run \
  --name container-hands-on \
  -d -p 8080:80 jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">dcaf3423f6abeea3a67bab0c01a33e7b9d2c97131c8b304900f0455ee73da7b7
</code></pre>
<h3 is-upgraded>画面</h3>
<ul>
<li>Cloud9のヘッダ部分の<code>Preview</code>-&gt; <code>Preview Runnnig Application</code>のボタン押下<br></li>
<li><code>Hello! Jaws Days 2022!!</code>と記載された画面が表示されること<br></li>
</ul>
<p class="image-container"><img alt="img" src="img/2be66bb659acb02.png"></p>
<aside class="special"><p>何か間違ってコンテナを止めたい場合には以下を実行ください</p>
</aside>
<pre><code language="language-Cloud9" class="language-Cloud9">docker stop $(docker ps -q)
docker rm $(docker ps -q -a)
</code></pre>
<h2 is-upgraded>■DockerImageにTag付けを行う</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker tag \
  jaws-days-2022/container-hands-on:latest `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■DockerImageにTag付けの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker images \
  --filter reference=`echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest

</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">REPOSITORY                                                                            TAG       IMAGE ID       CREATED          SIZE
123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on   latest    98c14fa37bab   10 minutes ago   414MB
</code></pre>
<h2 is-upgraded>■認証トークンを取得し、レジストリに対して Docker クライアントを認証します</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecr get-login-password \
  --region ap-northeast-1 | \
  docker login \
  --username AWS \
  --password-stdin `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">WARNING! Your password will be stored unencrypted in /home/ec2-user/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
</code></pre>
<h2 is-upgraded>■DockerImageをECRにPush</h2>
<p class="image-container"><img alt="img" src="img/504dfce3257ecb8.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">docker push \
  `echo ${AccoutID}`.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">The push refers to repository [123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on]
9f8ad0ecf420: Pushed 
536365481ed8: Pushed 
4b3693c51878: Pushed 
677c3ce9f0b4: Pushed 
c08f4d9c281b: Pushed 
ed13170590f7: Pushed 
37cbdda31557: Pushed 
9691e5d7a4c7: Pushed 
6a4d393f0795: Pushed 
e38834ac7561: Pushed 
ec64f555d498: Pushed 
840f3f414cf6: Pushed 
17fce12edef0: Pushed 
831c5620387f: Pushed 
latest: digest: sha256:1fb5a3ac5ea1e7d60c24f371564a8c2c7bbc8072be0e80a3c53c30e1cae3ffd3 size: 3242
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="VPCエンドポイント作成" duration="5">
        <p>FargateをPrivateSubnetで稼働させるため、以下VPCエンドポイントを準備します<br> ECRに格納されたイメージを取得するためには通常Internet経由となります、しかし今回はFargateはPrivateSubnetというInternetに接続されていないので、Internet経由ではECRにアクセスできません<br> これを解決するためにVPCエンドポイントというInternetに繋がらないAWSのネットワーク経由でECRにアクセスを行います。</p>
<ul>
<li>com.amazonaws.ap-northeast-1.s3</li>
<li>com.amazonaws.ap-northeast-1.ecr.dkr</li>
<li>com.amazonaws.ap-northeast-1.ecr.api</li>
<li>com.amazonaws.ap-northeast-1.logs</li>
</ul>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.s3</h2>
<p class="image-container"><img alt="img" src="img/f515a098a3ca490d.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Gateway \
    --service-name com.amazonaws.ap-northeast-1.s3 \
    --route-table-ids ${RouteTableIdPrivate} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;PolicyDocument&#34;: &#34;{\&#34;Version\&#34;:\&#34;2008-10-17\&#34;,\&#34;Statement\&#34;:[{\&#34;Effect\&#34;:\&#34;Allow\&#34;,\&#34;Principal\&#34;:\&#34;*\&#34;,\&#34;Action\&#34;:\&#34;*\&#34;,\&#34;Resource\&#34;:\&#34;*\&#34;}]}&#34;, 
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
        &#34;Tags&#34;: [
            {
                &#34;Value&#34;: &#34;ContainerHands&#34;, 
                &#34;Key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;NetworkInterfaceIds&#34;: [], 
        &#34;SubnetIds&#34;: [], 
        &#34;RequesterManaged&#34;: false, 
        &#34;PrivateDnsEnabled&#34;: false, 
        &#34;State&#34;: &#34;available&#34;, 
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.s3&#34;, 
        &#34;RouteTableIds&#34;: [
            &#34;rtb-0afaac377925bca9a&#34;
        ], 
        &#34;Groups&#34;: [], 
        &#34;OwnerId&#34;: &#34;123456789012&#34;, 
        &#34;VpcEndpointId&#34;: &#34;vpce-035934e1a19b46f78&#34;, 
        &#34;VpcEndpointType&#34;: &#34;Gateway&#34;, 
        &#34;CreationTimestamp&#34;: &#34;2022-09-06T14:14:54.000Z&#34;, 
        &#34;DnsEntries&#34;: []
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.dkr</h2>
<p class="image-container"><img alt="img" src="img/87982f70217b1f13.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.dkr \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
        &#34;Tags&#34;: [
            {
                &#34;Value&#34;: &#34;ContainerHands&#34;, 
                &#34;Key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-09e0a49241653c549&#34;, 
            &#34;eni-05e27340a7008c6c5&#34;
        ], 
        &#34;SubnetIds&#34;: [
            &#34;subnet-0ea89b6bc85e0ec61&#34;, 
            &#34;subnet-049f0119237ff00a0&#34;
        ], 
        &#34;RequesterManaged&#34;: false, 
        &#34;PrivateDnsEnabled&#34;: true, 
        &#34;State&#34;: &#34;pending&#34;, 
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.ecr.dkr&#34;, 
        &#34;RouteTableIds&#34;: [], 
        &#34;Groups&#34;: [
            {
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;, 
                &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;
            }
        ], 
        &#34;OwnerId&#34;: &#34;123456789012&#34;, 
        &#34;VpcEndpointId&#34;: &#34;vpce-0dceb08e8bffc9a0c&#34;, 
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;, 
        &#34;CreationTimestamp&#34;: &#34;2022-09-06T14:15:53.158Z&#34;, 
        &#34;DnsEntries&#34;: [
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0dceb08e8bffc9a0c-nuehayud.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0dceb08e8bffc9a0c-nuehayud-ap-northeast-1a.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0dceb08e8bffc9a0c-nuehayud-ap-northeast-1c.dkr.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;, 
                &#34;DnsName&#34;: &#34;dkr.ecr.ap-northeast-1.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;, 
                &#34;DnsName&#34;: &#34;*.dkr.ecr.ap-northeast-1.amazonaws.com&#34;
            }
        ]
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.ecr.api</h2>
<p class="image-container"><img alt="img" src="img/ac4f870d288d455c.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.ecr.api \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
        &#34;Tags&#34;: [
            {
                &#34;Value&#34;: &#34;ContainerHands&#34;, 
                &#34;Key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-084e01fac365b44eb&#34;, 
            &#34;eni-0f8846781b4fb82ee&#34;
        ], 
        &#34;SubnetIds&#34;: [
            &#34;subnet-0ea89b6bc85e0ec61&#34;, 
            &#34;subnet-049f0119237ff00a0&#34;
        ], 
        &#34;RequesterManaged&#34;: false, 
        &#34;PrivateDnsEnabled&#34;: true, 
        &#34;State&#34;: &#34;pending&#34;, 
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.ecr.api&#34;, 
        &#34;RouteTableIds&#34;: [], 
        &#34;Groups&#34;: [
            {
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;, 
                &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;
            }
        ], 
        &#34;OwnerId&#34;: &#34;123456789012&#34;, 
        &#34;VpcEndpointId&#34;: &#34;vpce-0e45e7f04848a0600&#34;, 
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;, 
        &#34;CreationTimestamp&#34;: &#34;2022-09-06T14:16:25.698Z&#34;, 
        &#34;DnsEntries&#34;: [
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0e45e7f04848a0600-kef4k347.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0e45e7f04848a0600-kef4k347-ap-northeast-1c.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-0e45e7f04848a0600-kef4k347-ap-northeast-1a.api.ecr.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;, 
                &#34;DnsName&#34;: &#34;api.ecr.ap-northeast-1.amazonaws.com&#34;
            }
        ]
    }
}
</code></pre>
<h2 is-upgraded>■com.amazonaws.ap-northeast-1.logs</h2>
<p class="image-container"><img alt="img" src="img/73734ade64ba36f.png"></p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 create-vpc-endpoint \
    --vpc-id ${VpcId} \
    --vpc-endpoint-type Interface \
    --service-name com.amazonaws.ap-northeast-1.logs \
    --subnet-ids ${SubnetId1aPrivate} ${SubnetId1cPrivate} \
    --security-group-id ${PrivateSecurityGroupsId} \
    --tag-specifications &#34;ResourceType=vpc-endpoint,Tags=[{Key=Name,Value=ContainerHands}]&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;VpcEndpoint&#34;: {
        &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
        &#34;Tags&#34;: [
            {
                &#34;Value&#34;: &#34;ContainerHands&#34;, 
                &#34;Key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;NetworkInterfaceIds&#34;: [
            &#34;eni-04b15926212e8ea31&#34;, 
            &#34;eni-0514bbba136ec6108&#34;
        ], 
        &#34;SubnetIds&#34;: [
            &#34;subnet-0ea89b6bc85e0ec61&#34;, 
            &#34;subnet-049f0119237ff00a0&#34;
        ], 
        &#34;RequesterManaged&#34;: false, 
        &#34;PrivateDnsEnabled&#34;: true, 
        &#34;State&#34;: &#34;pending&#34;, 
        &#34;ServiceName&#34;: &#34;com.amazonaws.ap-northeast-1.logs&#34;, 
        &#34;RouteTableIds&#34;: [], 
        &#34;Groups&#34;: [
            {
                &#34;GroupName&#34;: &#34;PrivateSecurityGroup&#34;, 
                &#34;GroupId&#34;: &#34;sg-040aff209e1fe59cc&#34;
            }
        ], 
        &#34;OwnerId&#34;: &#34;123456789012&#34;, 
        &#34;VpcEndpointId&#34;: &#34;vpce-05ae88af55de2bf71&#34;, 
        &#34;VpcEndpointType&#34;: &#34;Interface&#34;, 
        &#34;CreationTimestamp&#34;: &#34;2022-09-06T14:16:50.374Z&#34;, 
        &#34;DnsEntries&#34;: [
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-05ae88af55de2bf71-5ltns582.logs.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-05ae88af55de2bf71-5ltns582-ap-northeast-1c.logs.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;Z2E726K9Y6RL4W&#34;, 
                &#34;DnsName&#34;: &#34;vpce-05ae88af55de2bf71-5ltns582-ap-northeast-1a.logs.ap-northeast-1.vpce.amazonaws.com&#34;
            }, 
            {
                &#34;HostedZoneId&#34;: &#34;ZONEIDPENDING&#34;, 
                &#34;DnsName&#34;: &#34;logs.ap-northeast-1.amazonaws.com&#34;
            }
        ]
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="ALB作成" duration="5">
        <h2 is-upgraded>■アプリケーションロードバランサーの作成</h2>
<p><img alt="img" src="img/6e9c557b86455601.png"> ・実行されるコンテナのタスクを複数立てた場合に、処理を振り分けるようにアプリケーションロードバランサーを作成します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-load-balancer \
    --name ContainerHandsOn \
    --subnets ${SubnetId1aPublic} ${SubnetId1cPublic} \
    --security-groups ${PublicSecurityGroupsId} \
    --tags &#34;Key=Name,Value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;LoadBalancers&#34;: [
        {
            &#34;IpAddressType&#34;: &#34;ipv4&#34;, 
            &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;, 
            &#34;LoadBalancerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/75145ed42d9a3867&#34;, 
            &#34;State&#34;: {
                &#34;Code&#34;: &#34;provisioning&#34;
            }, 
            &#34;DNSName&#34;: &#34;ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com&#34;, 
            &#34;SecurityGroups&#34;: [
                &#34;sg-08822a4834ed05f46&#34;
            ], 
            &#34;LoadBalancerName&#34;: &#34;ContainerHandsOn&#34;, 
            &#34;CreatedTime&#34;: &#34;2022-09-06T14:21:35.730Z&#34;, 
            &#34;Scheme&#34;: &#34;internet-facing&#34;, 
            &#34;Type&#34;: &#34;application&#34;, 
            &#34;CanonicalHostedZoneId&#34;: &#34;Z14GRHDCWA56QT&#34;, 
            &#34;AvailabilityZones&#34;: [
                {
                    &#34;SubnetId&#34;: &#34;subnet-0a1e2afffc8c140d8&#34;, 
                    &#34;LoadBalancerAddresses&#34;: [], 
                    &#34;ZoneName&#34;: &#34;ap-northeast-1c&#34;
                }, 
                {
                    &#34;SubnetId&#34;: &#34;subnet-0f66f257f167a1d47&#34;, 
                    &#34;LoadBalancerAddresses&#34;: [], 
                    &#34;ZoneName&#34;: &#34;ap-northeast-1a&#34;
                }
            ]
        }
    ]
}
</code></pre>
<h2 is-upgraded>■ターゲットグループの作成</h2>
<p>・タスクはどのようなプロトコルで稼働するターゲットであるか定義します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-target-group \
    --name ContainerHandsOn \
    --protocol HTTP \
    --port 80 \
    --target-type ip \
    --health-check-protocol HTTP \
    --health-check-port traffic-port \
    --health-check-path /index.php \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;TargetGroups&#34;: [
        {
            &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/7624dfd8f556a2d9&#34;,
            &#34;TargetGroupName&#34;: &#34;ContainerHandsOn&#34;,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;Port&#34;: 80,
            &#34;VpcId&#34;: &#34;vpc-0d3c1c88db46cfba7&#34;,
            &#34;HealthCheckProtocol&#34;: &#34;HTTP&#34;,
            &#34;HealthCheckPort&#34;: &#34;traffic-port&#34;,
            &#34;HealthCheckEnabled&#34;: true,
            &#34;HealthCheckIntervalSeconds&#34;: 30,
            &#34;HealthCheckTimeoutSeconds&#34;: 5,
            &#34;HealthyThresholdCount&#34;: 5,
            &#34;UnhealthyThresholdCount&#34;: 2,
            &#34;HealthCheckPath&#34;: &#34;/index.php&#34;,
            &#34;Matcher&#34;: {
                &#34;HttpCode&#34;: &#34;200&#34;
            },
            &#34;TargetType&#34;: &#34;ip&#34;,
            &#34;ProtocolVersion&#34;: &#34;HTTP1&#34;,
            &#34;IpAddressType&#34;: &#34;ipv4&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■アプリケーションロードバランサーのDNS取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">LoadBalancersDnsName=`aws elbv2 describe-load-balancers \
  --names ContainerHandsOn \
  --query &#34;LoadBalancers[*].DNSName&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 123456789012
VpcId : vpc-0320e7bf74af8bd72
SubnetId1aPublic : subnet-059ff12a72e014ca1
SubnetId1cPublic : subnet-0076bf4756ca680d1
SubnetId1aPrivate : subnet-000d7e1758777eb85
SubnetId1cPrivate : subnet-04ec5cc1209d3c566
InternetGatewayId : igw-015b39463b346214a
RouteTableIdPublic : rtb-00a15f36fcbabe379
RouteTableIdPrivate : rtb-086e760ddf493b0c3
PublicSecurityGroupsId : sg-04a6d799d221392dc
PrivateSecurityGroupsId : sg-0ce0e72015ca72d09
LoadBalancersDnsName : ContainerHandsOn-1258418044.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h2 is-upgraded>■アプリケーションロードバランサーのARN取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">LoadBalancerArn=`aws elbv2 describe-load-balancers \
  --names ContainerHandsOn \
  --query &#34;LoadBalancers[*].LoadBalancerArn&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 123456789012
VpcId : vpc-0320e7bf74af8bd72
SubnetId1aPublic : subnet-059ff12a72e014ca1
SubnetId1cPublic : subnet-0076bf4756ca680d1
SubnetId1aPrivate : subnet-000d7e1758777eb85
SubnetId1cPrivate : subnet-04ec5cc1209d3c566
InternetGatewayId : igw-015b39463b346214a
RouteTableIdPublic : rtb-00a15f36fcbabe379
RouteTableIdPrivate : rtb-086e760ddf493b0c3
PublicSecurityGroupsId : sg-04a6d799d221392dc
PrivateSecurityGroupsId : sg-0ce0e72015ca72d09
LoadBalancersDnsName : ContainerHandsOn-1258418044.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/09fd839792d722ff
</code></pre>
<h2 is-upgraded>■ターゲットグループのARN取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">TargetGroupArn=`aws elbv2 describe-target-groups \
  --names ContainerHandsOn \
  --query &#34;TargetGroups[*].TargetGroupArn&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 123456789012
VpcId : vpc-0320e7bf74af8bd72
SubnetId1aPublic : subnet-059ff12a72e014ca1
SubnetId1cPublic : subnet-0076bf4756ca680d1
SubnetId1aPrivate : subnet-000d7e1758777eb85
SubnetId1cPrivate : subnet-04ec5cc1209d3c566
InternetGatewayId : igw-015b39463b346214a
RouteTableIdPublic : rtb-00a15f36fcbabe379
RouteTableIdPrivate : rtb-086e760ddf493b0c3
PublicSecurityGroupsId : sg-04a6d799d221392dc
PrivateSecurityGroupsId : sg-0ce0e72015ca72d09
LoadBalancersDnsName : ContainerHandsOn-1258418044.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/09fd839792d722ff
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/d6ccd892547e534d
</code></pre>
<h2 is-upgraded>■リスナーの追加</h2>
<p>・アプリケーションロードバランサーとターゲットグループを紐付けします</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-listener \
    --load-balancer-arn ${LoadBalancerArn} \
    --protocol HTTP \
    --port 80 \
    --default-actions Type=forward,TargetGroupArn=${TargetGroupArn}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Listeners&#34;: [
        {
            &#34;ListenerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/75145ed42d9a3867/1245c4be3b3230b7&#34;,
            &#34;LoadBalancerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/75145ed42d9a3867&#34;,
            &#34;Port&#34;: 80,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;DefaultActions&#34;: [
                {
                    &#34;Type&#34;: &#34;forward&#34;,
                    &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/7f11fa9e9d635ce9&#34;,
                    &#34;ForwardConfig&#34;: {
                        &#34;TargetGroups&#34;: [
                            {
                                &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/7f11fa9e9d635ce9&#34;,
                                &#34;Weight&#34;: 1
                            }
                        ],
                        &#34;TargetGroupStickinessConfig&#34;: {
                            &#34;Enabled&#34;: false
                        }
                    }
                }
            ]
        }
    ]
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Fargate作成" duration="5">
        <h2 is-upgraded>■ECS/Fargate周辺の説明</h2>
<h3 is-upgraded>参考</h3>
<p><a href="https://www.slideshare.net/AmazonWebServicesJapan/20190731-black-belt-online-seminar-amazon-ecs-deep-dive-162160987" target="_blank">20190731 Black Belt Online Seminar Amazon ECS Deep Dive</a></p>
<h3 is-upgraded>ECS on EC2の構成図</h3>
<p class="image-container"><img alt="img" src="img/f1a8c502f37f27d.png"></p>
<ul>
<li>EC2上で稼働するTaskでコンテナが処理されます</li>
<li>EC2を複数個まとめてクラスターとして扱います</li>
<li>クラスター管理をし、どのEC2へ新規タスクを設けるかはECSの役目です</li>
</ul>
<h3 is-upgraded>ECS on Fargateの構成図</h3>
<p class="image-container"><img alt="img" src="img/7c6d141c13fa6ae9.png"></p>
<ul>
<li>しかし僕らが注力したいのはコンテナでどのような処理が稼働するかです</li>
<li>EC2の管理はやりたくないので、そこをマネージドしてくれるのがFargate</li>
</ul>
<h3 is-upgraded>ECSの主要要素</h3>
<p class="image-container"><img alt="img" src="img/907d8c5dea096b30.png"></p>
<ul>
<li>クラスター：実行環境の境界線</li>
<li>サービス：タスクを維持する機能</li>
<li>タスク：タスク定義に記載された内容を実行するコンテナ群</li>
<li>タスク定義：CPU/メモリ、稼働するコンテナイメージ等、何を稼働させるのかの定義</li>
</ul>
<h2 is-upgraded>■クラスターの作成</h2>
<p class="image-container"><img alt="img" src="img/768424469d8b3069.png"></p>
<p>・クラスターという実行環境の境界線を作成します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs create-cluster \
    --cluster-name ContainerHandsOn \
    --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;cluster&#34;: {
        &#34;status&#34;: &#34;ACTIVE&#34;, 
        &#34;defaultCapacityProviderStrategy&#34;: [], 
        &#34;statistics&#34;: [], 
        &#34;capacityProviders&#34;: [], 
        &#34;tags&#34;: [
            {
                &#34;value&#34;: &#34;ContainerHandsOn&#34;, 
                &#34;key&#34;: &#34;Name&#34;
            }
        ], 
        &#34;clusterName&#34;: &#34;ContainerHandsOn&#34;, 
        &#34;settings&#34;: [
            {
                &#34;name&#34;: &#34;containerInsights&#34;, 
                &#34;value&#34;: &#34;disabled&#34;
            }
        ], 
        &#34;registeredContainerInstancesCount&#34;: 0, 
        &#34;pendingTasksCount&#34;: 0, 
        &#34;runningTasksCount&#34;: 0, 
        &#34;activeServicesCount&#34;: 0, 
        &#34;clusterArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:cluster/ContainerHandsOn&#34;
    }
}
</code></pre>
<h2 is-upgraded>■タスク定義の作成</h2>
<p class="image-container"><img alt="img" src="img/828f2c1b1932ca79.png"></p>
<p>・どのようなタスクが稼働するかを定義します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; register-task-definition.json
{
    &#34;family&#34;: &#34;ContainerHandsOn&#34;, 
    &#34;executionRoleArn&#34;: &#34;arn:aws:iam::${AccoutID}:role/ecsTaskExecutionRole&#34;, 
    &#34;networkMode&#34;: &#34;awsvpc&#34;, 
    &#34;containerDefinitions&#34;: [
        {
            &#34;name&#34;: &#34;ContainerHandsOn&#34;, 
            &#34;image&#34;: &#34;${AccoutID}.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;, 
            &#34;portMappings&#34;: [
                {
                    &#34;containerPort&#34;: 80, 
                    &#34;hostPort&#34;: 80, 
                    &#34;protocol&#34;: &#34;tcp&#34;
                }
            ], 
            &#34;essential&#34;: true,
            &#34;logConfiguration&#34;: {
                &#34;logDriver&#34;: &#34;awslogs&#34;,
                &#34;options&#34;: {
                    &#34;awslogs-create-group&#34;: &#34;true&#34;,
                    &#34;awslogs-group&#34;: &#34;awslogs-container-hands-on&#34;,
                    &#34;awslogs-region&#34;: &#34;ap-northeast-1&#34;,
                    &#34;awslogs-stream-prefix&#34;: &#34;hands-on&#34;
                }
            }
        }
    ], 
    &#34;requiresCompatibilities&#34;: [
        &#34;FARGATE&#34;
    ], 
    &#34;cpu&#34;: &#34;256&#34;, 
    &#34;memory&#34;: &#34;512&#34;,
    &#34;runtimePlatform&#34;: {
        &#34;cpuArchitecture&#34;: &#34;X86_64&#34;,
        &#34;operatingSystemFamily&#34;: &#34;LINUX&#34;
    }
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs register-task-definition \
  --cli-input-json file://register-task-definition.json \
  --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;taskDefinition&#34;: {
        &#34;taskDefinitionArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:task-definition/ContainerHandsOn:1&#34;,
        &#34;containerDefinitions&#34;: [
            {
                &#34;name&#34;: &#34;ContainerHandsOn&#34;,
                &#34;image&#34;: &#34;123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;,
                &#34;cpu&#34;: 0,
                &#34;portMappings&#34;: [
                    {
                        &#34;containerPort&#34;: 80,
                        &#34;hostPort&#34;: 80,
                        &#34;protocol&#34;: &#34;tcp&#34;
                    }
                ],
                &#34;essential&#34;: true,
                &#34;environment&#34;: [],
                &#34;mountPoints&#34;: [],
                &#34;volumesFrom&#34;: []
            }
        ],
        &#34;family&#34;: &#34;ContainerHandsOn&#34;,
        &#34;executionRoleArn&#34;: &#34;arn:aws:iam::123456789012:role/ecsTaskExecutionRole&#34;,
        &#34;networkMode&#34;: &#34;awsvpc&#34;,
        &#34;revision&#34;: 1,
        &#34;volumes&#34;: [],
        &#34;status&#34;: &#34;ACTIVE&#34;,
        &#34;requiresAttributes&#34;: [
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.ecr-auth&#34;
            },
            {
                &#34;name&#34;: &#34;ecs.capability.execution-role-ecr-pull&#34;
            },
            {
                &#34;name&#34;: &#34;com.amazonaws.ecs.capability.docker-remote-api.1.18&#34;
            },
            {
                &#34;name&#34;: &#34;ecs.capability.task-eni&#34;
            }
        ],
        &#34;placementConstraints&#34;: [],
        &#34;compatibilities&#34;: [
            &#34;EC2&#34;,
            &#34;FARGATE&#34;
        ],
        &#34;runtimePlatform&#34;: {
            &#34;cpuArchitecture&#34;: &#34;X86_64&#34;,
            &#34;operatingSystemFamily&#34;: &#34;LINUX&#34;
        },
        &#34;requiresCompatibilities&#34;: [
            &#34;FARGATE&#34;
        ],
        &#34;cpu&#34;: &#34;256&#34;,
        &#34;memory&#34;: &#34;512&#34;,
        &#34;registeredAt&#34;: &#34;2022-09-06T14:59:53.594000+00:00&#34;,
        &#34;registeredBy&#34;: &#34;arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_AWSAdministratorAccess_8fe206b83490a022/ShigeruOda&#34;
    },
    &#34;tags&#34;: [
        {
            &#34;key&#34;: &#34;Name&#34;,
            &#34;value&#34;: &#34;ContainerHandsOn&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■タスク定義のリビジョン取得</h2>
<p>・タスク定義は作成する度にカウントアップされるので、最新のリビジョン番号を取得します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">RevisionNo=`aws ecs list-task-definitions \
  --family-prefix ContainerHandsOn \
  --status ACTIVE \
  --sort ASC | \
  grep ContainerHandsOn | tail -1 | sed -e &#39;s/&#34;//g&#39; | cut -f 7 --delim=&#34;:&#34;`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
RevisionNo : ${RevisionNo}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 123456789012
VpcId : vpc-0320e7bf74af8bd72
SubnetId1aPublic : subnet-059ff12a72e014ca1
SubnetId1cPublic : subnet-0076bf4756ca680d1
SubnetId1aPrivate : subnet-000d7e1758777eb85
SubnetId1cPrivate : subnet-04ec5cc1209d3c566
InternetGatewayId : igw-015b39463b346214a
RouteTableIdPublic : rtb-00a15f36fcbabe379
RouteTableIdPrivate : rtb-086e760ddf493b0c3
PublicSecurityGroupsId : sg-04a6d799d221392dc
PrivateSecurityGroupsId : sg-0ce0e72015ca72d09
LoadBalancersDnsName : ContainerHandsOn-1258418044.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/09fd839792d722ff
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/d6ccd892547e534d
RevisionNo : 2
</code></pre>
<h2 is-upgraded>■サービスの作成</h2>
<p class="image-container"><img alt="img" src="img/363edc2a84dccf6c.png"></p>
<p>・実行数やネットワーク周りをまとめます</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs create-service \
    --cluster ContainerHandsOn \
    --service-name ContainerHandsOn \
    --task-definition ContainerHandsOn:${RevisionNo} \
    --deployment-controller type=CODE_DEPLOY \
    --desired-count 2 \
    --launch-type FARGATE \
    --platform-version LATEST \
    --network-configuration &#34;awsvpcConfiguration={subnets=[${SubnetId1aPrivate},${SubnetId1cPrivate}],securityGroups=[${PrivateSecurityGroupsId}],assignPublicIp=DISABLED}&#34; \
    --load-balancers targetGroupArn=${TargetGroupArn},containerName=ContainerHandsOn,containerPort=80 
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;service&#34;: {
        &#34;serviceArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:service/ContainerHandsOn/ContainerHandsOn&#34;,
        &#34;serviceName&#34;: &#34;ContainerHandsOn&#34;,
        &#34;clusterArn&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:cluster/ContainerHandsOn&#34;,
        &#34;loadBalancers&#34;: [
            {
                &#34;targetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/7624dfd8f556a2d9&#34;,
                &#34;containerName&#34;: &#34;ContainerHandsOn&#34;,
                &#34;containerPort&#34;: 80
            }
        ],
        &#34;serviceRegistries&#34;: [],
        &#34;status&#34;: &#34;ACTIVE&#34;,
        &#34;desiredCount&#34;: 2,
        &#34;runningCount&#34;: 0,
        &#34;pendingCount&#34;: 0,
        &#34;launchType&#34;: &#34;FARGATE&#34;,
        &#34;platformVersion&#34;: &#34;LATEST&#34;,
        &#34;platformFamily&#34;: &#34;Linux&#34;,
        &#34;taskDefinition&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:task-definition/ContainerHandsOn:8&#34;,
        &#34;deploymentConfiguration&#34;: {
            &#34;deploymentCircuitBreaker&#34;: {
                &#34;enable&#34;: false,
                &#34;rollback&#34;: false
            },
            &#34;maximumPercent&#34;: 200,
            &#34;minimumHealthyPercent&#34;: 100
        },
        &#34;deployments&#34;: [
            {
                &#34;id&#34;: &#34;ecs-svc/9015413324295259653&#34;,
                &#34;status&#34;: &#34;PRIMARY&#34;,
                &#34;taskDefinition&#34;: &#34;arn:aws:ecs:ap-northeast-1:123456789012:task-definition/ContainerHandsOn:1&#34;,
                &#34;desiredCount&#34;: 2,
                &#34;pendingCount&#34;: 0,
                &#34;runningCount&#34;: 0,
                &#34;failedTasks&#34;: 0,
                &#34;createdAt&#34;: &#34;2022-09-07T02:14:18.688000+00:00&#34;,
                &#34;updatedAt&#34;: &#34;2022-09-07T02:14:18.688000+00:00&#34;,
                &#34;launchType&#34;: &#34;FARGATE&#34;,
                &#34;platformVersion&#34;: &#34;1.4.0&#34;,
                &#34;platformFamily&#34;: &#34;Linux&#34;,
                &#34;networkConfiguration&#34;: {
                    &#34;awsvpcConfiguration&#34;: {
                        &#34;subnets&#34;: [
                            &#34;subnet-0ea89b6bc85e0ec61&#34;,
                            &#34;subnet-049f0119237ff00a0&#34;
                        ],
                        &#34;securityGroups&#34;: [
                            &#34;sg-040aff209e1fe59cc&#34;
                        ],
                        &#34;assignPublicIp&#34;: &#34;DISABLED&#34;
                    }
                },
                &#34;rolloutState&#34;: &#34;IN_PROGRESS&#34;,
                &#34;rolloutStateReason&#34;: &#34;ECS deployment ecs-svc/9015413324295259653 in progress.&#34;
            }
        ],
        &#34;roleArn&#34;: &#34;arn:aws:iam::123456789012:role/aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS&#34;,
        &#34;events&#34;: [],
        &#34;createdAt&#34;: &#34;2022-09-07T02:14:18.688000+00:00&#34;,
        &#34;placementConstraints&#34;: [],
        &#34;placementStrategy&#34;: [],
        &#34;networkConfiguration&#34;: {
            &#34;awsvpcConfiguration&#34;: {
                &#34;subnets&#34;: [
                    &#34;subnet-0ea89b6bc85e0ec61&#34;,
                    &#34;subnet-049f0119237ff00a0&#34;
                ],
                &#34;securityGroups&#34;: [
                    &#34;sg-040aff209e1fe59cc&#34;
                ],
                &#34;assignPublicIp&#34;: &#34;DISABLED&#34;
            }
        },
        &#34;healthCheckGracePeriodSeconds&#34;: 0,
        &#34;schedulingStrategy&#34;: &#34;REPLICA&#34;,
        &#34;createdBy&#34;: &#34;arn:aws:iam::123456789012:role/aws-reserved/sso.amazonaws.com/ap-northeast-1/AWSReservedSSO_AWSAdministratorAccess_8fe206b83490a022&#34;,
        &#34;enableECSManagedTags&#34;: false,
        &#34;propagateTags&#34;: &#34;NONE&#34;,
        &#34;enableExecuteCommand&#34;: false
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="動作確認１" duration="5">
        <h2 is-upgraded>■アドレス確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h2 is-upgraded>■画面確認</h2>
<p class="image-container"><img alt="img" src="img/67e8b6b5866fd0ca.png"></p>
<ul>
<li>503エラーの場合には1分程度待って、リトライをお願いします</li>
<li>上記で取得されたアドレスをChromeなどのブラウザに貼り付け、以下のような表示になること</li>
<li>更新を行うと2行目のhostnameが変更されていること（ALBで負荷分散されている確認）</li>
</ul>
<h2 is-upgraded>■表示結果例</h2>
<h3 is-upgraded>パターン例１</h3>
<p class="image-container"><img alt="img" src="img/ca2bd0552b74670.png"></p>
<h3 is-upgraded>パターン例２</h3>
<p class="image-container"><img alt="img" src="img/b321ec2d09376beb.png"></p>
<h2 is-upgraded>■CloudWatch Logsの確認</h2>
<ul>
<li>上部の検索バーで<code>CloudWatch</code>と検索</li>
<li>CloudWatch &gt; ロググループ &gt; awslogs-container-hands-on &gt; 2つのログストリームを確認</li>
<li>&#34;ロードバランサーのアクセスログ&#34; と &#34;ブラウザアクセスログ&#34;をそれぞれのログストリームで確認</li>
</ul>
<h3 is-upgraded>ログストリームを確認</h3>
<p class="image-container"><img alt="img" src="img/575c856891b5b153.png"></p>
<h3 is-upgraded>ロードバランサーアクセスログを確認</h3>
<pre><code language="language-CloudWatch" class="language-CloudWatch">10.0.0.102 - - [09/Sep/2022:03:09:33 +0000] \
&#34;GET /index.php HTTP/1.1&#34; 200 403 &#34;-&#34; &#34;ELB-HealthChecker/2.0&#34;
</code></pre>
<h3 is-upgraded>ブラウザアクセスログを確認</h3>
<pre><code language="language-CloudWatch" class="language-CloudWatch">10.0.0.102 - - [09/Sep/2022:03:10:00 +0000] \
&#34;GET / HTTP/1.1&#34; 200 384 &#34;-&#34; &#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="変数整理" duration="0">
        <h2 is-upgraded>■ここまで取得された変数を整理</h2>
<p>・後続のため、取得した変数をエディターに残して下さい</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
export AccoutID=&#34;${AccoutID}&#34;
export VpcId=&#34;${VpcId}&#34;
export SubnetId1aPublic=&#34;${SubnetId1aPublic}&#34;
export SubnetId1cPublic=&#34;${SubnetId1cPublic}&#34;
export SubnetId1aPrivate=&#34;${SubnetId1aPrivate}&#34;
export SubnetId1cPrivate=&#34;${SubnetId1cPrivate}&#34;
export InternetGatewayId=&#34;${InternetGatewayId}&#34;
export RouteTableIdPublic=&#34;${RouteTableIdPublic}&#34;
export RouteTableIdPrivate=&#34;${RouteTableIdPrivate}&#34;
export PublicSecurityGroupsId=&#34;${PublicSecurityGroupsId}&#34;
export PrivateSecurityGroupsId=&#34;${PrivateSecurityGroupsId}&#34;
export InstanceId=&#34;${InstanceId}&#34;
export LoadBalancerArn=&#34;${LoadBalancerArn}&#34;
export TargetGroupArn=&#34;${TargetGroupArn}&#34;
export LoadBalancersDnsName=&#34;${LoadBalancersDnsName}&#34;
export RevisionNo=&#34;${RevisionNo}&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">export AccoutID=&#34;152767562250&#34;
export VpcId=&#34;vpc-0eb621c4712ee0898&#34;
export SubnetId1aPublic=&#34;subnet-035db89cb1df815f1&#34;
export SubnetId1cPublic=&#34;subnet-04872b3467ca94ce2&#34;
export SubnetId1aPrivate=&#34;subnet-00d678e2982d487d0&#34;
export SubnetId1cPrivate=&#34;subnet-08bfff9af19697ab7&#34;
export InternetGatewayId=&#34;igw-0d4373c922961e230&#34;
export RouteTableIdPublic=&#34;rtb-0670248bec99ef90c&#34;
export RouteTableIdPrivate=&#34;rtb-004eba1faed81d581&#34;
export PublicSecurityGroupsId=&#34;sg-06931dc309a0879b2&#34;
export PrivateSecurityGroupsId=&#34;sg-05eb336035d38f645&#34;
export InstanceId=&#34;i-04c7c620fef60c9cb&#34;
export LoadBalancerArn=&#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:loadbalancer/app/ContainerHandsOn/9f7c6d0c3b1b76da&#34;
export TargetGroupArn=&#34;arn:aws:elasticloadbalancing:ap-northeast-1:152767562250:targetgroup/ContainerHandsOn/f46da45550c208d5&#34;
export LoadBalancersDnsName=&#34;ContainerHandsOn-879378718.ap-northeast-1.elb.amazonaws.com&#34;
export RevisionNo=&#34;6&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodeCommit作成" duration="5">
        <h2 is-upgraded>■CodeCommitの作成</h2>
<p>・git互換のソースリポジトリであるCodeCommitを作成</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws codecommit create-repository \
  --repository-name ContainerHandsOn \
  --repository-description &#34;ContainerHandsOn&#34; \
  --tags &#34;key=Name,value=ContainerHandsOn&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;repositoryMetadata&#34;: {
        &#34;accountId&#34;: &#34;378647896848&#34;,
        &#34;repositoryId&#34;: &#34;b4e47286-11a4-4280-9760-8c8103a5ace7&#34;,
        &#34;repositoryName&#34;: &#34;ContainerHandsOn&#34;,
        &#34;repositoryDescription&#34;: &#34;ContainerHandsOn&#34;,
        &#34;lastModifiedDate&#34;: 1662705554.252,
        &#34;creationDate&#34;: 1662705554.252,
        &#34;cloneUrlHttp&#34;: &#34;https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn&#34;,
        &#34;cloneUrlSsh&#34;: &#34;ssh://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn&#34;,
        &#34;Arn&#34;: &#34;arn:aws:codecommit:ap-northeast-1:378647896848:ContainerHandsOn&#34;
    }
}
</code></pre>
<h2 is-upgraded>■CodeCommitリポジトリのクローン</h2>
<p>・git cloneでリポジトリをcloneします、中身は空です</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/
git clone https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">Cloning into &#39;ContainerHandsOn&#39;...
warning: You appear to have cloned an empty repository.
</code></pre>
<h2 is-upgraded>■資材の準備</h2>
<p>・事前に作成した資材をgit管理ディレクトリにcopyします</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ContainerHandsOn
cp -p ../Dockerfile ./
cp -pr ../src ./
ls -lR
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">.:
total 8
-rw-rw-r-- 1 ec2-user ec2-user   47 Sep  9 01:31 Dockerfile
drwxrwxr-x 2 ec2-user ec2-user 4096 Sep  9 01:32 src

./src:
total 4
-rw-rw-r-- 1 ec2-user ec2-user 190 Sep  9 01:32 index.php
</code></pre>
<h2 is-upgraded>■buildspec.ymlの新規作成</h2>
<p>・CodeBuildの仕様を記述したファイルを作成します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; buildspec.yml
version: 0.2
phases:
  install:
    runtime-versions:
        docker: 20
        
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - docker version
      - aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin ${AccoutID}.dkr.ecr.ap-northeast-1.amazonaws.com
      - RepositoryUri=${AccoutID}.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on
      - ImageTag=\$(echo \$CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)

  build:
    commands:
      - echo Build started on \`date\`
      - echo Building the Docker image...          
      - docker build -t jaws-days-2022/container-hands-on .
      - docker tag jaws-days-2022/container-hands-on:latest \${RepositoryUri}:latest
      - docker tag jaws-days-2022/container-hands-on:latest \${RepositoryUri}:\${ImageTag}
      - printf &#39;{&#34;Version&#34;:&#34;1.0&#34;,&#34;ImageURI&#34;:&#34;%s&#34;}&#39; \${RepositoryUri}:\${ImageTag} &gt; imageDetail.json

  post_build:
    commands:
      - echo Build completed on \`date\`
      - echo Pushing the Docker image...
      - docker push \${RepositoryUri}:latest
      - docker push \${RepositoryUri}:\${ImageTag}

artifacts:
  files: imageDetail.json
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■buildspec.ymlの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">ls -l buildspec.yml
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">-rw-rw-r-- 1 ec2-user ec2-user 1192 Sep 11 04:59 buildspec.yml
</code></pre>
<h2 is-upgraded>■appspec.ymlの新規作成</h2>
<p>・CodeDeployの仕様を記述したファイルを作成します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; appspec.yml
version: 0.0
Resources:
  - TargetService:
      Type: AWS::ECS::Service
      Properties:
        TaskDefinition: &#34;&lt;TASK_DEFINITION&gt;&#34;
        LoadBalancerInfo:
            ContainerName: &#34;ContainerHandsOn&#34; 
            ContainerPort: &#34;80&#34;
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■appspec.ymlの確認</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">ls -l appspec.yml
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">-rw-rw-r-- 1 ec2-user ec2-user 240 Sep 11 05:04 appspec.yml
</code></pre>
<h2 is-upgraded>■taskdef.jsonの新規作成</h2>
<p>・ECS Taskの仕様を記述したファイルを作成します<br> ・前半のハンズオンで作成した内容を出力しています</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ecs describe-task-definition \
  --task-definition ContainerHandsOn:${RevisionNo} \
  --query taskDefinition &gt; taskdef.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■taskdef.jsonの変更</h2>
<p>・Cloud9のエディター機能を使って、6行目を変更します<br> ・変更後、Ctrl+Sでの保存をお忘れなく<br> ・sedでやりたい・・・</p>
<h3 is-upgraded>変更前</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">&#34;image&#34;: &#34;123456789012.dkr.ecr.ap-northeast-1.amazonaws.com/jaws-days-2022/container-hands-on:latest&#34;,
</code></pre>
<h3 is-upgraded>変更前</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">&#34;image&#34;: &#34;&lt;IMAGE_NAME&gt;&#34;,
</code></pre>
<h2 is-upgraded>■CodeCommitへのPush</h2>
<p>・作成したファイルをCodeCommitへPushし格納します</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">git config --global user.name &#34;Your Name&#34;
git config --global user.email you@example.com

git add -A
git commit -m &#34;first commit&#34;
git push origin master
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">[master (root-commit) 091ba9a] first commit
 5 files changed, 131 insertions(+)
 create mode 100644 Dockerfile
 create mode 100644 appspec.yml
 create mode 100644 buildspec.yml
 create mode 100644 src/index.php
 create mode 100644 taskdef.json

Enumerating objects: 8, done.
Counting objects: 100% (8/8), done.
Delta compression using up to 2 threads
Compressing objects: 100% (6/6), done.
Writing objects: 100% (8/8), 1.96 KiB | 1.96 MiB/s, done.
Total 8 (delta 0), reused 0 (delta 0), pack-reused 0
To https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn
 * [new branch]      master -&gt; master
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodeBuild作成" duration="5">
        <h2 is-upgraded>■CodeBuild用Role作成</h2>
<p>・CodeBuildのためにRoleを作成します。</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;codebuild.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ContainerHandsOnForCodeBuild \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForCodeBuild&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFMIBJGIWAY&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForCodeBuild&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-11T05:26:01Z&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;codebuild.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■CodeBuild用RoleにPolicyをアタッチ</h2>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeBuild \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeBuild \
  --policy-arn arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeBuild \
  --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam list-attached-role-policies \
  --role-name ContainerHandsOnForCodeBuild
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;AttachedPolicies&#34;: [
        {
            &#34;PolicyName&#34;: &#34;AmazonEC2ContainerRegistryPowerUser&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser&#34;
        },
        {
            &#34;PolicyName&#34;: &#34;CloudWatchLogsFullAccess&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/CloudWatchLogsFullAccess&#34;
        },
        {
            &#34;PolicyName&#34;: &#34;AmazonS3FullAccess&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AmazonS3FullAccess&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■CodeBuild設定</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; codebuild-create-project.json
{
    &#34;name&#34;: &#34;ContainerHandsOn&#34;,
    &#34;source&#34;: {
        &#34;type&#34;: &#34;CODECOMMIT&#34;,
        &#34;location&#34;: &#34;https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn&#34;
    },
    &#34;sourceVersion&#34;: &#34;refs/heads/master&#34;,
    &#34;artifacts&#34;: {
        &#34;type&#34;: &#34;NO_ARTIFACTS&#34;
    },
    &#34;environment&#34;: {
        &#34;type&#34;: &#34;LINUX_CONTAINER&#34;,
        &#34;image&#34;: &#34;aws/codebuild/amazonlinux2-x86_64-standard:4.0&#34;,
        &#34;computeType&#34;: &#34;BUILD_GENERAL1_SMALL&#34;,
        &#34;privilegedMode&#34;: true
    },
    &#34;serviceRole&#34;: &#34;arn:aws:iam::${AccoutID}:role/ContainerHandsOnForCodeBuild&#34;
}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■CodeBuild作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws codebuild create-project \
  --cli-input-json file://codebuild-create-project.json \
  --tags key=Name,value=ContainerHandsOn
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;project&#34;: {
        &#34;name&#34;: &#34;ContainerHandsOn&#34;,
        &#34;arn&#34;: &#34;arn:aws:codebuild:ap-northeast-1:123456789012:project/ContainerHandsOn&#34;,
        &#34;source&#34;: {
            &#34;type&#34;: &#34;CODECOMMIT&#34;,
            &#34;location&#34;: &#34;https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn&#34;,
            &#34;insecureSsl&#34;: false
        },
        &#34;sourceVersion&#34;: &#34;refs/heads/master&#34;,
        &#34;artifacts&#34;: {
            &#34;type&#34;: &#34;NO_ARTIFACTS&#34;
        },
        &#34;cache&#34;: {
            &#34;type&#34;: &#34;NO_CACHE&#34;
        },
        &#34;environment&#34;: {
            &#34;type&#34;: &#34;LINUX_CONTAINER&#34;,
            &#34;image&#34;: &#34;aws/codebuild/amazonlinux2-x86_64-standard:4.0&#34;,
            &#34;computeType&#34;: &#34;BUILD_GENERAL1_SMALL&#34;,
            &#34;environmentVariables&#34;: [],
            &#34;privilegedMode&#34;: false,
            &#34;imagePullCredentialsType&#34;: &#34;CODEBUILD&#34;
        },
        &#34;serviceRole&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForCodeBuild&#34;,
        &#34;timeoutInMinutes&#34;: 60,
        &#34;queuedTimeoutInMinutes&#34;: 480,
        &#34;encryptionKey&#34;: &#34;arn:aws:kms:ap-northeast-1:123456789012:alias/aws/s3&#34;,
        &#34;tags&#34;: [
            {
                &#34;key&#34;: &#34;Name&#34;,
                &#34;value&#34;: &#34;ContainerHandsOn&#34;
            }
        ],
        &#34;created&#34;: 1662874335.259,
        &#34;lastModified&#34;: 1662874335.259,
        &#34;badge&#34;: {
            &#34;badgeEnabled&#34;: false
        },
        &#34;projectVisibility&#34;: &#34;PRIVATE&#34;
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodeDeploy作成" duration="5">
        <h2 is-upgraded>■CodeDeploy用Role作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;codedeploy.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ContainerHandsOnForCodeDeploy \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForCodeDeploy&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFMRHKSS3UR&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForCodeDeploy&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-11T06:39:05Z&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;codedeploy.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■CodeDeploy用RoleにPolicyをアタッチ</h2>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeDeploy \
  --policy-arn arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam attach-role-policy \
  --role-name ContainerHandsOnForCodeDeploy \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code>（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code>aws iam list-attached-role-policies \
  --role-name ContainerHandsOnForCodeDeploy
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;AttachedPolicies&#34;: [
        {
            &#34;PolicyName&#34;: &#34;AmazonEC2ContainerRegistryPowerUser&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser&#34;
        },
        {
            &#34;PolicyName&#34;: &#34;AWSCodeDeployRoleForECS&#34;,
            &#34;PolicyArn&#34;: &#34;arn:aws:iam::aws:policy/AWSCodeDeployRoleForECS&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■アプリケーションを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws deploy create-application \
  --application-name ContainerHandsOn \
  --compute-platform ECS \
  --tags Key=Name,Value=ContainerHandsOn
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;applicationId&#34;: &#34;84eb81cb-1e84-46cb-9209-c17334e7bc15&#34;
}
</code></pre>
<h2 is-upgraded>■ターゲットグループの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-target-group \
    --name ContainerHandsOn8080 \
    --protocol HTTP \
    --port 8080 \
    --target-type ip \
    --health-check-protocol HTTP \
    --health-check-port traffic-port \
    --health-check-path /index.php \
    --vpc-id ${VpcId}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;TargetGroups&#34;: [
        {
            &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/e27bdcbab658f9d4&#34;,
            &#34;TargetGroupName&#34;: &#34;ContainerHandsOn8080&#34;,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;Port&#34;: 8080,
            &#34;VpcId&#34;: &#34;vpc-0320e7bf74af8bd72&#34;,
            &#34;HealthCheckProtocol&#34;: &#34;HTTP&#34;,
            &#34;HealthCheckPort&#34;: &#34;traffic-port&#34;,
            &#34;HealthCheckEnabled&#34;: true,
            &#34;HealthCheckIntervalSeconds&#34;: 30,
            &#34;HealthCheckTimeoutSeconds&#34;: 5,
            &#34;HealthyThresholdCount&#34;: 5,
            &#34;UnhealthyThresholdCount&#34;: 2,
            &#34;HealthCheckPath&#34;: &#34;/index.php&#34;,
            &#34;Matcher&#34;: {
                &#34;HttpCode&#34;: &#34;200&#34;
            },
            &#34;TargetType&#34;: &#34;ip&#34;,
            &#34;ProtocolVersion&#34;: &#34;HTTP1&#34;,
            &#34;IpAddressType&#34;: &#34;ipv4&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■ターゲットグループのARN取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">TargetGroupArn8080=`aws elbv2 describe-target-groups \
  --names ContainerHandsOn8080 \
  --query &#34;TargetGroups[*].TargetGroupArn&#34; \
  --output text`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
RevisionNo : ${RevisionNo}
TargetGroupArn8080 : ${TargetGroupArn8080}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 123456789012
VpcId : vpc-0320e7bf74af8bd72
SubnetId1aPublic : subnet-059ff12a72e014ca1
SubnetId1cPublic : subnet-0076bf4756ca680d1
SubnetId1aPrivate : subnet-000d7e1758777eb85
SubnetId1cPrivate : subnet-04ec5cc1209d3c566
InternetGatewayId : igw-015b39463b346214a
RouteTableIdPublic : rtb-00a15f36fcbabe379
RouteTableIdPrivate : rtb-086e760ddf493b0c3
PublicSecurityGroupsId : sg-04a6d799d221392dc
PrivateSecurityGroupsId : sg-0ce0e72015ca72d09
LoadBalancersDnsName : ContainerHandsOn-1258418044.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/09fd839792d722ff
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/d6ccd892547e534d
RevisionNo : 2
TargetGroupArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/e27bdcbab658f9d4
</code></pre>
<h2 is-upgraded>■リスナーの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws elbv2 create-listener \
    --load-balancer-arn ${LoadBalancerArn} \
    --protocol HTTP \
    --port 8080 \
    --default-actions Type=forward,TargetGroupArn=${TargetGroupArn8080}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Listeners&#34;: [
        {
            &#34;ListenerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/09fd839792d722ff/c39cf5572d2a4854&#34;,
            &#34;LoadBalancerArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/09fd839792d722ff&#34;,
            &#34;Port&#34;: 8080,
            &#34;Protocol&#34;: &#34;HTTP&#34;,
            &#34;DefaultActions&#34;: [
                {
                    &#34;Type&#34;: &#34;forward&#34;,
                    &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/e27bdcbab658f9d4&#34;,
                    &#34;ForwardConfig&#34;: {
                        &#34;TargetGroups&#34;: [
                            {
                                &#34;TargetGroupArn&#34;: &#34;arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/e27bdcbab658f9d4&#34;,
                                &#34;Weight&#34;: 1
                            }
                        ],
                        &#34;TargetGroupStickinessConfig&#34;: {
                            &#34;Enabled&#34;: false
                        }
                    }
                }
            ]
        }
    ]
}
</code></pre>
<h2 is-upgraded>■リスナーのARN取得</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">ListenerArn=`aws elbv2 describe-listeners \
    --load-balancer-arn ${LoadBalancerArn} \
    --query &#34;Listeners[*].[Port,ListenerArn]&#34; \
    --output text | grep &#34;^80\s&#34; | cut -f 2`
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">ListenerArn8080=`aws elbv2 describe-listeners \
    --load-balancer-arn ${LoadBalancerArn} \
    --query &#34;Listeners[*].[Port,ListenerArn]&#34; \
    --output text | grep &#34;^8080&#34; | cut -f 2`
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
RevisionNo : ${RevisionNo}
TargetGroupArn8080 : ${TargetGroupArn8080}
ListenerArn : ${ListenerArn}
ListenerArn8080 : ${ListenerArn8080}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 123456789012
VpcId : vpc-0320e7bf74af8bd72
SubnetId1aPublic : subnet-059ff12a72e014ca1
SubnetId1cPublic : subnet-0076bf4756ca680d1
SubnetId1aPrivate : subnet-000d7e1758777eb85
SubnetId1cPrivate : subnet-04ec5cc1209d3c566
InternetGatewayId : igw-015b39463b346214a
RouteTableIdPublic : rtb-00a15f36fcbabe379
RouteTableIdPrivate : rtb-086e760ddf493b0c3
PublicSecurityGroupsId : sg-04a6d799d221392dc
PrivateSecurityGroupsId : sg-0ce0e72015ca72d09
LoadBalancersDnsName : ContainerHandsOn-1258418044.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/09fd839792d722ff
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/d6ccd892547e534d
RevisionNo : 2
TargetGroupArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/e27bdcbab658f9d4
ListenerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/09fd839792d722ff/06feb1b2e81f0f88
ListenerArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/09fd839792d722ff/c39cf5572d2a4854
</code></pre>
<h2 is-upgraded>■PublicSubnetのインバウンドルールを追加</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws ec2 authorize-security-group-ingress \
    --group-id ${PublicSecurityGroupsId} \
    --protocol tcp \
    --port 8080 \
    --cidr 0.0.0.0/0
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Return&#34;: true,
    &#34;SecurityGroupRules&#34;: [
        {
            &#34;SecurityGroupRuleId&#34;: &#34;sgr-0d94c6066ce720a52&#34;,
            &#34;GroupId&#34;: &#34;sg-04a6d799d221392dc&#34;,
            &#34;GroupOwnerId&#34;: &#34;123456789012&#34;,
            &#34;IsEgress&#34;: false,
            &#34;IpProtocol&#34;: &#34;tcp&#34;,
            &#34;FromPort&#34;: 8080,
            &#34;ToPort&#34;: 8080,
            &#34;CidrIpv4&#34;: &#34;0.0.0.0/0&#34;
        }
    ]
}
</code></pre>
<h2 is-upgraded>■デプロイグループの作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; create-deployment-group.json
{
    &#34;applicationName&#34;: &#34;ContainerHandsOn&#34;,
    &#34;deploymentGroupName&#34;: &#34;ContainerHandsOn&#34;,
    &#34;deploymentConfigName&#34;: &#34;CodeDeployDefault.ECSAllAtOnce&#34;,
    &#34;serviceRoleArn&#34;: &#34;arn:aws:iam::${AccoutID}:role/ContainerHandsOnForCodeDeploy&#34;,
    &#34;deploymentStyle&#34;: {
        &#34;deploymentType&#34;: &#34;BLUE_GREEN&#34;,
        &#34;deploymentOption&#34;: &#34;WITH_TRAFFIC_CONTROL&#34;
    },
    &#34;blueGreenDeploymentConfiguration&#34;: {
        &#34;terminateBlueInstancesOnDeploymentSuccess&#34;: {
            &#34;action&#34;: &#34;TERMINATE&#34;,
            &#34;terminationWaitTimeInMinutes&#34;: 5
        },
        &#34;deploymentReadyOption&#34;: {
            &#34;actionOnTimeout&#34;: &#34;STOP_DEPLOYMENT&#34;,
            &#34;waitTimeInMinutes&#34;: 5
        }
    },
    &#34;loadBalancerInfo&#34;: {
        &#34;targetGroupPairInfoList&#34;: [
            {
                &#34;targetGroups&#34;: [
                    {
                        &#34;name&#34;: &#34;ContainerHandsOn&#34;
                    },
                    {
                        &#34;name&#34;: &#34;ContainerHandsOn8080&#34;
                    }
                ],
                &#34;prodTrafficRoute&#34;: {
                    &#34;listenerArns&#34;: [
                        &#34;${ListenerArn}&#34;
                    ]
                },
                &#34;testTrafficRoute&#34;: {
                    &#34;listenerArns&#34;: [
                        &#34;${ListenerArn8080}&#34;
                    ]
                }
            }
        ]
    },
    &#34;ecsServices&#34;: [
        {
            &#34;serviceName&#34;: &#34;ContainerHandsOn&#34;,
            &#34;clusterName&#34;: &#34;ContainerHandsOn&#34;
        }
    ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws deploy create-deployment-group \
  --cli-input-json file://create-deployment-group.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;deploymentGroupId&#34;: &#34;66c261d6-481c-411c-a450-408e4582d3a3&#34;
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="CodePipeline作成" duration="5">
        <h2 is-upgraded>■CodePipeline用Role作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
  &#34;Version&#34;: &#34;2012-10-17&#34;,
  &#34;Statement&#34;: [
    {
      &#34;Sid&#34;: &#34;&#34;,
      &#34;Effect&#34;: &#34;Allow&#34;,
      &#34;Principal&#34;: {
        &#34;Service&#34;: &#34;codepipeline.amazonaws.com&#34;
      },
      &#34;Action&#34;: &#34;sts:AssumeRole&#34;
    }
  ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam create-role \
  --role-name ContainerHandsOnForPipeLine \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForPipeLine&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFE3VFSOI5C&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForPipeLine&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-11T07:29:04Z&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Sid&#34;: &#34;&#34;,
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;codepipeline.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■CodePipeline用RoleにPolicyをアタッチ</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; InlinePolicy.json
{
    &#34;Statement&#34;: [
        {
            &#34;Action&#34;: [
                &#34;iam:PassRole&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Condition&#34;: {
                &#34;StringEqualsIfExists&#34;: {
                    &#34;iam:PassedToService&#34;: [
                        &#34;cloudformation.amazonaws.com&#34;,
                        &#34;elasticbeanstalk.amazonaws.com&#34;,
                        &#34;ec2.amazonaws.com&#34;,
                        &#34;ecs-tasks.amazonaws.com&#34;
                    ]
                }
            }
        },
        {
            &#34;Action&#34;: [
                &#34;codecommit:CancelUploadArchive&#34;,
                &#34;codecommit:GetBranch&#34;,
                &#34;codecommit:GetCommit&#34;,
                &#34;codecommit:GetRepository&#34;,
                &#34;codecommit:GetUploadArchiveStatus&#34;,
                &#34;codecommit:UploadArchive&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;codedeploy:CreateDeployment&#34;,
                &#34;codedeploy:GetApplication&#34;,
                &#34;codedeploy:GetApplicationRevision&#34;,
                &#34;codedeploy:GetDeployment&#34;,
                &#34;codedeploy:GetDeploymentConfig&#34;,
                &#34;codedeploy:RegisterApplicationRevision&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;codestar-connections:UseConnection&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;elasticbeanstalk:*&#34;,
                &#34;ec2:*&#34;,
                &#34;elasticloadbalancing:*&#34;,
                &#34;autoscaling:*&#34;,
                &#34;cloudwatch:*&#34;,
                &#34;s3:*&#34;,
                &#34;sns:*&#34;,
                &#34;cloudformation:*&#34;,
                &#34;rds:*&#34;,
                &#34;sqs:*&#34;,
                &#34;ecs:*&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;lambda:InvokeFunction&#34;,
                &#34;lambda:ListFunctions&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;opsworks:CreateDeployment&#34;,
                &#34;opsworks:DescribeApps&#34;,
                &#34;opsworks:DescribeCommands&#34;,
                &#34;opsworks:DescribeDeployments&#34;,
                &#34;opsworks:DescribeInstances&#34;,
                &#34;opsworks:DescribeStacks&#34;,
                &#34;opsworks:UpdateApp&#34;,
                &#34;opsworks:UpdateStack&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;cloudformation:CreateStack&#34;,
                &#34;cloudformation:DeleteStack&#34;,
                &#34;cloudformation:DescribeStacks&#34;,
                &#34;cloudformation:UpdateStack&#34;,
                &#34;cloudformation:CreateChangeSet&#34;,
                &#34;cloudformation:DeleteChangeSet&#34;,
                &#34;cloudformation:DescribeChangeSet&#34;,
                &#34;cloudformation:ExecuteChangeSet&#34;,
                &#34;cloudformation:SetStackPolicy&#34;,
                &#34;cloudformation:ValidateTemplate&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Action&#34;: [
                &#34;codebuild:BatchGetBuilds&#34;,
                &#34;codebuild:StartBuild&#34;,
                &#34;codebuild:BatchGetBuildBatches&#34;,
                &#34;codebuild:StartBuildBatch&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;devicefarm:ListProjects&#34;,
                &#34;devicefarm:ListDevicePools&#34;,
                &#34;devicefarm:GetRun&#34;,
                &#34;devicefarm:GetUpload&#34;,
                &#34;devicefarm:CreateUpload&#34;,
                &#34;devicefarm:ScheduleRun&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;servicecatalog:ListProvisioningArtifacts&#34;,
                &#34;servicecatalog:CreateProvisioningArtifact&#34;,
                &#34;servicecatalog:DescribeProvisioningArtifact&#34;,
                &#34;servicecatalog:DeleteProvisioningArtifact&#34;,
                &#34;servicecatalog:UpdateProduct&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;cloudformation:ValidateTemplate&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;ecr:DescribeImages&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;states:DescribeExecution&#34;,
                &#34;states:DescribeStateMachine&#34;,
                &#34;states:StartExecution&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        },
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;appconfig:StartDeployment&#34;,
                &#34;appconfig:StopDeployment&#34;,
                &#34;appconfig:GetDeployment&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        }
    ],
    &#34;Version&#34;: &#34;2012-10-17&#34;
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam put-role-policy \
  --role-name ContainerHandsOnForPipeLine \
  --policy-name InlinePolicy \
  --policy-document file://InlinePolicy.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">（なし）
</code></pre>
<h2 is-upgraded>■S3 artifactStoreを作成</h2>
<h3 is-upgraded>cmd</h3>
<aside class="special"><p>あなたのフルネームを記載下さい、英語小文字でお願いします</p>
</aside>
<pre><code language="language-Cloud9" class="language-Cloud9">YourName=shigeru-oda
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">S3Name=${YourName}-container-handson-`date +&#34;%Y%m%d%H%M%S&#34;`
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">clear; cat &lt;&lt; EOF
AccoutID : ${AccoutID}
VpcId : ${VpcId}
SubnetId1aPublic : ${SubnetId1aPublic}
SubnetId1cPublic : ${SubnetId1cPublic}
SubnetId1aPrivate : ${SubnetId1aPrivate}
SubnetId1cPrivate : ${SubnetId1cPrivate}
InternetGatewayId : ${InternetGatewayId}
RouteTableIdPublic : ${RouteTableIdPublic}
RouteTableIdPrivate : ${RouteTableIdPrivate}
PublicSecurityGroupsId : ${PublicSecurityGroupsId}
PrivateSecurityGroupsId : ${PrivateSecurityGroupsId}
InstanceId : ${InstanceId}
LoadBalancersDnsName : ${LoadBalancersDnsName}
LoadBalancerArn : ${LoadBalancerArn}
TargetGroupArn : ${TargetGroupArn}
RevisionNo : ${RevisionNo}
TargetGroupArn8080 : ${TargetGroupArn8080}
ListenerArn : ${ListenerArn}
ListenerArn8080 : ${ListenerArn8080}
S3Name : ${S3Name}
EOF
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">AccoutID : 123456789012
VpcId : vpc-0320e7bf74af8bd72
SubnetId1aPublic : subnet-059ff12a72e014ca1
SubnetId1cPublic : subnet-0076bf4756ca680d1
SubnetId1aPrivate : subnet-000d7e1758777eb85
SubnetId1cPrivate : subnet-04ec5cc1209d3c566
InternetGatewayId : igw-015b39463b346214a
RouteTableIdPublic : rtb-00a15f36fcbabe379
RouteTableIdPrivate : rtb-086e760ddf493b0c3
PublicSecurityGroupsId : sg-04a6d799d221392dc
PrivateSecurityGroupsId : sg-0ce0e72015ca72d09
LoadBalancersDnsName : ContainerHandsOn-1258418044.ap-northeast-1.elb.amazonaws.com
LoadBalancerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:loadbalancer/app/ContainerHandsOn/09fd839792d722ff
TargetGroupArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn/d6ccd892547e534d
RevisionNo : 2
TargetGroupArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/ContainerHandsOn8080/e27bdcbab658f9d4
ListenerArn : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/09fd839792d722ff/06feb1b2e81f0f88
ListenerArn8080 : arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/ContainerHandsOn/09fd839792d722ff/c39cf5572d2a4854
S3Name : shigeru-oda-container-handson-20220911072649
</code></pre>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws s3 mb s3://${S3Name}
</code></pre>
<h2 is-upgraded>■CodePipelineを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; create-pipeline.json
{
    &#34;pipeline&#34;: {
        &#34;name&#34;: &#34;ContainerHandsOn&#34;,
        &#34;roleArn&#34;: &#34;arn:aws:iam::`echo ${AccoutID}`:role/ContainerHandsOnForPipeLine&#34;,
        &#34;artifactStore&#34;: {
            &#34;type&#34;: &#34;S3&#34;,
            &#34;location&#34;: &#34;`echo ${S3Name}`&#34;
        },
        &#34;stages&#34;: [
            {
                &#34;name&#34;: &#34;Source&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Source&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Source&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeCommit&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;BranchName&#34;: &#34;master&#34;,
                            &#34;OutputArtifactFormat&#34;: &#34;CODE_ZIP&#34;,
                            &#34;PollForSourceChanges&#34;: &#34;false&#34;,
                            &#34;RepositoryName&#34;: &#34;ContainerHandsOn&#34;
                        },
                        &#34;outputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;inputArtifacts&#34;: [],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;SourceVariables&#34;
                    }
                ]
            },
            {
                &#34;name&#34;: &#34;Build&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Build&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Build&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeBuild&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;ProjectName&#34;: &#34;ContainerHandsOn&#34;
                        },
                        &#34;outputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;BuildArtifact&#34;
                            }
                        ],
                        &#34;inputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;BuildVariables&#34;
                    }
                ]
            },
            {
                &#34;name&#34;: &#34;Deploy&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Deploy&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Deploy&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeDeployToECS&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;AppSpecTemplateArtifact&#34;: &#34;SourceArtifact&#34;,
                            &#34;ApplicationName&#34;: &#34;ContainerHandsOn&#34;,
                            &#34;DeploymentGroupName&#34;: &#34;ContainerHandsOn&#34;,
                            &#34;Image1ArtifactName&#34;: &#34;BuildArtifact&#34;,
                            &#34;Image1ContainerName&#34;: &#34;IMAGE_NAME&#34;,
                            &#34;TaskDefinitionTemplateArtifact&#34;: &#34;SourceArtifact&#34;
                        },
                        &#34;outputArtifacts&#34;: [],
                        &#34;inputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;BuildArtifact&#34;
                            },
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;DeployVariables&#34;
                    }
                ]
            }
        ],
        &#34;version&#34;: 1
    }
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws codepipeline create-pipeline --cli-input-json file://create-pipeline.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;pipeline&#34;: {
        &#34;name&#34;: &#34;ContainerHandsOn&#34;,
        &#34;roleArn&#34;: &#34;arn:aws:iam::123456789012:role/ContainerHandsOnForPipeLine&#34;,
        &#34;artifactStore&#34;: {
            &#34;type&#34;: &#34;S3&#34;,
            &#34;location&#34;: &#34;shigeru-oda-container-handson-20220911072649&#34;
        },
        &#34;stages&#34;: [
            {
                &#34;name&#34;: &#34;Source&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Source&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Source&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeCommit&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;BranchName&#34;: &#34;master&#34;,
                            &#34;OutputArtifactFormat&#34;: &#34;CODE_ZIP&#34;,
                            &#34;PollForSourceChanges&#34;: &#34;false&#34;,
                            &#34;RepositoryName&#34;: &#34;ContainerHandsOn&#34;
                        },
                        &#34;outputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;inputArtifacts&#34;: [],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;SourceVariables&#34;
                    }
                ]
            },
            {
                &#34;name&#34;: &#34;Build&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Build&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Build&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeBuild&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;ProjectName&#34;: &#34;ContainerHandsOn&#34;
                        },
                        &#34;outputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;BuildArtifact&#34;
                            }
                        ],
                        &#34;inputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;BuildVariables&#34;
                    }
                ]
            },
            {
                &#34;name&#34;: &#34;Deploy&#34;,
                &#34;actions&#34;: [
                    {
                        &#34;name&#34;: &#34;Deploy&#34;,
                        &#34;actionTypeId&#34;: {
                            &#34;category&#34;: &#34;Deploy&#34;,
                            &#34;owner&#34;: &#34;AWS&#34;,
                            &#34;provider&#34;: &#34;CodeDeployToECS&#34;,
                            &#34;version&#34;: &#34;1&#34;
                        },
                        &#34;runOrder&#34;: 1,
                        &#34;configuration&#34;: {
                            &#34;AppSpecTemplateArtifact&#34;: &#34;SourceArtifact&#34;,
                            &#34;ApplicationName&#34;: &#34;ContainerHandsOn&#34;,
                            &#34;DeploymentGroupName&#34;: &#34;ContainerHandsOn&#34;,
                            &#34;Image1ArtifactName&#34;: &#34;BuildArtifact&#34;,
                            &#34;Image1ContainerName&#34;: &#34;IMAGE_NAME&#34;,
                            &#34;TaskDefinitionTemplateArtifact&#34;: &#34;SourceArtifact&#34;
                        },
                        &#34;outputArtifacts&#34;: [],
                        &#34;inputArtifacts&#34;: [
                            {
                                &#34;name&#34;: &#34;BuildArtifact&#34;
                            },
                            {
                                &#34;name&#34;: &#34;SourceArtifact&#34;
                            }
                        ],
                        &#34;region&#34;: &#34;ap-northeast-1&#34;,
                        &#34;namespace&#34;: &#34;DeployVariables&#34;
                    }
                ]
            }
        ],
        &#34;version&#34;: 1
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="動作確認２−１（Blue/Green Deployの確認）" duration="5">
        <h2 is-upgraded>■AWS コンソールでCodePipelineを検索</h2>
<ul>
<li>上部の検索バーでCodePipelineと検索</li>
<li>パイプラインの画面が表示されるのでContainerHandsOnを選択</li>
<li>Source、Buildが「成功しました」と表示されるまで暫く待機</li>
<li>Deployが「進行中」になった段階で「詳細」ボタン押下 <img alt="img" src="img/46d94b4271bd7d0c.png"><img alt="img" src="img/5b09f59782be46ac.png"></li>
<li>Blue（オリジナル）にトラフィックが向いていることが確認できます。 <img alt="img" src="img/9486bc7742ede2a9.png"></li>
<li>上部の検索バーで「Elastic Container Service」と検索</li>
<li>クラスター一覧の画面が表示されるのでContainerHandsOnを選択</li>
<li>タスクタブを選択</li>
<li>リビジョンが異なる2 * 2のタスクが稼働していることが確認できます。 <img alt="img" src="img/c0bf88422d5581e3.png"></li>
<li>リビジョンが異なる2 * 2のタスクが稼働していることが確認できます。</li>
</ul>
<h2 is-upgraded>■アドレス確認 Blue（オリジナル）</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com
</code></pre>
<h3 is-upgraded>画面</h3>
<ul>
<li>上記で取得されたアドレスをChromeなどのブラウザに貼り付け、以下のような表示になること</li>
<li>ブラウザを更新すると２種類のタスクが確認できます</li>
<li>パターン１</li>
</ul>
<p class="image-container"><img alt="img" src="img/df5db472483e1c4d.png"></p>
<ul>
<li>パターン２</li>
</ul>
<p class="image-container"><img alt="img" src="img/72c2ec54b62ebef7.png"></p>
<h2 is-upgraded>■アドレス確認 Green（置換）</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">echo &#34;http://&#34;${LoadBalancersDnsName}:8080
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">http://ContainerHandsOn-610375823.ap-northeast-1.elb.amazonaws.com:8080
</code></pre>
<h3 is-upgraded>画面</h3>
<ul>
<li>上記で取得されたアドレスをChromeなどのブラウザに貼り付け、以下のような表示になること</li>
<li>ブラウザを更新すると先ほどとは異なる２種類のタスクが確認できます</li>
<li>パターン１</li>
</ul>
<p class="image-container"><img alt="img" src="img/18e082d29fb3baa3.png"></p>
<ul>
<li>パターン２</li>
</ul>
<p class="image-container"><img alt="img" src="img/b5ef7619890cf00b.png"></p>
<h2 is-upgraded>■Blue/Greenの置換</h2>
<h3 is-upgraded>画面</h3>
<ul>
<li>CodeDeployの画面に戻ります</li>
<li>「トラフィックの再ルーティング」ボタン押下</li>
</ul>
<p class="image-container"><img alt="img" src="img/c168b60387e8450.png"></p>
<ul>
<li>暫くするとトラフィックがGreen（置換）に切り替わっていることが確認できます。</li>
</ul>
<p class="image-container"><img alt="img" src="img/2fe296f45c6b9089.png"></p>
<h2 is-upgraded>■Blue/Greenの置換後</h2>
<h3 is-upgraded>画面</h3>
<ul>
<li>再度ECSの画面に戻るとタスクで古いリビジョンが削除されていることが確認できます。</li>
</ul>
<p class="image-container"><img alt="img" src="img/51cdbb130834c5f7.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="EventBridge作成" duration="5">
        <h2 is-upgraded>■EventBridge用Role作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; assume-role-policy-document.json
{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Principal&#34;: {
                &#34;Service&#34;: &#34;events.amazonaws.com&#34;
            },
            &#34;Action&#34;: &#34;sts:AssumeRole&#34;
        }
    ]
}
EOF
</code></pre>
<pre><code>aws iam create-role \
  --role-name ContainerHandsOnForEventBridge \
  --assume-role-policy-document file://assume-role-policy-document.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">xx{
    &#34;Role&#34;: {
        &#34;Path&#34;: &#34;/&#34;,
        &#34;RoleName&#34;: &#34;ContainerHandsOnForEventBridge&#34;,
        &#34;RoleId&#34;: &#34;AROASHENIAIFKIXIOXE3I&#34;,
        &#34;Arn&#34;: &#34;arn:aws:iam::152767562250:role/ContainerHandsOnForEventBridge&#34;,
        &#34;CreateDate&#34;: &#34;2022-09-13T05:32:16Z&#34;,
        &#34;AssumeRolePolicyDocument&#34;: {
            &#34;Version&#34;: &#34;2012-10-17&#34;,
            &#34;Statement&#34;: [
                {
                    &#34;Effect&#34;: &#34;Allow&#34;,
                    &#34;Principal&#34;: {
                        &#34;Service&#34;: &#34;events.amazonaws.com&#34;
                    },
                    &#34;Action&#34;: &#34;sts:AssumeRole&#34;
                }
            ]
        }
    }
}
</code></pre>
<h2 is-upgraded>■EventBridge用RoleにPolicyをアタッチ</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; InlinePolicy.json
{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;codepipeline:StartPipelineExecution&#34;
            ],
            &#34;Resource&#34;: [
                &#34;arn:aws:codepipeline:ap-northeast-1:${AccoutID}:*&#34;
            ]
        }
    ]
}
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">aws iam put-role-policy \
  --role-name ContainerHandsOnForEventBridge \
  --policy-name InlinePolicy \
  --policy-document file://InlinePolicy.json
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9"></code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="■EventBridgeを作成" duration="0">
        <h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws events put-rule \
  --name &#34;ContainerHandsOnForEventBridge&#34; \
  --state &#34;ENABLED&#34; \
  --description &#34;ContainerHandsOnForEventBridge&#34; \
  --event-bus-name &#34;default&#34; \
  --event-pattern &#34;{ \
    \&#34;source\&#34;:[\&#34;aws.codecommit\&#34;], \
    \&#34;detail-type\&#34;:[\&#34;CodeCommit Repository State Change\&#34;], \
    \&#34;resources\&#34;:[\&#34;arn:aws:codecommit:ap-northeast-1:${AccoutID}:ContainerHandsOn\&#34;], \
    \&#34;detail\&#34;:{ \
        \&#34;event\&#34;:[\&#34;referenceCreated\&#34;,\&#34;referenceUpdated\&#34;], \
        \&#34;referenceType\&#34;: [\&#34;branch\&#34;], \
        \&#34;referenceName\&#34;:[\&#34;master\&#34;] \
    } \
  }&#34; \
  --role-arn &#34;arn:aws:iam::${AccoutID}:role/ContainerHandsOnForEventBridge&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;RuleArn&#34;: &#34;arn:aws:events:ap-northeast-1:152767562250:rule/ContainerHandsOnForEventBridge&#34;
}
</code></pre>
<h2 is-upgraded>■targetを作成</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">aws events put-targets \
  --rule ContainerHandsOnForEventBridge \
  --targets &#34;Id&#34;=&#34;1&#34;,&#34;Arn&#34;=&#34;arn:aws:codepipeline:ap-northeast-1:${AccoutID}:ContainerHandsOn&#34;,&#34;RoleArn&#34;=&#34;arn:aws:iam::${AccoutID}:role/ContainerHandsOnForEventBridge&#34;
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">{
    &#34;FailedEntryCount&#34;: 0,
    &#34;FailedEntries&#34;: []
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="動作確認２−２（Codeシリーズを利用)）" duration="5">
        <h2 is-upgraded>■srcの変更</h2>
<p>・Cloud9上で「/home/ec2-user/environment/ContainerHandsOn/src/index.php」を変更する</p>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">cd ~/environment/ContainerHandsOn/src
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">cat &lt;&lt; EOF &gt; index.php
&lt;!DOCTYPE html&gt;
&lt;html lang=&#34;ja&#34;&gt;
  &lt;head&gt;
    &lt;title&gt;Hello! Jaws Days 2022!!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;Hello! Jaws Days 2022!!&lt;/p&gt;
    &lt;p&gt;CICD ContainerHandOn!!!&lt;/p&gt;
    &lt;?php echo gethostname(); ?&gt;
  &lt;/body&gt;
&lt;/html&gt;
EOF
</code></pre>
<pre><code language="language-Cloud9" class="language-Cloud9">git diff index.php
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">diff --git a/src/index.php b/src/index.php
index 3e2ebff..f6a5cd5 100644
--- a/src/index.php
+++ b/src/index.php
@@ -5,6 +5,7 @@
   &lt;/head&gt;
   &lt;body&gt;
     &lt;p&gt;Hello! Jaws Days 2022!!&lt;/p&gt;
+    &lt;p&gt;CICD ContainerHandOn!!!&lt;/p&gt;
     &lt;?php echo gethostname(); ?&gt;
   &lt;/body&gt;
 &lt;/html&gt;
</code></pre>
<h2 is-upgraded>■git操作</h2>
<h3 is-upgraded>cmd</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">git add ./index.php
git commit -m &#34;CICD TEST&#34;
git push
</code></pre>
<h3 is-upgraded>result</h3>
<pre><code language="language-Cloud9" class="language-Cloud9">[master 1f49fba] CICD TEST
 1 file changed, 1 insertion(+)


Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 2 threads
Compressing objects: 100% (3/3), done.
Writing objects: 100% (4/4), 361 bytes | 361.00 KiB/s, done.
Total 4 (delta 2), reused 0 (delta 0), pack-reused 0
To https://git-codecommit.ap-northeast-1.amazonaws.com/v1/repos/ContainerHandsOn
   dc004ac..1f49fba  master -&gt; master
</code></pre>
<h2 is-upgraded>■CodePipeline確認</h2>


      </google-codelab-step>
    
      <google-codelab-step label="片付け" duration="5">
        <h2 is-upgraded>■あああ</h2>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
